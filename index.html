<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Somnia Christmas ‚Äî Pacman</title>

<script src="libs/ethers.min.js"></script>

<style>
/* ---------------------------------------------------- */
/* --- PERBAIKAN CSS UNTUK VIEWPORT MOBILE & DAPPS --- */
/* ---------------------------------------------------- */

*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:Trebuchet MS,sans-serif;
}

/* Memastikan BODY menggunakan 100% tinggi viewport yang tersedia (penting untuk mobile DApps) */
body {
  height: 100vh;
  min-height: 100%; /* Fallback */
  background: linear-gradient(to right,#fff,#ff0000);
  color: #fff;
  overflow-x: hidden;
  overflow-y: auto; /* Izinkan scroll jika konten sangat besar, tapi layout utama harus dihindari */
}

/* ==== LAYOUT UTAMA ==== */
#wrap {
  display: flex;
  min-height: 100%; /* Mengambil tinggi body */
  width: 100%;
}

#sidebar {
  width: 160px;
  background: #fff;
  color: #000;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  /* Tambahkan posisi tetap (jika diperlukan) atau biarkan mengikuti aliran */
}

#main {
  flex: 1;
  padding: 10px;
  display: flex;
  flex-direction: column;
  align-items: center;
  background: linear-gradient(to bottom, #ff0000, #800000);
  position: relative;
  /* FIX: Mengambil sisa ruang yang tersedia di flex container */
  min-height: 0;
}

button {
  padding: 10px;
  border-radius: 8px;
  border: none;
  background: linear-gradient(90deg, red, green);
  color: #fff;
  cursor: pointer;
  font-weight: bold;
}

#title {
  color: #00ffae;
  font-size: 26px;
  margin-bottom: 10px;
}

.footer {
  margin-top: 10px;
  color: #0ff;
  text-shadow: 0 0 4px #0ff;
  font-size: 12px;
}

/* ==== AREA UTAMA (LOGO / GAME / LEADERBOARD) ==== */
/* FIX: Hapus aspect-ratio agar tinggi bisa fleksibel, tapi batasi MAX width */
.content-area {
  width: 100%;
  max-width: 480px;
  background: rgba(0,0,0,0.25);
  border-radius: 12px;
  overflow: hidden;
  position: relative;
  
  /* FIX: Ambil ruang sebanyak mungkin di #main, tapi biarkan tingginya fleksibel */
  flex: 1; 
  /* Gunakan max-height untuk menghindari overlap dengan d-pad jika ada */
  max-height: calc(100vh - 200px); /* Estimasi ruang yang tersisa untuk UI/footer/dpad */
}

iframe {
  width: 100%;
  height: 100%;
  border: 0;
  display: none;
}

/* ==== POSTER LOGO ==== */
#logoPlaceholder {
  /* Hapus height:100% dan biarkan mengikuti .content-area */
  width: 100%;
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(180deg, rgba(0,0,0,0.25), rgba(255,255,255,0.02));
}

#logoPlaceholder img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#poster-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  align-items: center;
  text-align: center;
  padding: 20px;
  text-shadow: 0 0 5px black;
  pointer-events: none;
}

#poster-overlay h2 {font-size: 1.6em; color: #facc15}
#poster-overlay p {font-size: 1em}

.overlay-cta {
  padding: 12px 30px;
  font-size: 1.1em;
  font-weight: bold;
  border-radius: 8px;
  pointer-events: auto;
  cursor: pointer;
}

/* ==== MOBILE LOCK (Hingga 768px) ==== */
@media (max-width:768px){
  /* FIX: Pastikan wrap mengambil 100% tinggi viewport */
  #wrap {
      flex-direction: column;
      min-height: 100vh;
  }
  
  /* Sidebar diubah menjadi header horizontal, HINDARI penggunaan height:100% pada elemen di dalamnya */
  #sidebar {
    width: 100%;
    flex-direction: row;
    justify-content: space-around;
    flex-wrap: wrap;
    /* FIX: Hapus padding vertical agar lebih ringkas di atas */
    padding: 8px 12px;
  }

  /* Main area harus mengambil sisa ruang dan mengizinkan scroll internal jika diperlukan */
  #main {
    flex: 1; 
    padding: 10px;
    /* FIX: Tambahkan min-height:0 agar flex-grow berfungsi */
    min-height: 0; 
  }
  
  /* FIX: Batasi tinggi area konten agar tidak overflow ke footer/dpad (Jika D-Pad ada di index.html) */
  .content-area {
      /* Tinggi yang diambil oleh #title, #topScoreSummary, dan .footer sekitar 120px. */
      /* Kita atur agar content-area mengambil sisa ruang vertikal di dalam #main */
      flex: 1; /* Ambil sisa ruang */
      max-height: calc(100vh - 120px); /* Fallback untuk DApps browser */
      /* Kita tidak bisa memberikan nilai fix karena D-Pad tidak ada di HTML ini. */
  }


  #walletAddr,#walletBal {display:block;font-size:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin: 0 4px;}
  
  /* FIX: Perbaiki ukuran tombol agar tidak terlalu besar */
  #btnConnect, #btnPlay, #btnLeaderboard {
    padding: 6px 10px;
    font-size: 12px;
  }
}
</style>
</head>

<body>
<div id="wrap">

  <div id="sidebar">
    <button id="btnConnect">Connect Wallet</button>
    <div style="display:flex; flex-direction:column; justify-content:center;">
        <div id="walletAddr" title="Wallet address">Wallet: -</div>
        <div id="walletBal" title="Native balance">SOMI: -</div>
    </div>
    <button id="btnPlay">Play Game</button>
    <button id="btnLeaderboard">Leaderboard</button>
  </div>

  <div id="main">

    <div id="title">‚òÉÔ∏è SOMNIA CHRISTMAS CARNIVAL üéÑ</div>

    <div id="topScoreSummary" style="color:#fff;padding:10px;margin-bottom:12px;border-radius:6px;background:rgba(0,0,0,0.4);width:100%;max-width:480px;text-align:center;">
      üí∞ <b>Jackpot:</b> <span id="poolValue">0.00 SOMI</span> |
      üèÜ <b>Top:</b> <span id="topScoreValue">0</span>
    </div>

    <div class="content-area">

      <div id="logoPlaceholder" role="img" aria-label="Somnia poster">
        <img id="posterImg" src="assets/logo1.png" alt="Somnia Logo">
        <div id="poster-overlay">
          <div style="margin-top:8px;">
            <h2>SOMNIA CHRISTMAS!</h2>
            <p>Main & menangkan Jackpot Natal üéÅ</p>
          </div>
          <div style="margin-bottom:8px;">
            <button id="overlayStart" class="overlay-cta">Mulai</button>
          </div>
        </div>
      </div>

      <iframe id="gameFrame" src="./pacman/pacman_xmas.html" title="Pacman Game"></iframe>
      <iframe id="leaderFrame" src="leaderboard.html" title="Leaderboard"></iframe>

    </div>
    
    <div class="footer">created by: ifunkkalem | @Ifunkkalem91</div>
  </div>
</div>

<script>
// ... (Kode JavaScript Anda di sini) ...
const btnConnect = document.getElementById('btnConnect');
const btnPlay = document.getElementById('btnPlay');
const btnLeaderboard = document.getElementById('btnLeaderboard');
const walletAddrEl = document.getElementById('walletAddr');
const walletBalEl = document.getElementById('walletBal');
const gameFrame = document.getElementById('gameFrame');
const leaderFrame = document.getElementById('leaderFrame');
const logoPlaceholder = document.getElementById('logoPlaceholder');
const overlayStart = document.getElementById('overlayStart');
const posterImg = document.getElementById('posterImg');

// SAFER showMain: only show if element exists
function showMain(id){
  try{
    logoPlaceholder.style.display='none';
    gameFrame.style.display='none';
    leaderFrame.style.display='none';
    const el = document.getElementById(id);
    if(el) el.style.display = 'block';
  }catch(e){
    console.warn('showMain error', e);
  }
}

// Previously Play directly posted paySuccess -> this allowed game to start without payment.
// Now Play asks parent (app.js) to start the game; parent must reply with {type:'paySuccess'}.
function requestStartGame(){
  // send a request to parent/app.js to start (pay & unlock)
  // parent should perform wallet tx and reply with {type:'paySuccess'} when confirmed.
  try{
    window.parent.postMessage({ type: 'requestStartGame' }, '*');
    // show a subtle waiting feedback while parent handles tx (parent could also send status messages)
    const gm = document.createElement('div');
    gm.id = '__waiting_req';
    gm.style.position='fixed'; /* FIX: Gunakan fixed agar tidak terpengaruh scroll */
    gm.style.left='50%';
    gm.style.top='8px';
    gm.style.transform='translateX(-50%)';
    gm.style.background='rgba(0,0,0,0.6)';
    gm.style.color='white';
    gm.style.padding='6px 10px';
    gm.style.borderRadius='8px';
    gm.style.zIndex='999';
    gm.textContent = 'Requesting start... check wallet.';
    document.body.appendChild(gm);
    setTimeout(()=> {
      const w = document.getElementById('__waiting_req');
      if(w) w.remove();
    }, 8000);
  }catch(e){
    console.warn('requestStartGame postMessage failed', e);
  }
}

// Hook up UI controls to requestStartGame instead of starting locally
btnPlay.addEventListener('click', (ev)=>{
  ev.preventDefault();
  requestStartGame();
});

overlayStart.addEventListener('click', (ev)=>{
  ev.preventDefault();
  requestStartGame();
});

// Leaderboard shows iframe
btnLeaderboard.addEventListener('click', ()=>{
  showMain('leaderFrame');
});

// Connect wallet button should be implemented in app.js; we only forward an event request
btnConnect.addEventListener('click', ()=>{
  try{ window.parent.postMessage({ type: 'requestConnectWallet' }, '*'); }
  catch(e){ console.warn('postMessage connect failed', e); }
});

// Listen for messages from parent (app.js)
// - paySuccess: show game iframe (parent should already have started audio/bg/etc)
// - walletInfo: update wallet address & balance
// - forceShowLogo / forceHideLogo (optional)
// - startFee (optional info)
window.addEventListener('message', (ev)=>{
  const d = ev.data || {};
  if(!d || typeof d !== 'object') return;

  if(d.type === 'paySuccess'){
    // parent confirmed payment / start ‚Äî show game
    showMain('gameFrame');
    // remove any waiting UI if still present
    const w = document.getElementById('__waiting_req'); if(w) w.remove();
  }

  if(d.type === 'walletInfo'){
    // Expect { type:'walletInfo', address: '0x...', balance: '0.123' }
    if(d.address){
      walletAddrEl.textContent = 'Wallet: ' + (d.address.length>12 ? d.address.substring(0,6)+'...'+d.address.slice(-4) : d.address);
      walletAddrEl.title = d.address;
    }
    if(typeof d.balance !== 'undefined'){
      walletBalEl.textContent = d.balance + ' SOMI';
      walletBalEl.title = d.balance + ' SOMI';
    }
  }

  if(d.type === 'startFee'){
    // optional: parent can send fee info
    console.info('Start fee:', d.feeEth || d.feeWei);
  }

  if(d.type === 'forceShowLogo'){
    showMain('logoPlaceholder');
  }
});

// ensure poster image fallback (so it won't appear blank)
posterImg.addEventListener('error', ()=>{
  posterImg.src = 'assets/logo.png';
});

// initial state: show poster
showMain('logoPlaceholder');

</script>
<script src="app.js"></script>
  
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Somnia Christmas ‚Äî Pacman</title>

<script src="libs/ethers.min.js"></script>

<style>
/* ---------------------------------------------------- */
/* --- PERBAIKAN CSS UNTUK VIEWPORT MOBILE & DAPPS --- */
/* ---------------------------------------------------- */

*{
  box-sizing:border-box;
  margin:0;
  padding:0;
  font-family:Trebuchet MS,sans-serif;
}

/* FIX 1: Memaksa BODY menggunakan 100% tinggi viewport dan menggunakan Flexbox vertikal */
body {
  height: 100vh;
  min-height: 100%; 
  background: linear-gradient(to right, #fff, #ff0000);
  color: #fff;
  overflow: hidden; /* Mencegah scroll global */
  display: flex; /* Aktifkan Flexbox di body */
  flex-direction: column; /* Konten body disusun vertikal */
}

/* ==== LAYOUT UTAMA ==== */
#wrap {
  display: flex;
  flex: 1; /* FIX 2: Membuat wrap mengisi sisa ruang body (100% tinggi) */
  width: 100%;
}

/* Sidebar diubah menjadi header horizontal di mobile */
#sidebar {
  width: 180px; /* Lebarkan sedikit untuk tombol mode */
  background: #fff;
  color: #000;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  flex-shrink: 0; 
}

#main {
  flex: 1; /* Mengambil sisa lebar */
  padding: 10px;
  display: flex;
  flex-direction: column; /* FIX 3: Susun konten #main secara vertikal */
  align-items: center;
  background: linear-gradient(to bottom, #ff0000, #800000);
  position: relative;
  min-height: 0; 
  z-index: 1; /* Pastikan di atas iframe saat dibutuhkan */
}

button {
  padding: 10px;
  border-radius: 8px;
  border: none;
  background: linear-gradient(90deg, #b91c1c, #16a34a); /* Merah dan Hijau */
  color: #fff;
  cursor: pointer;
  font-weight: bold;
}

.mode-button {
  padding: 8px;
  font-size: 13px;
  background: linear-gradient(90deg, #ff0000, #00ffae); /* Merah ke Neon Hijau */
}

#title {
  color: #00ffae;
  font-size: 26px;
  margin-bottom: 10px;
}

.footer {
  margin-top: 10px;
  color: #0ff;
  text-shadow: 0 0 4px #0ff;
  font-size: 12px;
  flex-shrink: 0; 
}

/* ==== AREA UTAMA (LOGO / GAME / LEADERBOARD) ==== */
.content-area {
  width: 100%;
  max-width: 480px;
  flex: 1; 
  background: rgba(0,0,0,0.25);
  border-radius: 12px;
  overflow: hidden;
  position: relative;
  min-height: 300px;
  margin-bottom: 10px; 
}

iframe {
  width: 100%;
  height: 100%;
  border: 0;
  display: none;
}

/* ==== POSTER LOGO & OVERLAY ==== */
#logoPlaceholder {
  width: 100%;
  height: 100%;
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(180deg, rgba(0,0,0,0.25), rgba(255,255,255,0.02));
}

#logoPlaceholder img{
  width:100%;
  height:100%;
  object-fit:cover;
}

#poster-overlay{
  position:absolute;
  inset:0;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
  align-items:center;
  text-align:center;
  padding:20px;
  text-shadow:0 0 5px black;
  pointer-events:none; 
}

#poster-overlay h2{font-size:1.6em;color:#facc15}
#poster-overlay p{font-size:1em}

/* Hapus styling overlay-cta karena tombol sudah dipindahkan */
.overlay-cta{
  display:none; 
}

/* ==== MOBILE LOCK (Hingga 768px) ==== */
@media (max-width:768px){
  /* FIX 5: Layout utama di mobile menjadi tumpukan vertikal */
  #wrap {
      flex-direction: column;
      min-height: 100%;
      flex: 1;
  }
  
  /* Sidebar/Header */
  #sidebar {
    width: 100%;
    flex-direction: row;
    justify-content: space-around;
    flex-wrap: wrap;
    padding: 8px 10px;
    gap: 4px;
    /* PENTING: Sembunyikan Mode Buttons di mobile agar Header tidak terlalu penuh */
  }

  /* Sembunyikan Mode Buttons di Mobile Header */
  #modeButtonsSidebar {
    display: none !important;
  }
  
  /* TAMPILKAN Mode Buttons di Mobile di area utama saat Home */
  #modeButtonsMain {
    display: flex !important;
    flex-direction: row;
    justify-content: center;
    gap: 8px;
    margin-top: 10px;
  }

  /* Wallet Info yang lebih ringkas */
  #walletAddr,#walletBal {
      display:block;
      font-size:10px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin: 0 4px;
  }
  
  /* Ukuran tombol lebih kecil di mobile header */
  #btnConnect, #btnHome, #btnLeaderboard {
    padding: 6px 10px;
    font-size: 12px;
  }

  /* Ringkaskan Summary */
  #topScoreSummary {
    padding: 5px 10px;
    font-size: 12px;
  }
  
  /* Pastikan iframe mengambil seluruh ruang content-area */
  .content-area {
    min-height: 300px;
  }
}
</style>
</head>

<body>
<div id="wrap">

  <div id="sidebar">
    <button id="btnConnect">Connect Wallet</button>
    <button id="btnHome">Home</button> 
    <div style="display:flex; flex-direction:column; justify-content:center; flex-shrink: 0;">
        <div id="walletAddr" title="Wallet address">Wallet: -</div>
        <div id="walletBal" title="Native balance">SOMI: -</div>
    </div>
    
    <div id="modeButtonsSidebar" style="display:flex; flex-direction:column; gap:8px; width:100%;">
        <button id="btnModeClassic" class="mode-button" data-mode="Classic" data-fee="0.001">Classic (0.01 SOMI)</button>
        <button id="btnModeTime" class="mode-button" data-mode="TimeAttack" data-fee="0.001">Time Attack (0.03 SOMI)</button>
        <button id="btnModeHardcore" class="mode-button" data-mode="Hardcore" data-fee="0.001">Hardcore (0.05 SOMI)</button>
    </div>
    
    <button id="btnLeaderboard">Leaderboard</button>
  </div>

  <div id="main">

    <div id="title">‚òÉÔ∏è SOMNIA CHRISTMAS CARNIVAL üéÑ</div>

    <div id="topScoreSummary" style="color:#fff;padding:10px;margin-bottom:12px;border-radius:6px;background:rgba(0,0,0,0.4);width:100%;max-width:480px;text-align:center;">
      üí∞ <b>Jackpot:</b> <span id="poolValue">0.00 SOMI</span> |
      üèÜ <b>Top:</b> <span id="topScoreValue">0</span>
    </div>
    
    <div id="modeButtonsMain" style="display:none; width:100%; max-width:480px; margin-bottom: 12px; padding: 0 10px; box-sizing: border-box;">
        <button id="btnModeClassicMobile" class="mode-button" data-mode="Classic" data-fee="0.001" style="flex:1;">Classic</button>
        <button id="btnModeTimeMobile" class="mode-button" data-mode="TimeAttack" data-fee="0.001" style="flex:1;">Time Attack</button>
        <button id="btnModeHardcoreMobile" class="mode-button" data-mode="Hardcore" data-fee="0.001" style="flex:1;">Hardcore</button>
    </div>

    <div class="content-area">

      <div id="logoPlaceholder" role="img" aria-label="Somnia poster">
        <img id="posterImg" src="assets/logo1.png" alt="Somnia Logo">
        <div id="poster-overlay">
          <div style="margin-top:8px;">
            <h2>SOMNIA CHRISTMAS!</h2>
            <p>Main & menangkan Jackpot Natal üéÅ</p>
          </div>
          </div>
      </div>

      <iframe id="gameFrame" src="pacman_xmas.html" title="Pacman Game"></iframe>
      <iframe id="leaderFrame" src="leaderboard.html" title="Leaderboard"></iframe>

    </div>

    <div class="footer">created by: ifunkkalem | @Ifunkkalem91</div>
  </div>
</div>

<script>
const btnConnect = document.getElementById('btnConnect');
const btnLeaderboard = document.getElementById('btnLeaderboard');
const btnHome = document.getElementById('btnHome'); 
const walletAddrEl = document.getElementById('walletAddr');
const walletBalEl = document.getElementById('walletBal');
const gameFrame = document.getElementById('gameFrame');
const leaderFrame = document.getElementById('leaderFrame');
const logoPlaceholder = document.getElementById('logoPlaceholder');
const posterImg = document.getElementById('posterImg');

// SAFER showMain: only show if element exists
function showMain(id){
  try{
    // Cek apakah mode buttons harus ditampilkan
    const showModeButtons = (id === 'logoPlaceholder');
    const modeSidebar = document.getElementById('modeButtonsSidebar');
    const modeMain = document.getElementById('modeButtonsMain');
    
    if (modeSidebar) modeSidebar.style.display = showModeButtons && window.innerWidth > 768 ? 'flex' : 'none';
    if (modeMain) modeMain.style.display = showModeButtons && window.innerWidth <= 768 ? 'flex' : 'none';

    logoPlaceholder.style.display='none';
    gameFrame.style.display='none';
    leaderFrame.style.display='none';
    const el = document.getElementById(id);
    if(el) el.style.display = 'block';
  }catch(e){
    console.warn('showMain error', e);
  }
}

// Hook up UI controls 
btnHome.addEventListener('click', ()=>{
  showMain('logoPlaceholder'); 
});

// Leaderboard shows iframe
btnLeaderboard.addEventListener('click', ()=>{
  leaderFrame.src = "leaderboard.html?" + Date.now(); 
  showMain('leaderFrame');
});

// Connect wallet button should be implemented in app.js; we only forward an event request
btnConnect.addEventListener('click', ()=>{
  try{ window.parent.postMessage({ type: 'requestConnectWallet' }, '*'); }
  catch(e){ console.warn('postMessage connect failed', e); }
});


// Listener untuk semua tombol mode (Sidebar dan Main Area)
document.querySelectorAll('.mode-button').forEach(btn => {
    btn.addEventListener('click', () => {
        const mode = btn.getAttribute('data-mode');
        const fee = btn.getAttribute('data-fee');
        
        if (!mode || !fee) return;
        
        // Kirim sinyal ke app.js untuk memproses transaksi dan memulai game
        window.parent.postMessage({ 
            type: 'requestStartTx', 
            modeName: mode, 
            feeEth: fee 
        }, '*');
    });
});


// Listen for messages from parent (app.js)
window.addEventListener('message', (ev)=>{
  const d = ev.data || {};
  if(!d || typeof d !== 'object') return;

  if(d.type === 'paySuccess'){
    // parent confirmed payment / start ‚Äî show game
    showMain('gameFrame');
    // remove any waiting UI if still present
    const w = document.getElementById('__waiting_req'); if(w) w.remove();
  }

  if(d.type === 'walletInfo'){
    if(d.address){
      walletAddrEl.textContent = 'Wallet: ' + (d.address.length>12 ? d.address.substring(0,6)+'...'+d.address.slice(-4) : d.address);
      walletAddrEl.title = d.address;
    }
    if(typeof d.balance !== 'undefined'){
      walletBalEl.textContent = Number(d.balance).toFixed(6) + ' SOMI';
      walletBalEl.title = d.balance + ' SOMI';
    }
  }

  // Listener untuk data Jackpot/Top Score dari app.js
  if(d.type === 'updateSummary'){
      const poolEl = document.getElementById('poolValue');
      const scoreEl = document.getElementById('topScoreValue');
      
      if (d.jackpot && poolEl) poolEl.textContent = parseFloat(d.jackpot).toFixed(6) + ' SOMI';
      if (d.topScore && scoreEl) scoreEl.textContent = d.topScore;
  }
  
  // Listener untuk navigasi otomatis ke Leaderboard setelah submit skor
  if(d.type === 'showLeaderboard'){
      leaderFrame.src = "leaderboard.html?" + Date.now(); 
      showMain('leaderFrame');
  }
  
  // Listener dari app.js untuk menampilkan logo/home
  if(d.type === 'forceShowLogo'){
    showMain('logoPlaceholder');
  }
});

// Resizing logic for mode buttons visibility
window.addEventListener('resize', () => showMain(document.querySelector('.content-area > div[style*="block"]') ? 'gameFrame' : 'logoPlaceholder'));


// ensure poster image fallback (so it won't appear blank)
posterImg.addEventListener('error', ()=>{
  posterImg.src = 'assets/logo.png';
});

// initial state: show poster
showMain('logoPlaceholder');

</script>
<script src="app.js"></script>
  
</body>
</html>


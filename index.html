<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOMNIA CHRISTMAS QUEST - PAC-MAN</title>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Konfigurasi Tailwind untuk tema Natal yang Ikonik
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'christmas-red': '#C91010', 
                        'christmas-green': '#0B6623', 
                        'christmas-light-green': '#38761D', 
                        'christmas-snow': '#FFFFFF', 
                        'christmas-gold': '#FFD700', 
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            color: var(--christmas-snow); 
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px 10px;
            
            /* Latar Belakang Merah Cerah dengan Tekstur */
            background-color: #E84D4D; 
            background-image: repeating-linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.1) 0,
                rgba(255, 255, 255, 0.1) 10px,
                transparent 10px,
                transparent 20px
            ); 
        }
        
        /* BINGKAI UTAMA (GAME CONTAINER) */
        .game-container {
            width: 100%;
            max-width: 480px;
            background-color: var(--christmas-green); 
            color: var(--christmas-snow); 
            
            /* Border Berlapis (Simulasi Pita/Candy Cane) */
            border: 8px solid var(--christmas-snow); 
            box-shadow: 
                0 0 0 4px var(--christmas-red), 
                0 0 30px rgba(255, 255, 255, 0.8); 
                
            padding: 30px; 
            border-radius: 1.5rem; 
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative; 
            z-index: 10;
        }
        
        /* JUDUL */
        .main-title {
            font-size: 2.75rem;
            line-height: 1;
            font-weight: 900;
            text-align: center;
            margin-bottom: 0.5rem;
            color: var(--christmas-snow); 
            text-shadow: 
                2px 2px 0 var(--christmas-red), 
                0 0 15px rgba(255, 255, 255, 0.8); 
        }

        /* SUBTITLE */
        .sub-title {
            font-size: 1.25rem;
            text-align: center;
            margin-bottom: 2rem;
            color: var(--christmas-gold); 
            font-weight: 700;
        }

        /* BINGKAI GAME (KANVAS) */
        canvas {
            background-color: #000000;
            display: block;
            border: 4px solid var(--christmas-red); 
            border-radius: 0.5rem;
            margin-bottom: 20px;
            touch-action: none; 
            box-shadow: 0 0 15px var(--christmas-red); 
        }
        
        /* TOMBOL AKSI */
        .btn-action {
            background-color: var(--christmas-red);
            color: var(--christmas-snow); 
            padding: 16px 24px;
            border-radius: 1rem; 
            font-weight: 900;
            text-transform: uppercase;
            transition: all 0.2s ease;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            border: 3px solid var(--christmas-light-green); 
            box-shadow: 0 6px 0 var(--christmas-light-green), 0 0 20px rgba(255, 255, 255, 0.7);
            position: relative;
        }

        .btn-action.active-glow {
            background-color: var(--christmas-light-green); 
            border-color: var(--christmas-snow);
            box-shadow: 0 6px 0 var(--christmas-red), 0 0 25px var(--christmas-snow); 
        }
        
        /* Status/Error Button (Status DB) */
        .btn-status {
            background-color: var(--christmas-snow); 
            color: var(--christmas-red); 
            padding: 14px 24px;
            border-radius: 0.75rem; 
            font-weight: 700;
            width: 100%;
            margin-bottom: 15px;
            border: 2px solid var(--christmas-green); 
            cursor: default;
            box-shadow: 0 4px 0 var(--christmas-green);
        }
        .btn-status #playerName {
            color: var(--christmas-green); 
        }

        .btn-action:hover:not(:disabled), .btn-action:focus:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 0 var(--christmas-light-green), 0 0 30px var(--christmas-snow);
        }
        .btn-action:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 2px 0 var(--christmas-light-green);
        }
        
        .btn-action:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(0.5);
            background-color: #A0A0A0 !important;
            border-color: #606060 !important;
            color: #E0E0E0 !important;
            box-shadow: 0 4px 0 #606060 !important;
        }

        /* D-PAD */
        .dpad-container {
            display: grid;
            grid-template-areas:
                ". up ."
                "left center right"
                ". down .";
            width: 150px;
            height: 150px;
            margin: 20px 0;
            background-color: var(--christmas-snow); 
            border-radius: 1rem;
            padding: 5px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
        }
        .dpad-btn {
            grid-area: var(--dir);
            background-color: var(--christmas-red); 
            color: var(--christmas-snow); 
            border: 2px solid var(--christmas-green); 
            border-radius: 0.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: 0 4px 0 var(--christmas-green);
        }
        .dpad-btn:active {
            background-color: var(--christmas-green); 
            color: var(--christmas-snow);
            transform: translateY(2px);
            box-shadow: 0 2px 0 var(--christmas-red);
        }
        
        /* MODAL STYLES */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: var(--christmas-snow); 
            color: #333;
            border: 4px solid var(--christmas-green); 
            border-radius: 1rem;
            padding: 30px;
            text-align: center;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 0 20px var(--christmas-red); 
        }
        .modal-title {
            font-size: 1.75rem;
            font-weight: 900;
            color: var(--christmas-red); 
            margin-bottom: 10px;
        }
        .modal-message {
            margin-bottom: 20px;
            color: #333; 
        }
        .modal-leaderboard-content {
            background-color: #F0FFF0; 
            padding: 10px;
            border-radius: 0.5rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            border: 1px solid var(--christmas-green);
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed var(--christmas-red);
        }
        .leaderboard-item:last-child {
            border-bottom: none;
        }
        .leaderboard-score {
            color: var(--christmas-red);
            font-weight: 900;
        }
        .leaderboard-name {
            color: var(--christmas-green);
            font-weight: 700;
        }

        /* === EFEK SALJU TURUN (SNOWFALL) === */
        #snow {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            z-index: 5; 
        }

        #snow:before, #snow:after {
            content: "";
            position: fixed;
            width: 100vw;
            height: 100vh;
            filter: blur(0.5px);
            opacity: 0.9;
            background-image: radial-gradient(white 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        #snow:before {
            animation: snow-fall 15s linear infinite;
        }

        #snow:after {
            animation: snow-fall 25s linear infinite;
            background-size: 30px 30px;
            opacity: 0.7;
        }
        
        /* Animasi Salju */
        @keyframes snow-fall {
            0% {
                transform: translateY(0);
            }
            100% {
                transform: translateY(100vh); 
            }
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- Efek Salju (Z-index 5) -->
    <div id="snow"></div>

    <div id="startScreen" class="game-container min-h-[500px]">
        <h1 class="main-title text-4xl sm:text-5xl">
            SELAMAT DATANG DI SOMNIA
        </h1>
        <p class="sub-title">CHRISTMAS QUEST EDITION</p>

        <div class="space-y-4 w-full">
            
            <!-- 1. DB Status/Error Button -->
            <button id="dbStatusContainer" disabled class="btn-status" title="Status Koneksi Firebase">
                <p id="dbStatus" class="text-sm font-bold">
                    Memuat Koneksi Database...
                </p>
                <p id="playerName" class="text-xs mt-1">
                    Menunggu Lingkungan (Host) Mengirim Data.
                </p>
            </button>
            
            <!-- 2. CONNECT WALLET -->
            <button id="connectWalletBtn" class="btn-action active-glow" onclick="startOnchain()">
                CONNECT WALLET
            </button>
            
            <!-- 3. SAVE DISPLAY NAME -->
            <button id="saveDisplayNameBtn" class="btn-action" disabled>
                SAVE DISPLAY NAME
            </button>
            
            <!-- 4. PLAY GAME -->
            <button id="startGameBtn" class="btn-action" disabled>
                PLAY GAME
            </button>
            
            <!-- 5. LEADERBOARD -->
            <button id="leaderboardBtn" class="btn-action" onclick="showLeaderboardModal()">
                LEADERBOARD
            </button>
        </div>
        
    </div>

    <div id="gameScreen" class="game-container hidden">
        <div class="w-full flex justify-between items-center mb-3 text-sm">
            <div class="text-sm text-christmas-snow">Player: <span id="playerNameGame" class="font-bold text-christmas-gold"></span></div>
            <div class="text-xl font-bold text-christmas-snow">SCORE: <span id="scoreDisplay" class="text-christmas-gold">0</span></div>
        </div>
        
        <canvas id="gameCanvas" width="440" height="480"></canvas>

        <div class="dpad-container">
            <button class="dpad-btn" style="--dir: up;" ontouchstart="handleMovement('up')" ontouchend="stopMovement()" onclick="handleMovement('up')">▲</button>
            <button class="dpad-btn" style="--dir: left;" ontouchstart="handleMovement('left')" ontouchend="stopMovement()" onclick="handleMovement('left')">◀</button>
            <div class="dpad-btn" style="--dir: center;"></div>
            <button class="dpad-btn" style="--dir: right;" ontouchstart="handleMovement('right')" ontouchend="stopMovement()" onclick="handleMovement('right')">►</button>
            <button class="dpad-btn" style="--dir: down;" ontouchstart="handleMovement('down')" ontouchend="stopMovement()" onclick="handleMovement('down')">▼</button>
        </div>

        <button id="backMenuBtn" class="btn-action w-full">BACK TO MENU</button>
    </div>

    <!-- Modal Kustom (Untuk Error, Game Over, dll.) -->
    <div id="customModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <h2 id="modalTitle" class="modal-title">Game Over!</h2>
            <p id="modalMessage" class="modal-message">Skor Anda: 0</p>
            <button id="modalCloseBtn" class="btn-action active-glow" onclick="document.getElementById('customModal').style.display='none'">TUTUP</button>
        </div>
    </div>
    
    <!-- Modal Leaderboard -->
    <div id="leaderboardModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <h2 class="modal-title">Leaderboard Somnia Christmas</h2>
            <p class="modal-message text-christmas-red">Skor 10 Tertinggi</p>
            <div id="leaderboardList" class="modal-leaderboard-content">
                <!-- Data Leaderboard akan di-inject di sini -->
                <p class="text-center text-gray-400">Memuat data...</p>
            </div>
            <button class="btn-action active-glow mt-4" onclick="document.getElementById('leaderboardModal').style.display='none'">TUTUP</button>
        </div>
    </div>

    <!-- SKRIP UTAMA: GABUNGAN FIREBASE/WEB3 DAN LOGIKA GAME -->
    <script type="module">
        // Import Firebase SDK (Versi yang sudah diuji)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- VARIABEL UI & NAVIGASI ---
        const startScreen = document.getElementById('startScreen');
        const gameScreen = document.getElementById('gameScreen');
        const startGameBtn = document.getElementById('startGameBtn');
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const backMenuButton = document.getElementById('backMenuBtn');
        const saveDisplayNameBtn = document.getElementById('saveDisplayNameBtn');
        const leaderboardList = document.getElementById('leaderboardList');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const playerNameGame = document.getElementById('playerNameGame');
        const modalOverlay = document.getElementById('customModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');

        // Elemen Status DB
        const dbStatusElement = document.getElementById('dbStatus');
        const playerNameElement = document.getElementById('playerName');
        const dbStatusContainer = document.getElementById('dbStatusContainer');

        // --- VARIABEL FIREBASE/WEB3 ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'somnia-default-app-id';
        let firebaseConfig = null; // Akan diisi saat inisialisasi
        let initialAuthToken = null; // Akan diisi saat inisialisasi
        
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false; 
        let isWalletConnected = false;
        let displayName = localStorage.getItem('displayName') || "Player Anon";

        // --- VARIABEL GAME ---
        const TILE_SIZE = 20; 
        const GRID_WIDTH = 22;
        const GRID_HEIGHT = 24;
        const CANVAS_WIDTH = GRID_WIDTH * TILE_SIZE;
        const CANVAS_HEIGHT = GRID_HEIGHT * TILE_SIZE;
        
        canvas.width = CANVAS_WIDTH;
        canvas.height = CANVAS_HEIGHT;

        let playerX, playerY;
        let score = 0;
        let gameLoopId;
        let gameRunning = false;
        let nextDirection = 'right'; 
        let currentDirection = 'right'; 
        let movementInterval = null;
        const SPEED_MS = 200; // Kecepatan pergerakan (dibuat sedikit lebih lambat)

        // Skema Peta (Maze)
        const initialMaze = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,1],
            [1,2,1,1,1,2,1,1,1,2,1,1,2,1,1,1,2,1,1,1,2,1],
            [1,3,1,1,1,2,1,1,1,2,2,2,2,1,1,1,2,1,1,1,3,1], 
            [1,2,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,2,1],
            [1,1,1,1,1,2,1,1,1,2,1,1,2,1,1,1,2,1,1,1,1,1],
            [1,1,1,1,1,2,1,4,0,0,0,0,0,0,4,1,2,1,1,1,1,1], 
            [1,1,1,1,1,2,1,0,0,0,0,0,0,0,0,1,2,1,1,1,1,1], 
            [1,1,1,1,1,2,1,0,0,0,0,0,0,0,0,1,2,1,1,1,1,1],
            [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
            [1,2,1,1,1,2,1,1,1,1,1,1,1,1,1,2,1,1,1,2,1],
            [1,2,2,2,1,2,2,2,2,2,2,0,2,2,2,2,2,1,2,2,1], 
            [1,1,1,2,1,1,1,1,1,1,1,0,1,1,1,1,1,1,2,1,1],
            [1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1],
            [1,2,2,2,2,2,1,1,1,2,1,1,2,1,1,1,2,2,2,2,1],
            [1,2,1,1,1,2,1,1,1,2,1,1,2,1,1,1,2,1,1,1,2,1],
            [1,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];
        
        let maze = initialMaze.map(row => [...row]); 
        
        // Hantu
        let ghosts = [
            { x: 10, y: 6, color: 'rgb(255, 69, 0)', dir: 'left', speed: 1, isFrightened: false }, 
            { x: 11, y: 6, color: 'rgb(0, 255, 255)', dir: 'right', speed: 1, isFrightened: false }, 
            { x: 9, y: 7, color: 'rgb(255, 184, 255)', dir: 'up', speed: 1, isFrightened: false }, 
            { x: 12, y: 7, color: 'rgb(255, 184, 82)', dir: 'down', speed: 1, isFrightened: false } 
        ];
        
        let frightenedTimeout = null;
        let lastUpdateTime = 0;
        const GHOST_MOVE_INTERVAL = 300; 

        // --- FUNGSI UTILITY UI/NAVIGASI ---
        function switchToScreen(screenId) {
            startScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            document.getElementById(screenId).classList.remove('hidden');
        }

        function closeModal(event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.style.display = 'none';
            }
        }
        
        // Update Status Firebase UI
        function updateFirebaseStatusUI(statusMessage, playerText, isReady) {
            dbStatusElement.innerText = statusMessage;
            playerNameElement.innerText = playerText;
            
            if (isReady) {
                dbStatusContainer.style.backgroundColor = 'var(--christmas-snow)'; 
                dbStatusContainer.style.color = 'var(--christmas-red)'; 
                dbStatusContainer.style.borderColor = 'var(--christmas-green)'; 
                dbStatusContainer.style.boxShadow = '0 4px 0 var(--christmas-green)';
                playerNameElement.style.color = 'var(--christmas-green)'; 
            } else {
                dbStatusContainer.style.backgroundColor = 'var(--christmas-red)';
                dbStatusContainer.style.color = 'var(--christmas-snow)';
                dbStatusContainer.style.borderColor = 'var(--christmas-snow)';
                dbStatusContainer.style.boxShadow = '0 4px 0 var(--christmas-snow)';
                playerNameElement.style.color = 'var(--christmas-gold)'; 
            }
        }

        // Update Status Tombol Connect Wallet
        function updateConnectButtonUI(isConnected) {
            if (isConnected) {
                connectWalletBtn.innerText = "WALLET CONNECTED (SIMULASI)";
                connectWalletBtn.disabled = true;
                connectWalletBtn.classList.remove('active-glow');
                connectWalletBtn.style.backgroundColor = 'var(--christmas-green)'; 
                connectWalletBtn.style.borderColor = 'var(--christmas-snow)';
                connectWalletBtn.style.boxShadow = '0 6px 0 var(--christmas-red)';
                if (isAuthReady) {
                    startGameBtn.disabled = false;
                }
            } else {
                connectWalletBtn.innerText = "CONNECT WALLET";
                connectWalletBtn.disabled = false;
                connectWalletBtn.classList.add('active-glow');
                connectWalletBtn.style.backgroundColor = ''; 
                connectWalletBtn.style.borderColor = ''; 
                connectWalletBtn.style.boxShadow = ''; 
                startGameBtn.disabled = true;
            }
        }
        
        // Tampilkan Modal
        function showCustomModal(title, message) {
            modalTitle.innerText = title;
            modalMessage.innerHTML = message;
            modalOverlay.style.display = 'flex';
        }
        window.showCustomModal = showCustomModal; 

        // --- FUNGSI FIREBASE/WEB3 ---

        async function initializeFirebase() {
            // Ambil variabel global dari Window (Lingkungan Host)
            firebaseConfig = window.__firebase_config ? JSON.parse(window.__firebase_config) : null;
            initialAuthToken = window.__initial_auth_token || null;
            
            // Pembaruan Status Awal
            updateFirebaseStatusUI("MEMERIKSA KONFIGURASI", "Memulai otentikasi...", false);

            if (!firebaseConfig) {
                updateFirebaseStatusUI(
                    "[KESALAHAN KONFIGURASI KRITIS]", 
                    "Variabel Firebase (__firebase_config) tidak terdefinisi. Tidak dapat terhubung ke Leaderboard/Web3. Menggunakan mode Anonim/Lokal.", 
                    false
                );
                console.error("Kesalahan: Variabel __firebase_config hilang atau tidak valid. Berjalan dalam mode Anonim/Lokal.");
                
                // Jika config tidak ada, kita masih bisa melanjutkan dengan anonim.
                isAuthReady = true;
                if (isWalletConnected) { startGameBtn.disabled = false; }
                saveDisplayNameBtn.disabled = false;
                return; 
            }

            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        
                        // Set display name dari localStorage atau UID
                        if (!localStorage.getItem('displayName')) {
                            displayName = "User#" + userId.substring(0, 6);
                            localStorage.setItem('displayName', displayName); 
                        } else {
                            displayName = localStorage.getItem('displayName');
                        }
                        
                        isAuthReady = true;
                        updateFirebaseStatusUI("KONEKSI BERHASIL", `ID Pemain: ${displayName} (${userId.substring(0, 8)}...)`, true);
                        
                        saveDisplayNameBtn.disabled = false;
                        
                        if (isWalletConnected) {
                             startGameBtn.disabled = false;
                        }
                        
                        listenToLeaderboard();
                        
                    } else {
                        userId = null;
                        isAuthReady = true; 
                        updateFirebaseStatusUI("[Gagal Otentikasi]", "Tidak dapat masuk. Silakan muat ulang.", false);
                    }
                });
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Gagal saat inisialisasi atau otentikasi Firebase:", error);
                updateFirebaseStatusUI("[ERROR KRITIS]", `Kode: ${error.code} | Pesan: ${error.message}`, false);
            }
        }

        // Simulasi Wallet
        window.startOnchain = () => {
            if (typeof ethers !== 'undefined' && ethers.providers) {
                isWalletConnected = true;
                updateConnectButtonUI(true);
                
                if (isAuthReady) {
                    startGameBtn.disabled = false;
                }
            } else {
                showCustomModal("Simulasi Gagal", "Ethers.js gagal dimuat. Coba muat ulang halaman.");
            }
        };

        // Menyimpan Nama Tampilan
        saveDisplayNameBtn.addEventListener('click', async () => {
            const input = prompt("Masukkan nama tampilan Anda (maks 15 karakter):");
            if (input && input.trim().length > 0) {
                const newName = input.trim().substring(0, 15);
                displayName = newName;
                localStorage.setItem('displayName', newName);
                
                if (db && userId) {
                    try {
                        // Simpan display name ke koleksi public
                        const userRef = doc(db, `artifacts/${appId}/public/data/users/${userId}`);
                        await setDoc(userRef, { displayName: newName, lastUpdate: new Date().toISOString() }, { merge: true });
                        updateFirebaseStatusUI("KONEKSI BERHASIL", `ID Pemain: ${newName} (${userId.substring(0, 8)}...)`, true);
                    } catch (e) {
                        console.error("Error menyimpan nama tampilan:", e);
                        showCustomModal("Error", "Gagal menyimpan nama tampilan ke database.");
                    }
                } else {
                     // Update UI lokal
                     updateFirebaseStatusUI("[MODE LOKAL/ANONIM]", `Nama Tampilan Lokal: ${newName}`, false);
                }
            }
        });

        // Menyimpan Skor
        window.saveScore = async (score) => {
            if (!db || !userId || !firebaseConfig) {
                // FALLBACK LOKAL (Jika Firebase Gagal/Anonim)
                console.warn("Database belum siap atau konfigurasi hilang. Menyimpan skor secara lokal.");
                let highscore = parseInt(localStorage.getItem('pacman_highscore')) || 0;
                if (score > highscore) {
                    localStorage.setItem('pacman_highscore', score);
                    // Tidak menampilkan modal karena modal game over/win sudah muncul
                }
                return;
            }

            try {
                // Simpan skor ke koleksi public
                const userRef = doc(db, `artifacts/${appId}/public/data/users/${userId}`);
                
                await setDoc(userRef, { 
                    displayName: displayName, 
                    score: score, 
                    lastPlayed: new Date().toISOString() 
                }, { merge: true });
                
                console.log(`Skor ${score} berhasil disimpan ke Firestore.`);
                
            } catch (e) {
                console.error("Gagal menyimpan skor ke Firestore:", e);
                showCustomModal("Error Database", "Gagal menyimpan skor tertinggi Anda.");
            }
        };

        // Listener Leaderboard
        function listenToLeaderboard() {
            if (!db) return;
            
            const leaderboardCollectionRef = collection(db, `artifacts/${appId}/public/data/users`);
            // NOTE: Kami tidak menggunakan orderBy untuk menghindari kesalahan index, sorting dilakukan secara lokal.
            const q = query(leaderboardCollectionRef);

            onSnapshot(q, (snapshot) => {
                let scores = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.score && typeof data.score === 'number') {
                        scores.push({
                            id: doc.id,
                            name: data.displayName || `User#${doc.id.substring(0, 6)}`,
                            score: data.score
                        });
                    }
                });

                scores.sort((a, b) => b.score - a.score);
                const topScores = scores.slice(0, 10);
                
                updateLeaderboardUI(topScores);
            }, (error) => {
                console.error("Error mendengarkan leaderboard:", error);
                leaderboardList.innerHTML = `<p class="text-center text-red-500">Error memuat data leaderboard: ${error.message}</p>`;
            });
        }

        function updateLeaderboardUI(scores) {
            if (leaderboardList) {
                if (scores.length === 0) {
                    leaderboardList.innerHTML = '<p class="text-center text-gray-500">Belum ada skor yang tercatat.</p>';
                    return;
                }

                leaderboardList.innerHTML = scores.map((item, index) => `
                    <div class="leaderboard-item">
                        <span class="leaderboard-name">#${index + 1} - ${item.name}</span>
                        <span class="leaderboard-score">${item.score}</span>
                    </div>
                `).join('');
            }
        }
        
        window.fetchLeaderboard = () => {
             // Listener onSnapshot sudah dipanggil, jadi data sudah diperbarui
             if (!db || !firebaseConfig) {
                 const localHighscore = parseInt(localStorage.getItem('pacman_highscore')) || 0;
                 leaderboardList.innerHTML = `<p class="text-center text-red-500 font-bold">⚠️ DB GAGAL. Skor Tertinggi Lokal: ${localHighscore}</p>
                                               <p class="text-center text-xs text-gray-500">Silakan hubungi administrator untuk memperbaiki koneksi Firebase.</p>`;
             }
        };
        
        // --- LOGIKA GAME PAC-MAN CHRISTMAS ---

        function initGame() {
            // Reset peta dan posisi
            maze = initialMaze.map(row => [...row]); 
            playerX = 11; 
            playerY = 12; 
            score = 0;
            ghosts = [
                { x: 10, y: 6, color: 'rgb(255, 69, 0)', dir: 'left', speed: 1, isFrightened: false }, 
                { x: 11, y: 6, color: 'rgb(0, 255, 255)', dir: 'right', speed: 1, isFrightened: false }, 
                { x: 9, y: 7, color: 'rgb(255, 184, 255)', dir: 'up', speed: 1, isFrightened: false }, 
                { x: 12, y: 7, color: 'rgb(255, 184, 82)', dir: 'down', speed: 1, isFrightened: false }
            ];
            
            currentDirection = 'right';
            nextDirection = 'right';
            scoreDisplay.innerText = score;
            playerNameGame.innerText = displayName;

            if (!gameRunning) {
                gameRunning = true;
                if (movementInterval) clearInterval(movementInterval);
                movementInterval = setInterval(gameLoop, SPEED_MS);
                gameLoopId = requestAnimationFrame(drawGame);
            }
        }
        
        function stopGameLoop() {
            gameRunning = false;
            if (movementInterval) clearInterval(movementInterval);
            if (gameLoopId) cancelAnimationFrame(gameLoopId);
        }

        // --- Pergerakan Pemain ---
        function movePlayerInDirection(dir) {
            let newX = playerX;
            let newY = playerY;

            if (dir === 'up') newY--;
            else if (dir === 'down') newY++;
            else if (dir === 'left') newX--;
            else if (dir === 'right') newX++;

            // Cek Tabrakan Dinding (1)
            if (maze[newY][newX] !== 1) {
                playerX = newX;
                playerY = newY;
                currentDirection = dir;
                
                // Cek Koleksi
                if (maze[playerY][playerX] === 2) {
                    score += 10;
                    maze[playerY][playerX] = 0; // Hapus dot
                } else if (maze[playerY][playerX] === 3) { // Perbaikan: gunakan playerY, playerX
                    score += 50;
                    maze[playerY][playerX] = 0; // Hapus power pellet
                    activateFrightenedMode();
                }
                
                scoreDisplay.innerText = score;
                checkWinCondition();
                return true;
            }
            return false;
        }

        function gameLoop() {
            if (!gameRunning) return;
            
            // 1. Coba pindah ke nextDirection
            let moved = movePlayerInDirection(nextDirection);
            
            // 2. Jika gagal (tabrak dinding), coba currentDirection
            if (!moved && nextDirection !== currentDirection) {
                movePlayerInDirection(currentDirection);
            }
            
            // 3. Pergerakan Hantu
            const currentTime = Date.now();
            if (currentTime - lastUpdateTime > GHOST_MOVE_INTERVAL) {
                moveGhosts();
                lastUpdateTime = currentTime;
            }
            
            // 4. Cek Tabrakan Hantu
            checkCollision();
        }

        function moveGhosts() {
            ghosts.forEach(ghost => {
                let possibleDirections = ['up', 'down', 'left', 'right'];
                let moved = false;
                
                // Jika sedang ketakutan, coba arah acak
                if (ghost.isFrightened) {
                    possibleDirections.sort(() => Math.random() - 0.5); // Acak
                }
                
                // Coba 4 arah untuk bergerak
                for (let dir of possibleDirections) {
                    let newX = ghost.x;
                    let newY = ghost.y;

                    if (dir === 'up') newY--;
                    else if (dir === 'down') newY++;
                    else if (dir === 'left') newX--;
                    else if (dir === 'right') newX++;

                    // Pastikan tidak tabrak dinding (1)
                    if (maze[newY] && maze[newY][newX] !== 1) {
                        ghost.x = newX;
                        ghost.y = newY;
                        ghost.dir = dir; // Update arah untuk iterasi berikutnya
                        moved = true;
                        break;
                    }
                }
                
                // Jika tidak bisa bergerak, balik arah (jika perlu)
                if (!moved) {
                    let newDir = '';
                    if (ghost.dir === 'up') newDir = 'down';
                    else if (ghost.dir === 'down') newDir = 'up';
                    else if (ghost.dir === 'left') newDir = 'right';
                    else if (ghost.dir === 'right') newDir = 'left';

                    let newX = ghost.x;
                    let newY = ghost.y;
                    if (newDir === 'up') newY--;
                    else if (newDir === 'down') newY++;
                    else if (newDir === 'left') newX--;
                    else if (newDir === 'right') newX++;
                    
                    // Coba bergerak setelah balik arah
                    if (maze[newY] && maze[newY][newX] !== 1) {
                        ghost.x = newX;
                        ghost.y = newY;
                        ghost.dir = newDir;
                    }
                }
            });
        }

        function checkCollision() {
            for (let i = 0; i < ghosts.length; i++) {
                const ghost = ghosts[i];
                if (ghost.x === playerX && ghost.y === playerY) {
                    if (ghost.isFrightened) {
                        // Pac-Man makan Hantu (Mode Ketakutan)
                        score += 200;
                        scoreDisplay.innerText = score;
                        
                        // Kirim hantu kembali ke posisi awal
                        ghosts.splice(i, 1);
                        ghosts.push({ 
                            x: 10 + (i % 2), 
                            y: 6 + (i % 2), 
                            color: 'rgb(128, 128, 128)', // Abu-abu saat kembali
                            dir: 'up', 
                            speed: 1, 
                            isFrightened: false 
                        });
                        break; // Keluar dari loop setelah makan hantu
                        
                    } else {
                        // Hantu makan Pac-Man (Game Over)
                        gameOver();
                        return;
                    }
                }
            }
        }
        
        function activateFrightenedMode() {
            clearTimeout(frightenedTimeout);
            
            // Atur semua hantu ke mode ketakutan
            ghosts.forEach(ghost => {
                ghost.isFrightened = true;
            });
            
            // Set timeout untuk mengakhiri mode ketakutan (8 detik)
            frightenedTimeout = setTimeout(() => {
                ghosts.forEach(ghost => {
                    ghost.isFrightened = false;
                });
            }, 8000); 
        }

        function checkWinCondition() {
            let remainingDots = 0;
            for (let y = 0; y < maze.length; y++) {
                for (let x = 0; x < maze[y].length; x++) {
                    if (maze[y][x] === 2 || maze[y][x] === 3) {
                        remainingDots++;
                    }
                }
            }

            if (remainingDots === 0) {
                stopGameLoop();
                window.saveScore(score);
                showCustomModal("SELAMAT, MISI SELESAI!", 
                    `<p>Anda berhasil mengumpulkan semua Candy Cane dan Power Pellet!</p>
                     <p class="mt-2 font-bold text-lg">Skor Akhir Anda: ${score}</p>`);
            }
        }

        function gameOver() {
            stopGameLoop();
            window.saveScore(score); 
            showCustomModal("GAME OVER!", 
                `<p>Anda tertangkap oleh Hantu Natal!</p>
                 <p class="mt-2 font-bold text-lg">Skor Akhir Anda: ${score}</p>`);
        }

        // --- FUNGSI GAMBAR (DRAWING) ---
        function drawTile(x, y, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
        }

        function drawMaze() {
            for (let y = 0; y < maze.length; y++) {
                for (let x = 0; x < maze[y].length; x++) {
                    const cell = maze[y][x];
                    
                    if (cell === 1) {
                        // Dinding - Hijau Natal
                        drawTile(x, y, 'var(--christmas-green)');
                    } else if (cell === 0 || cell === 2 || cell === 3 || cell === 4) {
                        // Jalan/Latar Belakang - Hitam
                        drawTile(x, y, 'black'); 
                        
                        if (cell === 2) {
                            // Candy Cane (Dot) - Putih Salju
                            ctx.fillStyle = 'var(--christmas-snow)';
                            ctx.beginPath();
                            ctx.arc(x * TILE_SIZE + TILE_SIZE / 2, y * TILE_SIZE + TILE_SIZE / 2, TILE_SIZE / 8, 0, 2 * Math.PI);
                            ctx.fill();
                        } else if (cell === 3) {
                            // Power Pellet (Kapsul) - Emas
                            ctx.fillStyle = 'var(--christmas-gold)';
                            ctx.beginPath();
                            ctx.arc(x * TILE_SIZE + TILE_SIZE / 2, y * TILE_SIZE + TILE_SIZE / 2, TILE_SIZE / 4, 0, 2 * Math.PI);
                            ctx.fill();
                        }
                    }
                }
            }
        }

        function drawPlayer() {
            const x = playerX * TILE_SIZE + TILE_SIZE / 2;
            const y = playerY * TILE_SIZE + TILE_SIZE / 2;
            const radius = TILE_SIZE / 2 - 2;
            
            let angleStart = 0.25;
            let angleEnd = 1.75;
            
            // Sesuaikan sudut mulut berdasarkan arah (efek animasi makan)
            if (currentDirection === 'up') { angleStart = 0.75; angleEnd = 2.25; }
            else if (currentDirection === 'down') { angleStart = 1.25; angleEnd = 2.75; }
            else if (currentDirection === 'left') { angleStart = 1.0; angleEnd = 3.0; }
            else if (currentDirection === 'right') { angleStart = 0.0; angleEnd = 2.0; }
            
            // Menggambar Pac-Man (Lingkaran Kuning)
            ctx.fillStyle = 'yellow';
            ctx.beginPath();
            // Animasi Mulut: buka/tutup berdasarkan waktu
            const mouthOpen = (Date.now() % 500 < 250); 
            const mouthOffset = mouthOpen ? 0.1 : 0.0;
            
            ctx.arc(x, y, radius, (angleStart + mouthOffset) * Math.PI, (angleEnd - mouthOffset) * Math.PI);
            ctx.lineTo(x, y);
            ctx.fill();
        }

        function drawGhosts() {
            ghosts.forEach(ghost => {
                const x = ghost.x * TILE_SIZE + TILE_SIZE / 2;
                const y = ghost.y * TILE_SIZE + TILE_SIZE / 2;
                const radius = TILE_SIZE / 2 - 2;
                
                // Warna berdasarkan status (Biru tua saat ketakutan)
                const color = ghost.isFrightened ? 'blue' : ghost.color;
                
                ctx.fillStyle = color;
                
                // Badan Hantu (Setengah lingkaran + kotak)
                ctx.beginPath();
                ctx.arc(x, y - 2, radius, Math.PI, 0, false); // Bagian atas (setengah lingkaran)
                ctx.lineTo(x + radius, y + radius); // Sisi Kanan
                
                // Kaki/Gigi Gergaji (Simulasi Rok Hantu)
                const footSize = TILE_SIZE / 5;
                for (let i = -radius; i < radius; i += footSize * 2) {
                    ctx.lineTo(x + i + footSize, y + radius);
                    ctx.lineTo(x + i, y + radius - footSize / 2); // Naik sedikit
                }
                
                ctx.lineTo(x - radius, y + radius); // Sisi Kiri
                ctx.closePath();
                ctx.fill();
                
                // Mata (Putih)
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(x - 5, y - 5, 3, 0, 2 * Math.PI);
                ctx.arc(x + 5, y - 5, 3, 0, 2 * Math.PI);
                ctx.fill();
                
                // Pupil (Hitam/Merah - Berubah saat ketakutan)
                ctx.fillStyle = ghost.isFrightened ? 'black' : 'red';
                ctx.beginPath();
                ctx.arc(x - 5, y - 5, 1, 0, 2 * Math.PI);
                ctx.arc(x + 5, y - 5, 1, 0, 2 * Math.PI);
                ctx.fill();
            });
        }

        function drawGame() {
            // Hapus Kanvas
            ctx.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
            
            // Gambar Maze, Dots, Pellets
            drawMaze();
            
            // Gambar Hantu
            drawGhosts();
            
            // Gambar Pemain
            drawPlayer();

            // Loop Gambar
            if (gameRunning) {
                gameLoopId = requestAnimationFrame(drawGame);
            }
        }

        // --- INPUT HANDLING ---
        function handleMovement(direction) {
            nextDirection = direction;
        }
        window.handleMovement = handleMovement;

        function stopMovement() {
            // Untuk D-Pad sentuh, biarkan nextDirection tetap, hanya currentDirection yang penting di gameLoop
        }
        window.stopMovement = stopMovement;
        
        function handleKeyDown(e) {
            if (!gameRunning) return;
            let dir = nextDirection;
            
            if (e.key === 'ArrowUp') dir = 'up';
            else if (e.key === 'ArrowDown') dir = 'down';
            else if (e.key === 'ArrowLeft') dir = 'left';
            else if (e.key === 'ArrowRight') dir = 'right';

            handleMovement(dir);
        }
        window.handleKeyDown = handleKeyDown;

        function handleKeyUp(e) {
            // Untuk skema Pac-Man, tidak perlu logika key up
        }
        window.handleKeyUp = handleKeyUp;
        
        // --- EVENT LISTENERS UI ---
        
        startGameBtn.addEventListener('click', () => {
            switchToScreen('gameScreen');
            initGame();
        });

        backMenuButton.addEventListener('click', () => {
            switchToScreen('startScreen');
            updateFirebaseStatusUI("KONEKSI BERHASIL", `ID Pemain: ${displayName} (${userId ? userId.substring(0, 8) + '...' : 'Anonim'})`, true);
            stopGameLoop();
        });

        async function showLeaderboardModal() {
            document.getElementById('leaderboardModal').style.display = 'flex';
            window.fetchLeaderboard(); 
        }
        window.showLeaderboardModal = showLeaderboardModal;
        
        // Listener untuk Keyboard (untuk PC)
        document.addEventListener('keydown', handleKeyDown);
        document.addEventListener('keyup', handleKeyUp);


        // --- INISIALISASI AKHIR ---
        // Panggil inisialisasi setelah semua skrip eksternal dan DOM dimuat
        window.onload = initializeFirebase;
        updateConnectButtonUI(false); 
        
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Somnia Christmas ‚Äî Pacman</title>

<script src="libs/ethers.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:Trebuchet MS,sans-serif;}
body{height:100vh;background:linear-gradient(to right,#fff,#ff0000);color:#fff;overflow:hidden;display:flex;flex-direction:column;}
#wrap{display:flex;flex:1;width:100%;}
#sidebar{width:160px;background:#fff;color:#000;padding:12px;display:flex;flex-direction:column;gap:10px;flex-shrink:0;}
#main{flex:1;padding:10px;display:flex;flex-direction:column;align-items:center;background:linear-gradient(to bottom,#ff0000,#800000);position:relative;}
button{padding:10px;border-radius:8px;border:none;background:linear-gradient(90deg,red,green);color:#fff;cursor:pointer;font-weight:bold;}
#title{color:#00ffae;font-size:26px;margin-bottom:10px;}
.footer{margin-top:10px;color:#0ff;text-shadow:0 0 4px #0ff;font-size:12px;}
.content-area{width:100%;max-width:480px;flex:1;background:rgba(0,0,0,0.25);border-radius:12px;overflow:hidden;position:relative;min-height:300px;margin-bottom:10px;}
iframe{width:100%;height:100%;border:0;display:none;}
#logoPlaceholder{width:100%;height:100%;position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.25),rgba(255,255,255,0.02));}
#logoPlaceholder img{width:100%;height:100%;object-fit:cover;}
#poster-overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;align-items:center;text-align:center;padding:20px;text-shadow:0 0 5px black;pointer-events:none;}
.overlay-cta{padding:12px 30px;font-size:1.1em;font-weight:bold;border-radius:8px;pointer-events:auto;cursor:pointer;}
@media(max-width:768px){
  #wrap{flex-direction:column;}
  #sidebar{width:100%;flex-direction:row;justify-content:space-around;flex-wrap:wrap;padding:8px 10px;gap:4px;}
  #walletAddr,#walletBal{display:block;font-size:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin:0 4px;}
  #btnConnect,#btnPlay,#btnLeaderboard{padding:6px 10px;font-size:12px;}
  #main{flex:1;}
}
</style>
</head>
<body>
<div id="wrap">
  <div id="sidebar">
    <button id="btnConnect">Connect Wallet</button>
    <button id="btnHome">Home</button>
    <div style="display:flex;flex-direction:column;justify-content:center;flex-shrink:0;">
      <div id="walletAddr" title="Wallet address">Wallet: -</div>
      <div id="walletBal" title="Native balance">SOMI: -</div>
    </div>
    <button id="btnPlay">Play Game</button>
    <button id="btnLeaderboard">Leaderboard</button>
  </div>

  <div id="main">
    <div id="title">‚òÉÔ∏è SOMNIA CHRISTMAS CARNIVAL üéÑ</div>
    <div id="topScoreSummary" style="color:#fff;padding:10px;margin-bottom:12px;border-radius:6px;background:rgba(0,0,0,0.4);width:100%;max-width:480px;text-align:center;">
      üí∞ <b>Jackpot:</b> <span id="poolValue">0.00 SOMI</span> |
      üèÜ <b>Top:</b> <span id="topScoreValue">0</span>
    </div>

    <div class="content-area">
      <div id="logoPlaceholder">
        <img id="posterImg" src="assets/logo1.png" alt="Somnia Logo">
        <div id="poster-overlay">
          <div style="margin-top:8px;">
            <h2>SOMNIA CHRISTMAS!</h2>
            <p>Main & menangkan Jackpot Natal üéÅ</p>
          </div>
          <div style="margin-bottom:8px;">
            <button id="overlayStart" class="overlay-cta">Mulai</button>
          </div>
        </div>
      </div>
      <iframe id="gameFrame" src="./pacman/pacman_xmas.html" title="Pacman Game"></iframe>
      <iframe id="leaderFrame" src="leaderboard.html" title="Leaderboard"></iframe>
    </div>

    <div class="footer">created by: ifunkkalem | @Ifunkkalem91</div>
  </div>
</div>

<script>
const btnConnect = document.getElementById('btnConnect');
const btnPlay = document.getElementById('btnPlay');
const btnLeaderboard = document.getElementById('btnLeaderboard');
const btnHome = document.getElementById('btnHome');
const walletAddrEl = document.getElementById('walletAddr'); // Menggunakan El untuk konsistensi
const walletBalEl = document.getElementById('walletBal'); // Menggunakan El untuk konsistensi
const gameFrame = document.getElementById('gameFrame');
const leaderFrame = document.getElementById('leaderFrame');
const logoPlaceholder = document.getElementById('logoPlaceholder');
const overlayStart = document.getElementById('overlayStart');
const posterImg = document.getElementById('posterImg');

// Fungsi untuk menampilkan pesan "Waiting/Loading" (Hilangkan agar tidak mengganggu UI)
function showWaitingFeedback(message = 'Requesting... check wallet.'){
  const existingWaiting = document.getElementById('__waiting_req');
  if(existingWaiting) existingWaiting.remove();
  
  const gm = document.createElement('div');
  gm.id = '__waiting_req';
  gm.style.position='fixed';¬†
  gm.style.left='50%';
  gm.style.top='8px';
  gm.style.transform='translateX(-50%)';
  gm.style.background='rgba(0,0,0,0.8)';
  gm.style.color='#fff';
  gm.style.padding='6px 12px';
  gm.style.borderRadius='8px';
  gm.style.zIndex='999';
  gm.textContent = message;
  document.body.appendChild(gm);
  setTimeout(()=> { const w = document.getElementById('__waiting_req'); if(w) w.remove(); }, 8000);
}

// Hapus pesan waiting
function clearWaitingFeedback(){
  const w = document.getElementById('__waiting_req'); 
  if(w) w.remove();
}


function showMain(id){
¬† logoPlaceholder.style.display='none';
¬† gameFrame.style.display='none';
¬† leaderFrame.style.display='none';
¬† const el=document.getElementById(id);
¬† if(el) el.style.display='block';
}

function requestStartGame(){
  showWaitingFeedback('Requesting game start...');
¬† window.postMessage({ type: 'requestStartGame' }, '*');
}

btnPlay.addEventListener('click', ev=>{
¬† ev.preventDefault();
¬† requestStartGame();
});
overlayStart.addEventListener('click', ev=>{
¬† ev.preventDefault();
¬† requestStartGame();
});
btnHome.addEventListener('click', ()=>{ showMain('logoPlaceholder'); });
btnLeaderboard.addEventListener('click', ()=>{
¬† leaderFrame.src="leaderboard.html?"+Date.now();
¬† showMain('leaderFrame');
});
btnConnect.addEventListener('click', ()=>{
  showWaitingFeedback('Requesting wallet connection...');
¬† window.postMessage({ type: 'requestConnectWallet' }, '*');
});

// Listener pesan dari app.js dan iframe game
window.addEventListener("message", async (ev)=>{
¬† const d=ev.data||{};
¬† if(!d||typeof d!=="object") return;
¬† 
  // Penanganan feedback waiting
  if(d.type === 'showWaiting'){
    showWaitingFeedback(d.message || 'Processing transaction...');
  }
  if(d.type === 'clearWaiting'){
    clearWaitingFeedback();
  }

¬† // >>> PERBAIKAN UTAMA: Penanganan Wallet Info <<<
¬† if(d.type==="walletInfo"){
    clearWaitingFeedback(); // Clear waiting setelah status didapat
¬† ¬† if(d.address){
¬† ¬† ¬† walletAddrEl.textContent='Wallet: '+d.address.substring(0,6)+'...'+d.address.slice(-4);
¬† ¬† ¬† walletAddrEl.title=d.address;
¬† ¬† } else {
      walletAddrEl.textContent='Wallet: -'; // Pastikan kembali ke default jika terputus
    }
¬† ¬† if(typeof d.balance !== 'undefined'){
      walletBalEl.textContent = d.balance + " SOMI";
¬† ¬† ¬† walletBalEl.title = d.balance + " SOMI";
¬† ¬† } else {
      walletBalEl.textContent = 'SOMI: -';
    }
¬† }
¬† 
  // Penanganan Sukses Bayar
¬† if(d.type==="paySuccess"){ 
    clearWaitingFeedback();
    showMain('gameFrame'); 
  }

¬† // Penanganan Summary (Jackpot/Top Score)
¬† if(d.type==="updateSummary"){
¬† ¬† const poolEl=document.getElementById('poolValue');
¬† ¬† const scoreEl=document.getElementById('topScoreValue');
¬† ¬† if(d.jackpot&&poolEl) poolEl.textContent=d.jackpot+' SOMI';
¬† ¬† if(d.topScore&&scoreEl) scoreEl.textContent=d.topScore;
¬† }
  
  // Penanganan Navigasi
¬† if(d.type==="showLeaderboard"){
¬† ¬† leaderFrame.src="leaderboard.html?"+Date.now();
¬† ¬† showMain('leaderFrame');
¬† }
¬† if(d.type==="playAgain"){ 
    requestStartGame(); 
  }
¬† if(d.type==="backToDashboard"){ 
    showMain('logoPlaceholder'); 
  }
});

posterImg.addEventListener('error', ()=>{ posterImg.src='assets/logo.png'; });
showMain('logoPlaceholder');
</script>
<script src="app.js"></script>
</body>
</html>

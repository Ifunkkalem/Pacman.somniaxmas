<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Somnia Christmas ‚Äî Pacman</title>

<script src="libs/ethers.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:Trebuchet MS,sans-serif;}
body{height:100vh;background:linear-gradient(to right,#fff,#ff0000);color:#fff;overflow:hidden;display:flex;flex-direction:column;}
#wrap{display:flex;flex:1;width:100%;}
#sidebar{width:160px;background:#fff;color:#000;padding:12px;display:flex;flex-direction:column;gap:10px;flex-shrink:0;}
#main{flex:1;padding:10px;display:flex;flex-direction:column;align-items:center;background:linear-gradient(to bottom,#ff0000,#800000);position:relative;}
button{padding:10px;border-radius:8px;border:none;background:linear-gradient(90deg,red,green);color:#fff;cursor:pointer;font-weight:bold;}
#title{color:#00ffae;font-size:26px;margin-bottom:10px;}
.footer{margin-top:10px;color:#0ff;text-shadow:0 0 4px #0ff;font-size:12px;}
.content-area{width:100%;max-width:480px;flex:1;background:rgba(0,0,0,0.25);border-radius:12px;overflow:hidden;position:relative;min-height:300px;margin-bottom:10px;}
iframe{width:100%;height:100%;border:0;display:none;}
#logoPlaceholder{width:100%;height:100%;position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(0,0,0,0.25),rgba(255,255,255,0.02));}
#logoPlaceholder img{width:100%;height:100%;object-fit:cover;}
#poster-overlay{position:absolute;inset:0;display:flex;flex-direction:column;justify-content:space-between;align-items:center;text-align:center;padding:20px;text-shadow:0 0 5px black;pointer-events:none;}
.overlay-cta{padding:12px 30px;font-size:1.1em;font-weight:bold;border-radius:8px;pointer-events:auto;cursor:pointer;}
@media(max-width:768px){
  #wrap{flex-direction:column;}
  #sidebar{width:100%;flex-direction:row;justify-content:space-around;flex-wrap:wrap;padding:8px 10px;gap:4px;}
  #walletAddr,#walletBal{display:block;font-size:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin:0 4px;}
  #btnConnect,#btnPlay,#btnLeaderboard{padding:6px 10px;font-size:12px;}
  #main{flex:1;}
}
</style>
</head>
<body>
<div id="wrap">
  <div id="sidebar">
    <button id="btnConnect">Connect Wallet</button>
    <button id="btnHome">Home</button>
    <div style="display:flex;flex-direction:column;justify-content:center;flex-shrink:0;">
      <div id="walletAddr" title="Wallet address">Wallet: -</div>
      <div id="walletBal" title="Native balance">SOMI: -</div>
    </div>
    <button id="btnPlay">Play Game</button>
    <button id="btnLeaderboard">Leaderboard</button>
  </div>

  <div id="main">
    <div id="title">‚òÉÔ∏è SOMNIA CHRISTMAS CARNIVAL üéÑ</div>
    <div id="topScoreSummary" style="color:#fff;padding:10px;margin-bottom:12px;border-radius:6px;background:rgba(0,0,0,0.4);width:100%;max-width:480px;text-align:center;">
      üí∞ <b>Jackpot:</b> <span id="poolValue">0.00 SOMI</span> |
      üèÜ <b>Top:</b> <span id="topScoreValue">0</span>
    </div>

    <div class="content-area">
      <div id="logoPlaceholder">
        <img id="posterImg" src="assets/logo1.png" alt="Somnia Logo">
        <div id="poster-overlay">
          <div style="margin-top:8px;">
            <h2>SOMNIA CHRISTMAS!</h2>
            <p>Main & menangkan Jackpot Natal üéÅ</p>
          </div>
          <div style="margin-bottom:8px;">
            <button id="overlayStart" class="overlay-cta">Mulai</button>
          </div>
        </div>
      </div>
      <iframe id="gameFrame" src="./pacman/pacman_xmas.html" title="Pacman Game"></iframe>
      <iframe id="leaderFrame" src="leaderboard.html" title="Leaderboard"></iframe>
    </div>

    <div class="footer">created by: ifunkkalem | @Ifunkkalem91</div>
  </div>
</div>

<script>
const btnConnect = document.getElementById('btnConnect');
const btnPlay = document.getElementById('btnPlay');
const btnLeaderboard = document.getElementById('btnLeaderboard');
const btnHome = document.getElementById('btnHome');
const walletAddrEl = document.getElementById('walletAddr');
const walletBalEl = document.getElementById('walletBal');
const gameFrame = document.getElementById('gameFrame');
const leaderFrame = document.getElementById('leaderFrame');
const logoPlaceholder = document.getElementById('logoPlaceholder');
const overlayStart = document.getElementById('overlayStart');
const posterImg = document.getElementById('posterImg');

/* --- FEEDBACK UI --- */
function showWaitingFeedback(message = 'Requesting... check wallet.'){
    const existingWaiting = document.getElementById('__waiting_req');
    if(existingWaiting) existingWaiting.remove();
    const gm = document.createElement('div');
    gm.id = '__waiting_req';
    gm.style.cssText = 'position:fixed; left:50%; top:8px; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:#fff; padding:6px 12px; border-radius:8px; z-index:999; border: 1px solid #fbbf24;';
    gm.textContent = message;
    document.body.appendChild(gm);
}

function clearWaitingFeedback(){
    const w = document.getElementById('__waiting_req'); 
    if(w) w.remove();
}

function showMain(id){
    logoPlaceholder.style.display='none';
    gameFrame.style.display='none';
    leaderFrame.style.display='none';
    const el=document.getElementById(id);
    if(el) el.style.display='block';
}

/* --- ACTION TRIGGERS --- */
async function triggerConnect() {
    showWaitingFeedback('Membuka Wallet...');
    // Memanggil fungsi langsung di app.js
    if (typeof connectWallet === 'function') {
        await connectWallet();
    } else {
        window.postMessage({ type: 'requestConnectWallet' }, '*');
    }
}

async function triggerStartGame() {
    showWaitingFeedback('Menyiapkan Transaksi...');
    // Memanggil fungsi langsung di app.js
    if (typeof payToPlay === 'function') {
        await payToPlay();
    } else {
        window.postMessage({ type: 'requestStartGame' }, '*');
    }
}

/* --- EVENT LISTENERS --- */
btnConnect.addEventListener('click', triggerConnect);
btnPlay.addEventListener('click', triggerStartGame);
overlayStart.addEventListener('click', triggerStartGame);
btnHome.addEventListener('click', () => showMain('logoPlaceholder'));
btnLeaderboard.addEventListener('click', () => {
    leaderFrame.src = "leaderboard.html?" + Date.now();
    showMain('leaderFrame');
});

/* --- MESSAGE HUB (SINKRONISASI) --- */
window.addEventListener("message", (ev) => {
    const d = ev.data || {};
    
    // 1. Handle UI Feedback dari app.js
    if(d.type === 'showWaiting'){ showWaitingFeedback(d.message); }
    if(d.type === 'clearWaiting'){ clearWaitingFeedback(); }

    // 2. Update Informasi Wallet
    if(d.type === "walletInfo"){
        clearWaitingFeedback();
        walletAddrEl.textContent = d.address ? 'Addr: ' + d.address.substring(0,6) + '...' + d.address.slice(-4) : 'Wallet: -';
        walletBalEl.textContent = d.balance ? d.balance + " SOMI" : 'SOMI: -';
    }

    // 3. Handle Transaksi Sukses (PENTING!)
    if(d.type === "paySuccess"){ 
        clearWaitingFeedback();
        showMain('gameFrame'); 
        
        // Teruskan sinyal ke dalam IFRAME Pacman
        if(gameFrame && gameFrame.contentWindow){
            // Gunakan sedikit delay agar iframe siap menerima
            setTimeout(() => {
                gameFrame.contentWindow.postMessage({ type: 'initAudio' }, '*');
                gameFrame.contentWindow.postMessage({ type: 'paySuccess' }, '*');
                console.log("Sinyal permainan dikirim ke Pacman");
            }, 800);
        }
    }

    // 4. Update Global Jackpot & Score
    if(d.type === "updateSummary"){
        if(d.jackpot) document.getElementById('poolValue').textContent = d.jackpot + ' SOMI';
        if(d.topScore) document.getElementById('topScoreValue').textContent = d.topScore;
    }
    
    if(d.type === "showLeaderboard"){
        leaderFrame.src = "leaderboard.html?" + Date.now();
        showMain('leaderFrame');
    }
});

posterImg.addEventListener('error', ()=>{ posterImg.src='assets/logo.png'; });
showMain('logoPlaceholder');
</script>
<script src="app.js"></script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Somnia Halloween - Pacman Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- ETHERS.JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900;800;300&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { width: 100vw; height: 100vh; overflow: hidden; background: radial-gradient(circle at top, #2b0033, #0a0010); color: #fff; display: flex; justify-content: center; align-items: center; }
    .bubble { position: absolute; bottom: -100px; background: rgba(255, 140, 0, 0.2); border-radius: 50%; animation: floatUp 12s infinite ease-in; }
    @keyframes floatUp { from { transform: translateY(0); } to { transform: translateY(-120vh); } }
    .screen { z-index: 10; position: relative; text-align: center; padding: 20px; }
    h1 { font-size: clamp(30px, 6vw, 42px); color: #ff8c00; text-shadow: 0 0 10px #800080, 0 0 20px #800080; margin-bottom: 8px; }
    h2 { font-size: clamp(18px, 3vw, 22px); color: #c77dff; margin-bottom: 30px; }
    .menu-box { background: rgba(20, 0, 30, 0.8); border: 2px solid #ff8c00; border-radius: 16px; padding: 30px 40px; box-shadow: 0 0 20px #800080; min-width: 300px; max-width: 90%; }
    .menu-box input { width: 100%; padding: 10px; border-radius: 8px; border: none; margin-bottom: 12px; text-align: center; font-size: 16px; outline: none; background-color: #333; color: white; }
    .menu-box button { width: 100%; padding: 12px; margin: 8px 0; font-size: 16px; font-weight: bold; border: none; border-radius: 10px; cursor: pointer; background: linear-gradient(90deg, #ff8c00, #800080); color: white; transition: 0.2s; }
    .menu-box button:hover:not(:disabled) { transform: scale(1.03); box-shadow: 0 0 15px #ff8c00; }
    .menu-box button:disabled { background: #444; cursor: not-allowed; opacity: 0.7; box-shadow: none; transform: scale(1); }
    .wallet-box { font-size: 14px; margin-bottom: 12px; color: #ffb703; word-break: break-all; }
    .hidden { display: none !important; }
    #menuTxStatus { margin-top: 10px; color: yellow; font-size: 0.9em; }
  </style>
</head>
<body>

<script>
  for (let i = 0; i < 25; i++) {
    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.style.width = bubble.style.height = Math.random() * 40 + 20 + "px";
    bubble.style.left = Math.random() * 100 + "vw";
    bubble.style.animationDuration = Math.random() * 6 + 6 + "s";
    document.body.appendChild(bubble);
  }
</script>

<div id="menuScreen" class="screen">
  <h1>WELCOME SOMNIA HALLOWEEN</h1>
  <h2>PAC-MAN EDITION</h2>

  <div class="menu-box">
    <div id="walletStatus" class="wallet-box">Memuat Status Database & Wallet...</div>
    <input id="displayNameInput" type="text" maxlength="12" placeholder="Loading Profile..." disabled />
    <button id="connectWalletBtn" disabled>CONNECT WALLET</button>
    <button id="saveNameBtn" disabled>SAVE DISPLAY NAME</button>
    <div style="height: 1px; background: rgba(255, 255, 255, 0.1); margin: 15px 0;"></div>
    <button id="playBtn" disabled>PLAY (Redirect to Game)</button>
    <button id="leaderboardBtn">LEADERBOARD</button>
    <div id="menuTxStatus"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // -----------------------
  // Firebase Config
  // -----------------------
  const firebaseConfig = {
    apiKey: "AIzaSyBeHjlHJSB5R0mYJmX6h5uJ7Iwqu7zNWtA",
    authDomain: "somnia-hallowen.firebaseapp.com",
    projectId: "somnia-hallowen",
    storageBucket: "somnia-hallowen.firebasestorage.app",
    messagingSenderId: "441297353260",
    appId: "1:441297353260:web:71343e500055d10c712f89"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  let userId = null;
  let walletAddress = null;
  let firebaseReady = false;
  let nameLoaded = false;

  const displayNameInput = document.getElementById('displayNameInput');
  const connectWalletBtn = document.getElementById('connectWalletBtn');
  const saveNameBtn = document.getElementById('saveNameBtn');
  const playBtn = document.getElementById('playBtn');
  const walletStatusEl = document.getElementById('walletStatus');
  const menuTxStatusEl = document.getElementById('menuTxStatus');

  function formatWallet(address) {
    if (!address) return 'Disconnected';
    return `${address.substring(0,6)}...${address.slice(-4)}`;
  }

  function updateUI() {
    const connected = walletAddress !== null;
    const nameValid = displayNameInput.value.trim().length > 0 && displayNameInput.value.trim().length <= 12;
    const isReady = firebaseReady && nameLoaded;

    if (!isReady) {
      walletStatusEl.innerHTML = `Status: Connecting to Firebase... <br> Wallet: ${formatWallet(walletAddress)}`;
    } else {
      walletStatusEl.innerHTML = `Wallet Status: <span style="color: #ffb703;">Connected</span> <br> Address: ${walletAddress || 'Harap Hubungkan Wallet'}`;
    }

    connectWalletBtn.disabled = !firebaseReady || connected;
    displayNameInput.disabled = !firebaseReady || !connected;
    saveNameBtn.disabled = !firebaseReady || !connected || !nameValid;
    playBtn.disabled = !(firebaseReady && connected && nameValid);
  }

  async function loadUserData() {
    if (!db || !userId) {
      nameLoaded = true;
      updateUI();
      return;
    }

    const docRef = doc(db, 'users', userId);
    try {
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
        const data = docSnap.data();
        displayNameInput.value = data.displayName || '';
        walletAddress = data.wallet || null;
      }
      nameLoaded = true;
    } catch(e) {
      console.error("Error loading profile:", e);
      nameLoaded = true;
    } finally {
      updateUI();
    }
  }

  async function initFirebaseAuth() {
    try {
      const userCredential = await signInAnonymously(auth);
      userId = userCredential.user.uid;
      firebaseReady = true;
      updateUI();
      await loadUserData();
      connectWalletBtn.disabled = false;
    } catch (error) {
      console.error("Firebase Auth Failed:", error);
      walletStatusEl.innerHTML = "Firebase Auth Failed ⚠️ <br> Check Console";
    }
  }

  initFirebaseAuth();

  // -----------------------
  // Connect Wallet
  // -----------------------
  async function connectWallet() {
    if (!window.ethereum) {
      menuTxStatusEl.textContent = "Web3 (MetaMask) tidak terdeteksi.";
      return;
    }
    try {
      const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
      walletAddress = accounts[0];
      menuTxStatusEl.textContent = `Wallet terhubung: ${formatWallet(walletAddress)}`;

      if (db && userId) {
        await setDoc(doc(db, 'users', userId), {
          wallet: walletAddress,
          lastConnect: Date.now()
        }, { merge: true });
      }
    } catch (error) {
      console.error("Error connecting wallet:", error);
      menuTxStatusEl.textContent = "Koneksi dompet dibatalkan atau gagal.";
    }
    updateUI();
  }

  // -----------------------
  // Save Display Name
  // -----------------------
  async function saveDisplayName() {
    const name = displayNameInput.value.trim();
    if (name.length < 1 || name.length > 12) {
      menuTxStatusEl.textContent = "Nama harus 1-12 karakter.";
      return;
    }
    if (!walletAddress) {
      menuTxStatusEl.textContent = "Harap hubungkan Wallet terlebih dahulu.";
      return;
    }
    if (!db || !userId) {
      menuTxStatusEl.textContent = "Database tidak siap.";
      return;
    }

    saveNameBtn.disabled = true;
    saveNameBtn.textContent = "Saving...";
    try {
      await setDoc(doc(db, 'users', userId), {
        displayName: name,
        wallet: walletAddress,
        lastUpdate: Date.now()
      }, { merge: true });
      menuTxStatusEl.textContent = "Nama berhasil disimpan!";
    } catch(e) {
      console.error("Error saving name:", e);
      menuTxStatusEl.textContent = "Gagal menyimpan nama.";
    }
    saveNameBtn.textContent = "SAVE DISPLAY NAME";
    updateUI();
  }

  // -----------------------
  // Redirect Handlers
  // -----------------------
  function redirectToGame() { window.location.href = 'game.html'; }
  function redirectToLeaderboard() { window.location.href = 'leaderboard.html'; }

  // -----------------------
  // Event Listeners
  // -----------------------
  connectWalletBtn.addEventListener('click', connectWallet);
  saveNameBtn.addEventListener('click', saveDisplayName);
  displayNameInput.addEventListener('input', updateUI);
  playBtn.addEventListener('click', redirectToGame);
  document.getElementById('leaderboardBtn').addEventListener('click', redirectToLeaderboard);

  updateUI();

</script>

</body>
</html>

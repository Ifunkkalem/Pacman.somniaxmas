<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pacman XMAS - Classic Mode</title>
<style>
/* CSS LENGKAP UNTUK IFRAME GAME */
  html,body{
    margin:0; background:#000; height:100%; min-height:100vh;
    display:flex; justify-content:center; align-items:flex-start;
    font-family:Arial, Helvetica, sans-serif; padding:12px; box-sizing:border-box;
  }
  #gameWrapper{
    width: calc(20 * 20px + 40px); max-width: 92vw; display:flex;
    flex-direction:column; align-items:center; gap:12px; position: relative;
  }
  canvas{
    background:#020617; border-radius:10px; display:block;
    box-shadow: 0 8px 24px rgba(0,0,0,0.6); image-rendering: optimizeSpeed;
  }
  #ui{
    position:relative; color:#fff; z-index:2; align-self:flex-start;
    display:flex; justify-content:space-between; width:100%; margin-bottom: -10px;
  }
  #time-display-wrapper { font-weight: bold; color: #00ffae; text-shadow: 0 0 3px black; }
  #game-message{
    color:white; background:rgba(0,0,0,.8); padding:10px 15px; border-radius:8px;
    display:none; z-index:12; position:absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%); text-align: center;
  }
  #mobileControls{
    position:relative; margin-top:6px; display:flex; flex-direction:column;
    align-items:center; gap:8px; user-select:none; -webkit-tap-highlight-color: transparent;
  }
  #mobileControls button{
    width: 70px; height: 70px; border-radius:10px;border:0;
    background:linear-gradient(90deg,#cc0000,#16a34a);color:#fff;font-size:22px;
    display:inline-flex;align-items:center;justify-content:center;
    box-shadow:0 4px rgba(0,0,0,0.4); touch-action: manipulation;
  }
  .dpad-row{display:flex;align-items:center;gap:8px}
  .center-filler{width: 70px; height: 70px;}
  @media(min-width:900px){
    body{align-items:center}
    #gameWrapper{max-width:760px}
    #mobileControls{display:none}
  }
  @media(max-width:480px){
    #gameWrapper{ width: 90vw; }
  }
</style>
</head>

<body>
  <div id="gameWrapper">
    <div id="ui">
        <div>Score: <span id="current-score-display">0</span></div>
        <div id="game-info">
            <span id="time-display-wrapper" style="margin-right: 15px; display: none;">Time: <span id="time-display">0</span>s</span>
            <span>Lives: <span id="lives-display">1</span></span>
        </div>
    </div>
    <div id="game-message"></div>

    <canvas id="pacman-canvas" aria-label="Pacman XMAS game"></canvas>

    <div id="mobileControls" aria-hidden="false">
      <button data-dir="up" id="btn-up">↑</button>
      <div class="dpad-row">
        <button data-dir="left" id="btn-left">←</button>
        <div class="center-filler" aria-hidden="true"></div>
        <button data-dir="right" id="btn-right">→</button>
      </div>
      <button data-dir="down" id="btn-down">↓</button>
    </div>
  </div>

<script>
(() => {
const canvas = document.getElementById("pacman-canvas");
const ctx = canvas.getContext("2d");
const TILE = 20;
const $ = (id) => document.getElementById(id);

/* ================== KONFIGURASI MODE INI ================== */
const GAME_MODE = 'Classic';
const SCORE_MULTIPLIER = 1;
const TIME_LIMIT = null; 
const PLAYER_LIVES_INITIAL = 1; 

// MAP CLASSIC (Mudah: Banyak ruang terbuka) - Start: (1,1)
const GAME_MAP_DATA = [
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,1],
  [1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
  [1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
  [1,1,1,1,1,2,1,1,1,0,0,1,1,1,2,1,1,1,1,1],
  [0,0,0,0,1,2,1,0,0,0,0,0,0,1,2,1,0,0,0,0],
  [1,1,1,1,1,2,1,0,1,1,1,1,0,1,2,1,1,1,1,1],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
  [1,2,1,1,1,2,1,1,1,1,1,1,1,1,2,1,1,1,2,1],
  [1,2,2,2,1,2,2,2,2,1,1,2,2,2,2,1,2,2,2,1],
  [1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

// AI Classic: Paling Dasar/Acak
function getGhostAi(ghostIndex) {
    return 'RANDOM_SIMPLE'; 
}

/* ================== LOGIKA GAME INTI LENGKAP ================== */

let mapData, pacman, ghosts, score = 0, playerLives;
let MAP_W, MAP_H; 
let gameRunning = false;
let ghostActive = false;
const MOVE_INTERVAL = 240; // Kecepatan pergerakan (ms)
let gameTimer = null; 
let gameTimeRemaining = null; 
let isSubmissionSent = false;
let lastMove = 0;

// Fungsi utilitas
function isMoveValid(x, y, dir, map) {
    let nextX = x, nextY = y;
    if (dir === 'up') nextY--;
    else if (dir === 'down') nextY++;
    else if (dir === 'left') nextX--;
    else if (dir === 'right') nextX++;
    
    // Teleportation logic
    if (nextX < 0) nextX = map[0].length - 1;
    if (nextX >= map[0].length) nextX = 0;

    // Pastikan batas array tidak dilanggar
    if (!map[nextY]) return false;

    return map[nextY][nextX] !== 1; // 1 adalah dinding
}
function getOppositeDirection(dir) {
    if (dir === 'up') return 'down';
    if (dir === 'down') return 'up';
    if (dir === 'left') return 'right';
    if (dir === 'right') return 'left';
    return '';
}

// UI Updaters
function updateScoreDisplay() {
    $("#current-score-display").textContent = score;
}
function updateLivesDisplay() {
    $("#lives-display").textContent = playerLives;
}
function updateTimerDisplay(time) {
    if (TIME_LIMIT) {
        $("#time-display-wrapper").style.display = "inline";
        $("#time-display").textContent = time;
    } else {
        $("#time-display-wrapper").style.display = "none";
    }
}
function clearGameTimer() {
    if (gameTimer) {
        clearInterval(gameTimer);
        gameTimer = null;
    }
}
function startGameTimer(seconds) {
    gameTimeRemaining = seconds;
    updateTimerDisplay(gameTimeRemaining);
    clearGameTimer();
    gameTimer = setInterval(() => {
        gameTimeRemaining--;
        updateTimerDisplay(gameTimeRemaining);
        if (gameTimeRemaining <= 0) {
            clearGameTimer();
            playerLives = 0; 
            gameOver(); 
        }
    }, 1000);
}


// Init Game State
function resetGame(){
    mapData = GAME_MAP_DATA.map(r=>[...r]); // Clone map
    MAP_H = mapData.length;
    MAP_W = mapData[0].length;
    canvas.width = MAP_W * TILE;
    canvas.height = MAP_H * TILE;
    
    playerLives = PLAYER_LIVES_INITIAL;
    score = 0;
    isSubmissionSent = false; 
    
    // Start di (1,1)
    pacman = {x:1,y:1,dir:"right",next:"right"};
    // Ghost start di tengah peta
    ghosts = [
      {x:9,y:9,dir:"up",color:"#ff0033", ai: getGhostAi(0)},
      {x:10,y:9,dir:"down",color:"#00b300", ai: getGhostAi(1)},
      {x:8,y:9,dir:"left",color:"#1e90ff", ai: getGhostAi(2)}
    ];
    
    $("#game-message").style.display = "none";
    gameRunning = false;
    ghostActive = false;
    
    updateScoreDisplay();
    updateLivesDisplay();
    updateTimerDisplay(0);
}


// Logic AI Ghost
function determineGhostDirection(ghost, pacman, mapData) {
    const aiType = ghost.ai;
    
    if (aiType === 'RANDOM_SIMPLE') {
        const possibleMoves = ['up', 'down', 'left', 'right'].filter(d => isMoveValid(ghost.x, ghost.y, d, mapData));
        const oppositeDir = getOppositeDirection(ghost.dir);
        const nonReverseMoves = possibleMoves.filter(d => d !== oppositeDir);
        
        if (nonReverseMoves.length > 0) {
            return nonReverseMoves[Math.floor(Math.random() * nonReverseMoves.length)];
        }
        return possibleMoves[0]; 
    } 
    return 'up';
}


// FUNGSI BARU: MENGGAMBAR SEMUA ELEMEN GAME
function drawGame() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // 1. Gambar Peta dan Dots
    for (let y = 0; y < MAP_H; y++) {
        for (let x = 0; x < MAP_W; x++) {
            const val = mapData[y][x];
            const px = x * TILE;
            const py = y * TILE;

            if (val === 1) { // Dinding (Wall)
                ctx.fillStyle = '#1e90ff';
                ctx.fillRect(px, py, TILE, TILE);
            } else if (val === 2) { // Dot (Makanan)
                ctx.fillStyle = '#ffffff';
                ctx.beginPath();
                ctx.arc(px + TILE / 2, py + TILE / 2, 3, 0, Math.PI * 2);
                ctx.fill();
            } else if (val === 3) { // Power Pellet (Power Pellet belum diimplementasi di map ini, tapi jaga-jaga)
                ctx.fillStyle = '#ffcc00';
                ctx.beginPath();
                ctx.arc(px + TILE / 2, py + TILE / 2, 6, 0, Math.PI * 2);
                ctx.fill();
            }
        }
    }

    // 2. Gambar Pacman (Simpel)
    if(pacman){
        ctx.fillStyle = '#ffff00';
        ctx.beginPath();
        ctx.arc(pacman.x * TILE + TILE / 2, pacman.y * TILE + TILE / 2, TILE / 2 - 2, 0, Math.PI * 2);
        ctx.fill();
    }
    
    // 3. Gambar Hantu (Simpel)
    ghosts.forEach(ghost => {
        const px = ghost.x * TILE + TILE / 2;
        const py = ghost.y * TILE + TILE / 2;
        
        ctx.fillStyle = ghost.color;
        ctx.beginPath();
        ctx.arc(px, py, TILE / 2 - 2, 0, Math.PI * 2);
        ctx.fill();
        
        // Mata
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.arc(px - 5, py - 5, 2, 0, Math.PI * 2);
        ctx.arc(px + 5, py - 5, 2, 0, Math.PI * 2);
        ctx.fill();
    });
}

function moveGhosts(){
    ghosts.forEach(ghost => {
        const newDir = determineGhostDirection(ghost, pacman, mapData);
        ghost.dir = newDir;
        
        if(isMoveValid(ghost.x, ghost.y, ghost.dir, mapData)){
            if (ghost.dir === 'up') ghost.y--;
            else if (ghost.dir === 'down') ghost.y++;
            else if (ghost.dir === 'left') ghost.x--;
            else if (ghost.dir === 'right') ghost.x++;
        }
    });
}

function checkCollision(){
    ghosts.forEach(ghost => {
        if (pacman.x === ghost.x && pacman.y === ghost.y) {
            playerLives--;
            updateLivesDisplay();
            
            if (playerLives <= 0) {
                gameOver();
            } else {
                // Reset posisi setelah ditabrak
                pacman = {x:1,y:1,dir:"right",next:"right"};
                ghosts.forEach(g => { g.x = (g.x > MAP_W / 2 ? 10 : 9); g.y = 9; });
            }
        }
    });
}

// FUNGSI BARU: PERGERAKAN PACMAN DAN MAKAN DOTS
function movePacman(){
    if (!gameRunning) return;
    
    // 1. Cek pergerakan selanjutnya (next)
    if(pacman.next && isMoveValid(pacman.x, pacman.y, pacman.next, mapData)){
        pacman.dir = pacman.next;
        pacman.next = null;
    }
    
    // 2. Cek pergerakan saat ini (dir)
    if(isMoveValid(pacman.x, pacman.y, pacman.dir, mapData)){
        if (pacman.dir === 'up') pacman.y--;
        else if (pacman.dir === 'down') pacman.y++;
        else if (pacman.dir === 'left') pacman.x--;
        else if (pacman.dir === 'right') pacman.x++;
        
        // 3. Cek Makanan (Dots) di posisi baru
        if(mapData[pacman.y][pacman.x] === 2){
            mapData[pacman.y][pacman.x] = 0; // Hilangkan dot
            score += 10;
            updateScoreDisplay();
        }
        
        // 4. Cek Kemenangan (Semua dot hilang?)
        if (!mapData.flat().includes(2)) {
            score += 500; 
            gameOver(); 
        }
    } else {
        // Berhenti jika menabrak dinding
    }
}


function gameOver(){
    gameRunning = false;
    clearGameTimer();
    if (isSubmissionSent) return; 

    const finalScore = score * SCORE_MULTIPLIER; 
    const gm = $("#game-message");
    gm.textContent = `GAME OVER! Final Score: ${finalScore} (x${SCORE_MULTIPLIER} - ${GAME_MODE} Mode)`;
    gm.style.display = "block";
    
    if (!isSubmissionSent) {
        parent.postMessage({ type: "submitScore", score: finalScore, modeName: GAME_MODE }, "*");
        isSubmissionSent = true;
    }
    
    setTimeout(() => {
        parent.postMessage({ type: "returnHome" }, "*");
    }, 4000);
}


function startCountdownAndPlay(){
    const gm = $("#game-message");
    let count = 3;
    gm.style.display = "block";
    gm.textContent = `READY! Mode: ${GAME_MODE}`;
    const t = setInterval(()=>{
        count--;
        if(count >= 0) gm.textContent = "READY " + count;
        if(count < 0){
            clearInterval(t);
            gm.style.display = "none";
            ghostActive = true;
            gameRunning = true;
            if (TIME_LIMIT) {
                startGameTimer(TIME_LIMIT);
            }
        }
    }, 1000);
}


// GAME LOOP UTAMA
let requestedAnimationFrameId; 
function loop(timestamp) {
    if (gameRunning) {
        if (timestamp - lastMove > MOVE_INTERVAL) {
            movePacman();
            if(ghostActive){
                moveGhosts();
                checkCollision(); 
            }
            lastMove = timestamp;
        }
    }
    drawGame();
    requestedAnimationFrameId = requestAnimationFrame(loop);
}

// HANDLER INPUT KEYBOARD/MOBILE
function handleInput(dir) {
    if (!gameRunning) return;
    pacman.next = dir;
}

// Input Keyboard (Desktop)
document.addEventListener('keydown', (e) => {
    let dir = null;
    if (e.key === 'ArrowUp' || e.key === 'w') dir = 'up';
    else if (e.key === 'ArrowDown' || e.key === 's') dir = 'down';
    else if (e.key === 'ArrowLeft' || e.key === 'a') dir = 'left';
    else if (e.key === 'ArrowRight' || e.key === 'd') dir = 'right';
    if(dir) handleInput(dir);
});

// Input Tombol Mobile (Sentuh)
document.getElementById('mobileControls').addEventListener('click', (e) => {
    const btn = e.target.closest('button');
    if (btn && btn.dataset.dir) {
        handleInput(btn.dataset.dir);
    }
});


/* ========== MESSAGE HANDLER (DARI APP.JS) ========== */
window.addEventListener("message", (e) => {
  const d = e.data || {};

  // Sinyal dari app.js saat transaksi sukses
  if(d.type === "paySuccess"){
    resetGame(); 
    startCountdownAndPlay();
    return;
  }
});


/* ========== STARTUP & GAME LOOP ========== */
document.addEventListener('DOMContentLoaded', () => {
    // Pastikan game loop dimulai saat DOM siap
    resetGame();
    requestedAnimationFrameId = requestAnimationFrame(loop); 
});

})();
</script>
</body>
</html>


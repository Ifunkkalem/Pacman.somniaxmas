<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pacman XMAS - Classic Mode</title>
<style>
/* CSS DARI V19 UNTUK STABILITAS TAMPILAN */
  html,body{
    margin:0; background:transparent; 
    height:100%; min-height:100vh;
    display:flex; justify-content:center; align-items:flex-start;
    font-family:Arial, Helvetica, sans-serif; padding:12px; box-sizing:border-box;
  }
  #gameWrapper{
    width: calc(20 * 20px + 40px); max-width: 92vw; display:flex;
    flex-direction:column; align-items:center; gap:12px; position: relative;
  }
  canvas{
    background:#071024; /* Latar Belakang Canvas */
    border-radius:10px; display:block;
    box-shadow: 0 8px 24px rgba(0,0,0,0.6); image-rendering: optimizeSpeed;
  }
  #ui{
    position:relative; color:#fff; z-index:2; align-self:flex-start;
    display:flex; justify-content:space-between; width:100%; margin-bottom: -10px;
  }
  #game-message{
    color:white; background:rgba(0,0,0,.8); padding:10px 15px; border-radius:8px;
    display:none; z-index:12; position:absolute; top: 50%; left: 50%;
    transform: translate(-50%, -50%); text-align: center;
  }
  /* STYLE UNTUK TOMBOL KONTROL TAMBAHAN */
  #control-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
    display: flex; justify-content: space-between; align-items: flex-start;
    padding: 5px; box-sizing: border-box;
  }
  #escape-button, #restart-button { /* Ubah #reset-button menjadi #restart-button */
    background: #ff0033; color: white; border: none; padding: 5px 10px;
    border-radius: 5px; cursor: pointer; font-size: 14px;
    z-index: 10;
  }
  #escape-button { display: none; } /* Default hidden */


  #mobileControls{
    position:relative; margin-top:6px; display:flex; flex-direction:column;
    align-items:center; gap:8px; user-select:none; -webkit-tap-highlight-color: transparent;
  }
  #mobileControls button{
    width: 70px; height: 70px; border-radius:10px;border:0;
    background:linear-gradient(90deg,#cc0000,#16a34a);color:#fff;font-size:22px;
    display:inline-flex;align-items:center;justify-content:center;
    box-shadow:0 4px rgba(0,0,0,0.4); touch-action: manipulation;
  }
  .dpad-row{display:flex;align-items:center;gap:8px}
  .center-filler{width: 70px; height: 70px;}
  @media(min-width:900px){
    body{align-items:center}
    #gameWrapper{max-width:760px}
    #mobileControls{display:none}
  }
  @media(max-width:480px){
    #gameWrapper{ width: 90vw; }
  }
</style>
</head>

<body>
  <div id="gameWrapper">
    <div id="ui">
        <div>Score: <span id="current-score-display">0</span></div>
        <div id="game-info">
            <span>Lives: <span id="lives-display">1</span></span>
        </div>
    </div>
    
    <div id="control-overlay">
        <button id="escape-button" onclick="handleReturnHome()">Kembali ke Menu</button>
        <button id="restart-button" onclick="handleGameRestart()">Restart Game</button>
    </div>
    
    <div id="game-message"></div>

    <canvas id="pacman-canvas" aria-label="Pacman XMAS game"></canvas>

    <div id="mobileControls" aria-hidden="false">
      <button data-dir="up" id="btn-up" ontouchstart="setPacmanDirection('up'); event.preventDefault();" onmousedown="setPacmanDirection('up')">↑</button>
      <div class="dpad-row">
        <button data-dir="left" id="btn-left" ontouchstart="setPacmanDirection('left'); event.preventDefault();" onmousedown="setPacmanDirection('left')">←</button>
        <div class="center-filler" aria-hidden="true"></div>
        <button data-dir="right" id="btn-right" ontouchstart="setPacmanDirection('right'); event.preventDefault();" onmousedown="setPacmanDirection('right')">→</button>
      </div>
      <button data-dir="down" id="btn-down" ontouchstart="setPacmanDirection('down'); event.preventDefault();" onmousedown="setPacmanDirection('down')">↓</button>
    </div>
  </div>

<script>
// PENTING: Deklarasikan fungsi ini secara global agar bisa dipanggil dari atribut HTML
function setPacmanDirection(dir) {
    if (typeof window.pacman !== 'undefined') {
        window.pacman.nextDir = dir;
    }
}
function handleReturnHome() {
    window.parent.postMessage({ type: 'returnHome' }, '*');
}
function handleGameRestart() {
    if (typeof window.gameRunning !== 'undefined' && !window.gameRunning) {
        window.resetGame();
        window.gameRunning = true;
        window.lastTime = performance.now();
    } else {
        window.resetGame();
        window.gameRunning = true;
        window.lastTime = performance.now();
    }
}
// Akhir dari fungsi global

(function(){
  const canvas = document.getElementById('pacman-canvas');
  const ctx = canvas ? canvas.getContext('2d') : null;
  const TILE_SIZE = 20;

  // Helper aman
  const $ = (id) => document.getElementById(id);

  const GAME_MAP = [
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    [1,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,1],
    [1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
    [1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
    [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
    [1,2,1,1,1,2,1,2,1,1,1,1,2,1,2,1,1,1,2,1],
    [1,2,2,2,2,2,1,2,2,2,2,2,2,1,2,2,2,2,2,1],
    [1,1,1,1,1,2,1,1,1,0,0,1,1,1,2,1,1,1,1,1],
    [0,0,0,0,1,2,1,0,0,0,0,0,0,1,2,1,0,0,0,0],
    [1,1,1,1,1,2,1,0,1,1,1,1,0,1,2,1,1,1,1,1],
    [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
    [1,2,1,1,1,2,1,1,1,1,1,1,1,1,2,1,1,1,2,1],
    [1,2,2,2,1,2,2,2,2,1,1,2,2,2,2,1,2,2,2,1],
    [1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1],
    [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
    [1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1],
    [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
    [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
  ];

  const MAP_WIDTH = GAME_MAP[0].length;
  const MAP_HEIGHT = GAME_MAP.length;
  
  let pacman;
  let ghosts;
  let score = 0;
  let playerLives = 1;
  let mapData = [];
  let animationFrameId = null;
  
  // Variabel yang dipindahkan ke window scope untuk akses global (handleGameRestart, setPacmanDirection)
  window.gameRunning = false;
  window.lastTime = 0;
  
  const GAME_UPDATE_INTERVAL = 200;
  let gameUpdateTimer = 0;


  function updateScoreDisplay() {
    const scoreEl = $("#current-score-display");
    if(scoreEl) scoreEl.textContent = score;
  }
  function updateLivesDisplay() {
    const livesEl = $("#lives-display");
    if(livesEl) livesEl.textContent = playerLives;
  }

  function resetMapData() {
      mapData = GAME_MAP.map(row => [...row]);
      score = 0;
      // Assign pacman ke window scope agar bisa diakses setPacmanDirection
      window.pacman = { x: 1, y: 1, dir: 'right', nextDir: 'right', radius: TILE_SIZE / 2.5 };
      pacman = window.pacman; // Pastikan scope lokal juga terdefinisi
      
      ghosts = [
          { x: 9, y: 9, color: '#cc0000', dir: 'up', speed: 1 },
          { x: 10, y: 9, color: '#16a34a', dir: 'down', speed: 1 },
          { x: 8, y: 9, color: '#2563eb', dir: 'left', speed: 1 }
      ];
  }

  window.resetGame = function() { // Export resetGame ke window scope
      if(!canvas || !ctx) {
          console.error("Canvas or Context not available, cannot reset game.");
          return;
      }
      canvas.width = MAP_WIDTH * TILE_SIZE;
      canvas.height = MAP_HEIGHT * TILE_SIZE;
      
      resetMapData();
      playerLives = 1;
      updateScoreDisplay();
      updateLivesDisplay();
      
      const gm = $('#game-message');
      if(gm) gm.style.display = 'none';
      const eb = $('#escape-button');
      if(eb) eb.style.display = 'none'; 
      
      window.gameRunning = false;
      drawMap(); 
  }

  // --- Fungsi Drawing (Tidak berubah) ---
  function drawMap() { /* ... */ }
  function drawPacman() { /* ... */ }
  function drawGhosts() { /* ... */ }
  // --- Akhir Fungsi Drawing ---

  function movePacman() {
      // Menggunakan window.pacman
      const p = window.pacman;
      
      const nextX = p.x + (p.nextDir === 'right' ? 1 : p.nextDir === 'left' ? -1 : 0);
      const nextY = p.y + (p.nextDir === 'down' ? 1 : p.nextDir === 'up' ? -1 : 0);

      if (mapData[nextY] && mapData[nextY][nextX] !== 1) {
          p.dir = p.nextDir;
          p.x = nextX;
          p.y = nextY;
      } else {
          const currentX = p.x + (p.dir === 'right' ? 1 : p.dir === 'left' ? -1 : 0);
          const currentY = p.y + (p.dir === 'down' ? 1 : p.dir === 'up' ? -1 : 0);

          if (mapData[currentY] && mapData[currentY][currentX] !== 1) {
              p.x = currentX;
              p.y = currentY;
          }
      }

      // Teleport
      if (p.x < 0) p.x = MAP_WIDTH - 1;
      if (p.x >= MAP_WIDTH) p.x = 0;
  }

  function moveGhosts() { /* ... (Logika Ghost tetap menggunakan pacman global) ... */ }

  function checkCollision() {
      const p = window.pacman;

      if (mapData[p.y][p.x] === 2) {
          mapData[p.y][p.x] = 0;
          score += 10;
          updateScoreDisplay(); 
      }

      ghosts.forEach(ghost => {
          if (p.x === ghost.x && p.y === ghost.y) {
              playerLives--;
              updateLivesDisplay();
              if (playerLives <= 0) {
                  endGame(false);
              } else {
                  window.pacman = { x: 1, y: 1, dir: 'right', nextDir: 'right', radius: TILE_SIZE / 2.5 };
                  pacman = window.pacman; // Update scope lokal
                  ghosts = [
                      { x: 9, y: 9, color: '#cc0000', dir: 'up', speed: 1 },
                      { x: 10, y: 9, color: '#16a34a', dir: 'down', speed: 1 },
                      { x: 8, y: 9, color: '#2563eb', dir: 'left', speed: 1 }
                  ];
              }
          }
      });

      let dotsRemaining = mapData.flat().filter(cell => cell === 2).length;
      if (dotsRemaining === 0) endGame(true);
  }


  function gameLoop(timestamp) {
      if (!window.gameRunning) {
        animationFrameId = requestAnimationFrame(gameLoop);
        drawMap(); 
        drawPacman();
        drawGhosts();
        return;
      }
      
      const deltaTime = timestamp - window.lastTime;
      window.lastTime = timestamp;
      
      drawMap();
      drawPacman();
      drawGhosts();

      gameUpdateTimer += deltaTime;
      if (gameUpdateTimer > GAME_UPDATE_INTERVAL) {
          movePacman();
          moveGhosts();
          checkCollision();
          gameUpdateTimer = 0;
      }

      animationFrameId = requestAnimationFrame(gameLoop);
  }

  function endGame(isWin) {
      if (!window.gameRunning) return;
      window.gameRunning = false;
      cancelAnimationFrame(animationFrameId);
      const msg = isWin ? "SELAMAT! Anda menang!" : "GAME OVER!";
      const gm = $('#game-message');
      const eb = $('#escape-button');
      
      gm.textContent = msg + " Skor Akhir: " + score;
      gm.style.display = 'block';
      if(eb) eb.style.display = 'block'; 
      
      window.parent.postMessage({ type: 'submitScore', score: score, modeName: 'Classic' }, '*');
      
      setTimeout(()=>{
        gm.style.display = 'none';
        handleReturnHome();
      }, 4000);
  }

  // Input Keyboard
  const handleGlobalKeydown = (e) => {
      let dir = null;
      if (e.key === 'ArrowUp' || e.key === 'w') dir = 'up';
      else if (e.key === 'ArrowDown' || e.key === 's') dir = 'down';
      else if (e.key === 'ArrowLeft' || e.key === 'a') dir = 'left';
      else if (e.key === 'ArrowRight' || e.key === 'd') dir = 'right';
      if(dir) setPacmanDirection(dir); // Panggil fungsi global
  };

  // receive messages from parent
  window.addEventListener('message', (ev)=>{
    const d = ev.data || {};
    if (d.type === 'paySuccess') {
      window.resetGame();
      window.gameRunning = true;
      window.lastTime = performance.now();
    }
  });

/* ========== STARTUP SAAT DOM DIMUAT ========== */
document.addEventListener('DOMContentLoaded', () => {
    // 1. Inisialisasi Game State
    window.resetGame();
    
    // 2. Tambahkan Listener Input Keyboard
    document.addEventListener('keydown', handleGlobalKeydown); 
    
    // CATATAN: Mobile Controls event listener dihapus karena sekarang
    // menggunakan inline attributes (ontouchstart/onmousedown) di HTML.

    // 3. MULAI LOOP UTAMA
    requestAnimationFrame(gameLoop); 
});
})();
</script>
</body>
</html>


<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Somnia Christmas Carnival - Smart AI Edition</title>
    <style>
        body { background: #020617; color: white; display: flex; flex-direction: column; align-items: center; font-family: sans-serif; margin: 0; touch-action: manipulation; overflow: hidden; }
        #ui { font-size: 24px; font-weight: bold; margin: 15px 0; color: #fbbf24; text-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
        canvas { border: 4px solid #b91c1c; border-radius: 12px; background: #000; box-shadow: 0 0 30px rgba(185, 28, 28, 0.4); max-width: 95vw; }
        .controls { display: grid; grid-template-areas: ". up ." "left center right" ". down ."; gap: 12px; margin: 20px 0; }
        .btn { width: 70px; height: 70px; border-radius: 20px; border: none; background: linear-gradient(145deg, #dc2626, #991b1b); color: white; font-size: 28px; font-weight: bold; box-shadow: 0 6px #7f1d1d; cursor: pointer; user-select: none; }
        .btn:active { transform: translateY(4px); box-shadow: 0 2px #7f1d1d; }
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 100; }
        #countdown-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 110; font-size: 120px; color: #fbbf24; font-weight: bold; text-shadow: 0 0 20px #dc2626; }
        .msg-box { padding: 40px; border: 3px solid #fbbf24; border-radius: 20px; text-align: center; background: #010409; max-width: 80%; }
        .active { display: flex !important; }
    </style>
</head>
<body>

<div id="ui">üéÖ Skor: <span id="score">0</span> <span id="pwr" style="display:none; color:#60a5fa"> | ‚ö° POWER!</span></div>

<div id="overlay" class="active">
    <div class="msg-box">
        <h2 id="status-text">Menunggu Pembayaran...</h2>
        <p style="color: #94a3b8;">Selesaikan transaksi untuk mulai bermain</p>
        <button id="unlock-audio" style="margin-top:20px; padding:10px; background:#fbbf24; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">Enable Sound üîä</button>
    </div>
</div>

<div id="countdown-overlay">3</div>
<canvas id="gameCanvas"></canvas>

<div class="controls">
    <button class="btn" style="grid-area:up" onclick="handleInput('up')">‚Üë</button>
    <button class="btn" style="grid-area:left" onclick="handleInput('left')">‚Üê</button>
    <button class="btn" style="grid-area:right" onclick="handleInput('right')">‚Üí</button>
    <button class="btn" style="grid-area:down" onclick="handleInput('down')">‚Üì</button>
</div>

<audio id="gameBgm" loop preload="auto">
    <source src="assets/music_background.mp3" type="audio/mpeg">
</audio>

<script>
(() => {
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const bgm = document.getElementById("gameBgm");
    const TILE = 24;

    const MAP = [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,3,2,2,2,2,2,2,2,1,2,2,2,2,2,2,2,3,1],
        [1,2,1,1,2,1,1,1,2,1,2,1,1,1,2,1,1,2,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,2,1,1,2,1,2,1,1,1,1,1,2,1,2,1,1,2,1],
        [1,2,2,2,2,1,2,2,2,1,2,2,2,1,2,2,2,2,1],
        [1,1,1,1,2,1,1,1,0,1,0,1,1,1,2,1,1,1,1],
        [0,0,0,1,2,1,0,0,0,0,0,0,0,1,2,1,0,0,0],
        [1,1,1,1,2,1,0,1,1,1,1,1,0,1,2,1,1,1,1],
        [1,2,2,2,2,2,2,1,0,0,0,1,2,2,2,2,2,2,1],
        [1,1,1,1,2,1,0,1,1,1,1,1,0,1,2,1,1,1,1],
        [1,2,2,2,2,2,2,2,2,1,2,2,2,2,2,2,2,2,1],
        [1,3,1,1,2,1,1,1,2,1,2,1,1,1,2,1,1,3,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ];

    let mapData = MAP.map(row => [...row]);
    let pacman = { x: 1, y: 1, dir: "right", next: "right", pTime: 0 };
    let ghosts = [
        { x: 8, y: 7, color: "#ef4444", ox: 8, oy: 7, sc: false },
        { x: 9, y: 7, color: "#f472b6", ox: 9, oy: 7, sc: false },
        { x: 10, y: 7, color: "#22d3ee", ox: 10, oy: 7, sc: false },
        { x: 9, y: 8, color: "#fb923c", ox: 9, oy: 8, sc: false }
    ];
    let score = 0, gameRunning = false, frameCounter = 0;

    // --- AUDIO FIX ---
    function playBgm() {
        if (bgm) {
            bgm.play().catch(e => console.warn("Autoplay blocked. Need interaction."));
        }
    }

    // Listener Tombol Enable Sound (Hanya cadangan)
    document.getElementById("unlock-audio").addEventListener("click", () => {
        playBgm();
        document.getElementById("unlock-audio").style.display = "none";
    });

    function resetGame() {
        mapData = MAP.map(row => [...row]);
        score = 0; document.getElementById("score").innerText = "0";
        pacman = { x: 1, y: 1, dir: "right", next: "right", pTime: 0 };
        ghosts.forEach(g => { g.x = g.ox; g.y = g.oy; g.sc = false; });
        document.getElementById("pwr").style.display = "none";
    }

    function startCountdown() {
        const cd = document.getElementById("countdown-overlay");
        const ov = document.getElementById("overlay");
        ov.style.display = "none";
        cd.style.display = "flex";
        let count = 3;
        cd.innerText = count;
        gameRunning = false;
        
        const timer = setInterval(() => {
            count--;
            if (count > 0) cd.innerText = count;
            else if (count === 0) cd.innerText = "GO!";
            else {
                clearInterval(timer);
                cd.style.display = "none";
                gameRunning = true;
                playBgm(); // Coba mainkan musik lagi di sini
            }
        }, 1000);
    }

    window.addEventListener("message", (e) => {
        if (e.data.type === "paySuccess") { 
            resetGame(); 
            startCountdown();
        }
    });

    // --- CONTROLS ---
    window.handleInput = (d) => { 
        pacman.next = d; 
        playBgm(); // Setiap pencet tombol, pancing browser untuk izinkan audio
    };

    // Keyboard support
    window.addEventListener("keydown", (e) => {
        const k = e.key.toLowerCase();
        if (k.includes("arrowup") || k === "w") handleInput("up");
        if (k.includes("arrowdown") || k === "s") handleInput("down");
        if (k.includes("arrowleft") || k === "a") handleInput("left");
        if (k.includes("arrowright") || k === "d") handleInput("right");
    });

    // --- RENDER LOGIC (Sederhana) ---
    function update() {
        if (!gameRunning) return;
        frameCounter++;
        let nx = pacman.x, ny = pacman.y;
        if (pacman.next === "up") ny--; if (pacman.next === "down") ny++;
        if (pacman.next === "left") nx--; if (pacman.next === "right") nx++;

        if (mapData[ny] && mapData[ny][nx] !== 1) { 
            pacman.x = nx; pacman.y = ny; pacman.dir = pacman.next;
        }

        if (mapData[pacman.y][pacman.x] === 2) { mapData[pacman.y][pacman.x] = 0; score += 10; }
        if (mapData[pacman.y][pacman.x] === 3) { 
            mapData[pacman.y][pacman.x] = 0; score += 50; 
            pacman.pTime = 40; ghosts.forEach(g => g.sc = true);
            document.getElementById("pwr").style.display = "inline";
        }
        if (pacman.pTime > 0) { 
            pacman.pTime--; 
            if(pacman.pTime === 0) { ghosts.forEach(g => g.sc = false); document.getElementById("pwr").style.display = "none"; }
        }

        ghosts.forEach(g => {
            if (g.x === pacman.x && g.y === pacman.y) {
                if (g.sc) { score += 200; g.x = g.ox; g.y = g.oy; g.sc = false; }
                else { 
                    gameRunning = false; 
                    document.getElementById("overlay").style.display = "flex";
                    document.getElementById("status-text").innerText = "GAME OVER!";
                    window.parent.postMessage({ type: "submitScore", score: score }, "*");
                }
            }
        });
        document.getElementById("score").innerText = score;
    }

    function loop() {
        update();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        // Draw Walls
        for(let y=0; y<mapData.length; y++){
            for(let x=0; x<mapData[0].length; x++){
                if(mapData[y][x] === 1) { ctx.fillStyle="#b91c1c"; ctx.fillRect(x*TILE, y*TILE, TILE, TILE); }
                else if(mapData[y][x] === 2) { ctx.fillStyle="#ffd700"; ctx.beginPath(); ctx.arc(x*TILE+TILE/2, y*TILE+TILE/2, 2, 0, 7); ctx.fill(); }
                else if(mapData[y][x] === 3) { ctx.fillStyle="#fbbf24"; ctx.beginPath(); ctx.arc(x*TILE+TILE/2, y*TILE+TILE/2, 5, 0, 7); ctx.fill(); }
            }
        }
        // Draw Pacman
        ctx.fillStyle="#facc15"; ctx.beginPath(); ctx.arc(pacman.x*TILE+TILE/2, pacman.y*TILE+TILE/2, TILE/2-2, 0, 7); ctx.fill();
        // Draw Ghosts
        ghosts.forEach(g => {
            ctx.fillStyle = g.sc ? "#1e40af" : g.color;
            ctx.fillRect(g.x*TILE+4, g.y*TILE+4, TILE-8, TILE-8);
        });
        setTimeout(() => requestAnimationFrame(loop), 200);
    }

    canvas.width = 19 * TILE; canvas.height = 15 * TILE;
    loop();
})();
</script>
</body>
</html>


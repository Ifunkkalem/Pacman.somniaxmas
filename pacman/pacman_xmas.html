<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pacman Natal</title>
<style>
html,body{height:100%;margin:0;background:#000;display:flex;align-items:center;justify-content:center;font-family:Trebuchet MS}
#ui{position:fixed;top:10px;left:10px;color:#fff;z-index:9}
#gameMessage{position:fixed;top:8px;right:8px;color:#fff;z-index:9}
canvas{background:#071024;border-radius:6px}

/* ✅ D-PAD SALIB (TETAP) */
#mobileControls{
  position:fixed;
  bottom:12px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  flex-direction: column;
  align-items: center;
  gap: 0;
  z-index:9;
  width: 200px;
}

#mobileControls button{
  width:60px;height:60px;
  padding:0;
  margin:4px;
  font-size:24px;
  border-radius:8px;
  border:none;
  background: linear-gradient(90deg, #cc0000, #16a34a);
  color:#fff;
  box-shadow:0 4px #8b0000;
}

#mobileControls button:active{
  box-shadow:0 0 #8b0000;
  transform:translateY(4px);
}

.dpad-row{
  display:flex;
  justify-content:space-between;
  width:100%;
}

.center-filler{
  width:60px;
  height:60px;
}
</style>
</head>
<body>

<div id="ui">
  <div id="current-score-display">0</div>
  <div id="game-message" style="display:none;color:#fff;background:rgba(0,0,0,0.6);padding:6px;border-radius:6px;margin-top:6px"></div>
</div>

<canvas id="pacman-canvas"></canvas>

<div id="mobileControls">
  <button data-dir="up">↑</button> 
  <div class="dpad-row">
    <button data-dir="left">←</button>
    <div class="center-filler"></div>
    <button data-dir="right">→</button>
  </div>
  <button data-dir="down">↓</button>
</div>

<script>
(function(){

const canvas = document.getElementById('pacman-canvas');
const ctx = canvas.getContext('2d');
const TILE_SIZE = 20;

/* ✅ MAP ASLI ANDA (DIKEMBALIKAN) */
const GAME_MAP = [
 [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
 [1,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,1],
 [1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
 [1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
 [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
 [1,2,1,1,1,2,1,2,1,1,1,1,2,1,2,1,1,1,2,1],
 [1,2,2,2,2,2,1,2,2,2,2,2,2,1,2,2,2,2,2,1],
 [1,1,1,1,1,2,1,1,1,0,0,1,1,1,2,1,1,1,1,1],
 [0,0,0,0,1,2,1,0,0,0,0,0,0,1,2,1,0,0,0,0],
 [1,1,1,1,1,2,1,0,1,1,1,1,0,1,2,1,1,1,1,1],
 [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
 [1,2,1,1,1,2,1,1,1,1,1,1,1,1,2,1,1,1,2,1],
 [1,2,2,2,1,2,2,2,2,1,1,2,2,2,2,1,2,2,2,1],
 [1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1],
 [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
 [1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1],
 [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
 [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const MAP_WIDTH = GAME_MAP[0].length;
const MAP_HEIGHT = GAME_MAP.length;
canvas.width = MAP_WIDTH * TILE_SIZE;
canvas.height = MAP_HEIGHT * TILE_SIZE;

let pacman, ghosts, score, mapData;
let gameRunning = false;
let lastMove = 0;
let hasInput = false;

/* ✅ KECEPATAN SUDAH DIPERLAMBAT */
const MOVE_INTERVAL = 240;

function resetMapData(){
  mapData = GAME_MAP.map(r=>[...r]);
  pacman = { x:1, y:1, dir:'right', nextDir:'right', radius:TILE_SIZE/2.5 };
  ghosts = [
    { x:9,y:9,color:'#cc0000' },
    { x:10,y:9,color:'#16a34a' },
    { x:8,y:9,color:'#2563eb' }
  ];
  score = 0;
  hasInput = false;
}

function resetGame(){
  resetMapData();
  document.getElementById("current-score-display").textContent = score;
  document.getElementById("game-message").style.display = "none";
  gameRunning = false;
  drawOnce();
}

function drawMap(){
  for(let y=0;y<MAP_HEIGHT;y++){
    for(let x=0;x<MAP_WIDTH;x++){
      const t = mapData[y][x];
      if(t===1){
        ctx.fillStyle='#cc0000';
        ctx.fillRect(x*TILE_SIZE,y*TILE_SIZE,TILE_SIZE,TILE_SIZE);
      }else{
        ctx.fillStyle='#1a2c42';
        ctx.fillRect(x*TILE_SIZE,y*TILE_SIZE,TILE_SIZE,TILE_SIZE);
        if(t===2){
          ctx.fillStyle='#facc15';
          ctx.beginPath();
          ctx.arc(x*TILE_SIZE+10,y*TILE_SIZE+10,3,0,Math.PI*2);
          ctx.fill();
        }
      }
    }
  }
}

/* ✅ ANIMASI PACMAN ASLI (DIKEMBALIKAN) */
function drawPacman() {
      const x = pacman.x * TILE_SIZE + TILE_SIZE / 2;
      const y = pacman.y * TILE_SIZE + TILE_SIZE / 2;
      ctx.fillStyle = '#facc15';
      ctx.beginPath();

      const mouthOpen = Math.abs(Math.sin(Date.now() / 100));
      const angleOffset = { 'right': 0, 'left': Math.PI, 'up': -Math.PI / 2, 'down': Math.PI / 2 }[pacman.dir];
      const startAngle = angleOffset + mouthOpen * 0.4;
      const endAngle = angleOffset - mouthOpen * 0.4 + 2 * Math.PI;

      ctx.arc(x, y, pacman.radius, startAngle, endAngle, false);
      ctx.lineTo(x, y);
      ctx.closePath();
      ctx.fill();
}

/* ✅ ANIMASI GHOST ASLI (DIKEMBALIKAN) */


function drawOnce(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawMap();
  drawPacman();
  drawGhosts();
}

function canMove(x,y){
  return mapData[y] && mapData[y][x] !== 1;
}

function movePacman(){
  if(!hasInput) return;
  const d = pacman.nextDir;
  const nx = pacman.x + (d==="right"?1:d==="left"?-1:0);
  const ny = pacman.y + (d==="down"?1:d==="up"?-1:0);
  if(canMove(nx,ny)){ pacman.x=nx; pacman.y=ny; }
}

function moveGhosts(){
  ghosts.forEach(g=>{
    const d=[[1,0],[-1,0],[0,1],[0,-1]][Math.floor(Math.random()*4)];
    const nx=g.x+d[0], ny=g.y+d[1];
    if(canMove(nx,ny)){ g.x=nx; g.y=ny; }
  });
}

function checkCollision(){
  if(mapData[pacman.y][pacman.x]===2){
    mapData[pacman.y][pacman.x]=0;
    score+=10;
    document.getElementById("currfunction drawGhosts() {
      ghosts.forEach(ghost => {
          const x = ghost.x * TILE_SIZE + TILE_SIZE / 2;
          const y = ghost.y * TILE_SIZE + TILE_SIZE / 2;

          ctx.fillStyle = ghost.color;
          ctx.beginPath();
          ctx.arc(x, y, TILE_SIZE / 2, Math.PI, 0, false);
          ctx.rect(x - TILE_SIZE / 2, y, TILE_SIZE, TILE_SIZE / 2);
          const wobble = Math.sin(Date.now() / 200) * 2;
          ctx.moveTo(x - TILE_SIZE / 2, y + TILE_SIZE / 2);
          ctx.lineTo(x - TILE_SIZE / 2 + TILE_SIZE / 4 + wobble, y + TILE_SIZE / 2 - 3);
          ctx.lineTo(x, y + TILE_SIZE / 2);
          ctx.lineTo(x + TILE_SIZE / 2 - TILE_SIZE / 4 - wobble, y + TILE_SIZE / 2 - 3);
          ctx.lineTo(x + TILE_SIZE / 2, y + TILE_SIZE / 2);
          ctx.fill();

          ctx.fillStyle = 'white';
          ctx.beginPath();
          ctx.arc(x - TILE_SIZE / 4, y - TILE_SIZE / 4, TILE_SIZE / 8, 0, Math.PI * 2);
          ctx.arc(x + TILE_SIZE / 4, y - TILE_SIZE / 4, TILE_SIZE / 8, 0, Math.PI * 2);
          ctx.fill();

          ctx.fillStyle = 'black';
          ctx.beginPath();
          ctx.arc(x - TILE_SIZE / 4 + 1, y - TILE_SIZE / 4, TILE_SIZE / 16, 0, Math.PI * 2);
          ctx.arc(x + TILE_SIZE / 4 + 1, y - TILE_SIZE / 4, TILE_SIZE / 16, 0, Math.PI * 2);
          ctx.fill();
      });
  }ent-score-display").textContent=score;
  }
  ghosts.forEach(g=>{
    if(g.x===pacman.x && g.y===pacman.y){
      endGame();
    }
  });
}

function gameLoop(ts){
  if(!gameRunning) return;
  if(ts-lastMove > MOVE_INTERVAL){
    movePacman();
    moveGhosts();
    checkCollision();
    lastMove = ts;
  }
  drawOnce();
  requestAnimationFrame(gameLoop);
}

function startGame(){
  gameRunning = true;
  requestAnimationFrame(gameLoop);
}

function endGame(){
  gameRunning = false;
  const gm = document.getElementById("game-message");
  gm.textContent = "GAME OVER";
  gm.style.display = "block";
  window.parent.postMessage({ type:"submitScore", score: score },"*");
}

/* ✅ INPUT */
document.querySelectorAll("#mobileControls button").forEach(b=>{
  b.onclick = ()=>{
    pacman.nextDir = b.dataset.dir;
    hasInput = true;
  };
});

window.onkeydown = e=>{
  if(e.key.includes("Arrow")){
    pacman.nextDir = e.key.replace("Arrow","").toLowerCase();
    hasInput = true;
  }
};

window.addEventListener("message",(e)=>{
  if(e.data.type==="paySuccess"){
    resetGame();
    startGame();
  }
});

resetGame();

})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pacman Natal Final</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{margin:0;background:#000;color:white;text-align:center;font-family:Arial}
#ui{position:fixed;top:10px;left:10px;z-index:10}
canvas{background:#000;display:block;margin:auto}
#mobileControls{
  position:fixed;bottom:15px;left:50%;
  transform:translateX(-50%);
  display:flex;gap:12px;z-index:20
}
.ctl-btn{
  width:60px;height:60px;border-radius:50%;
  border:none;background:#22c55e;color:#000;font-size:22px
}
#game-message{
  position:fixed;inset:0;
  display:none;align-items:center;justify-content:center;
  background:rgba(0,0,0,.85);
  font-size:80px;color:gold;z-index:99
}
</style>
</head>
<body>

<div id="ui">Score: <span id="current-score-display">0</span></div>
<div id="game-message"></div>
<canvas id="pacman-canvas"></canvas>

<div id="mobileControls">
  <button class="ctl-btn" data-dir="up">‚Üë</button>
  <button class="ctl-btn" data-dir="left">‚Üê</button>
  <button class="ctl-btn" data-dir="down">‚Üì</button>
  <button class="ctl-btn" data-dir="right">‚Üí</button>
</div>

<script>
(function(){

const canvas = document.getElementById('pacman-canvas');
const ctx = canvas.getContext('2d');

const TILE_SIZE = 20;

const GAME_MAP = [
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
[1,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
[1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,2,1,2,1,1,1,1,2,1,2,1,1,1,2,1],
[1,2,2,2,2,2,1,2,2,2,2,2,2,1,2,2,2,2,2,1],
[1,1,1,1,1,2,1,1,1,0,0,1,1,1,2,1,1,1,1,1],
[0,0,0,0,1,2,1,0,0,0,0,0,0,1,2,1,0,0,0,0],
[1,1,1,1,1,2,1,0,1,1,1,1,0,1,2,1,1,1,1,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,2,1,1,1,1,1,1,1,1,2,1,1,1,2,1],
[1,2,2,2,1,2,2,2,2,1,1,2,2,2,2,1,2,2,2,1],
[1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const MAP_WIDTH = GAME_MAP[0].length;
const MAP_HEIGHT = GAME_MAP.length;
canvas.width = MAP_WIDTH * TILE_SIZE;
canvas.height = MAP_HEIGHT * TILE_SIZE;

let pacman, ghosts, score, mapData;
let gameRunning=false, animationFrameId=null;

function resetMapData(){
  mapData = GAME_MAP.map(r=>[...r]);
  pacman = { x:1, y:1, dir:'right', nextDir:'right' };
  ghosts = [
    { x:9,y:9,color:'#cc0000' },
    { x:10,y:9,color:'#16a34a' },
    { x:8,y:9,color:'#2563eb' }
  ];
}

function resetGame(){
  resetMapData();
  score=0;
  document.getElementById("current-score-display").textContent = score;

  const gm = document.getElementById("game-message");
  gm.style.display = "none";
  gm.textContent = "";

  gameRunning=false;
  if(animationFrameId){
    cancelAnimationFrame(animationFrameId);
    animationFrameId=null;
  }

  drawOnce();
}

function drawMap(){
  for(let y=0;y<MAP_HEIGHT;y++){
    for(let x=0;x<MAP_WIDTH;x++){
      const t=mapData[y][x];
      if(t===1){
        ctx.fillStyle='#cc0000';
        ctx.fillRect(x*TILE_SIZE,y*TILE_SIZE,TILE_SIZE,TILE_SIZE);
      }else{
        ctx.fillStyle='#1a2c42';
        ctx.fillRect(x*TILE_SIZE,y*TILE_SIZE,TILE_SIZE,TILE_SIZE);
        if(t===2){
          ctx.fillStyle='#facc15';
          ctx.beginPath();
          ctx.arc(x*TILE_SIZE+10,y*TILE_SIZE+10,3,0,Math.PI*2);
          ctx.fill();
        }
      }
    }
  }
}

/* üéÖ SINTERKLAS */
function drawPacman(){
  const x = pacman.x*TILE_SIZE+10;
  const y = pacman.y*TILE_SIZE+10;

  ctx.fillStyle="red";
  ctx.beginPath();
  ctx.arc(x,y-4,7,Math.PI,0);
  ctx.fill();

  ctx.fillStyle="white";
  ctx.beginPath();
  ctx.arc(x,y+4,7,0,Math.PI*2);
  ctx.fill();
}

/* üëπ MUSUH */
function drawGhosts(){
  ghosts.forEach(g=>{
    const x = g.x*TILE_SIZE+10;
    const y = g.y*TILE_SIZE+10;

    ctx.fillStyle=g.color;
    ctx.beginPath();
    ctx.arc(x,y,9,0,Math.PI*2);
    ctx.fill();

    ctx.fillStyle="white";
    ctx.beginPath();
    ctx.arc(x-3,y-2,2,0,Math.PI*2);
    ctx.arc(x+3,y-2,2,0,Math.PI*2);
    ctx.fill();
  });
}

function drawOnce(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawMap();
  drawPacman();
  drawGhosts();
}

function canMove(x,y){
  return mapData[y] && mapData[y][x]!==1;
}

function movePacman(){
  const d=pacman.nextDir;
  const nx=pacman.x+(d==="right"?1:d==="left"?-1:0);
  const ny=pacman.y+(d==="down"?1:d==="up"?-1:0);
  if(canMove(nx,ny)){
    pacman.x=nx; pacman.y=ny;
  }
}

function moveGhosts(){
  ghosts.forEach(g=>{
    const d=[[1,0],[-1,0],[0,1],[0,-1]][Math.floor(Math.random()*4)];
    const nx=g.x+d[0], ny=g.y+d[1];
    if(canMove(nx,ny)){ g.x=nx; g.y=ny; }
  });
}

function checkCollision(){
  if(mapData[pacman.y][pacman.x]===2){
    mapData[pacman.y][pacman.x]=0;
    score+=10;
    document.getElementById("current-score-display").textContent=score;
  }
  ghosts.forEach(g=>{
    if(g.x===pacman.x && g.y===pacman.y){
      endGame();
    }
  });
}

function gameLoop(){
  if(!gameRunning) return;
  movePacman();
  moveGhosts();
  checkCollision();
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawMap();
  drawPacman();
  drawGhosts();
  animationFrameId=requestAnimationFrame(gameLoop);
}

function startGame(){
  gameRunning=true;
  gameLoop();
}

function endGame(){
  gameRunning=false;
  if(animationFrameId){
    cancelAnimationFrame(animationFrameId);
    animationFrameId=null;
  }

  const gm = document.getElementById("game-message");
  gm.style.display="flex";
  gm.textContent="GAME OVER";

  window.parent.postMessage({
    type:"submitScore",
    score: score
  },"*");
}

document.querySelectorAll(".ctl-btn").forEach(b=>{
  b.onclick=()=>pacman.nextDir=b.dataset.dir;
});

window.onkeydown=e=>{
  if(e.key==="ArrowUp") pacman.nextDir="up";
  if(e.key==="ArrowDown") pacman.nextDir="down";
  if(e.key==="ArrowLeft") pacman.nextDir="left";
  if(e.key==="ArrowRight") pacman.nextDir="right";
};

window.addEventListener("message",(e)=>{
  if(e.data.type==="paySuccess"){
    resetGame();
    startGame();
  }
});

resetGame();

})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pacman Natal</title>

<style>
html,body{height:100%;margin:0;background:#000;display:flex;align-items:center;justify-content:center;font-family:Trebuchet MS}
#ui{position:fixed;top:10px;left:10px;color:#fff;z-index:9}
#game-message{position:fixed;top:8px;right:8px;color:#fff;z-index:9}
canvas{background:#071024;border-radius:6px}

/* D-PAD */
#mobileControls{
position:fixed;
bottom:12px;
left:50%;
transform:translateX(-50%);
display:flex;
flex-direction: column;
align-items: center;
z-index:9;
}
#mobileControls button{
width:60px;height:60px;
margin:4px;
font-size:24px;
border-radius:8px;
border:none;
background: linear-gradient(90deg, #cc0000, #16a34a);
color:#fff;
}
.dpad-row{display:flex;width:100%;justify-content:space-between}
.center-filler{width:60px;height:60px}
</style>
</head>

<body>

<div id="ui">
  <div id="current-score-display">0</div>
  <div id="game-message" style="display:none;background:rgba(0,0,0,0.6);padding:6px;border-radius:6px;margin-top:6px"></div>
</div>

<canvas id="pacman-canvas"></canvas>

<div id="mobileControls">
  <button data-dir="up">↑</button>
  <div class="dpad-row">
    <button data-dir="left">←</button>
    <div class="center-filler"></div>
    <button data-dir="right">→</button>
  </div>
  <button data-dir="down">↓</button>
</div>

<!-- AUDIO -->
<audio id="bgm" src="assets/music_background.mp3" loop preload="auto"></audio>
<audio id="sfxEat" src="assets/sfx_dot_eat.mp3" preload="auto"></audio>
<audio id="sfxStart" src="assets/sfx_start.mp3" preload="auto"></audio>

<script>
(function(){

const canvas = document.getElementById('pacman-canvas');
const ctx = canvas.getContext('2d');
const TILE_SIZE = 20;

/* MAP ASLI - TIDAK DIUBAH */
const GAME_MAP = [
 [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
 [1,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,1],
 [1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
 [1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
 [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
 [1,2,1,1,1,2,1,2,1,1,1,1,2,1,2,1,1,1,2,1],
 [1,2,2,2,2,2,1,2,2,2,2,2,2,1,2,2,2,2,2,1],
 [1,1,1,1,1,2,1,1,1,0,0,1,1,1,2,1,1,1,1,1],
 [0,0,0,0,1,2,1,0,0,0,0,0,0,1,2,1,0,0,0,0],
 [1,1,1,1,1,2,1,0,1,1,1,1,0,1,2,1,1,1,1,1],
 [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
 [1,2,1,1,1,2,1,1,1,1,1,1,1,1,2,1,1,1,2,1],
 [1,2,2,2,1,2,2,2,2,1,1,2,2,2,2,1,2,2,2,1],
 [1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1],
 [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
 [1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1],
 [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
 [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const MAP_WIDTH = GAME_MAP[0].length;
const MAP_HEIGHT = GAME_MAP.length;
canvas.width = MAP_WIDTH * TILE_SIZE;
canvas.height = MAP_HEIGHT * TILE_SIZE;

/* ✅ AUDIO FIX TOTAL */
const bgm = document.getElementById("bgm");
const sfxEat = document.getElementById("sfxEat");
const sfxStart = document.getElementById("sfxStart");

bgm.volume = 0.5;
sfxEat.volume = 0.9;
sfxStart.volume = 0.9;

let audioReady = false;
function unlockAudio(){
  if(audioReady) return;
  audioReady = true;
  bgm.play().catch(()=>{});
}
window.addEventListener("pointerdown", unlockAudio, {once:true});
window.addEventListener("keydown", unlockAudio, {once:true});

/* ===== GAME LOGIC TIDAK DIUBAH ===== */

let pacman, ghosts, score, mapData;
let gameRunning = false;
let ghostActive = false;
let lastMove = 0;
let hasInput = false;
const MOVE_INTERVAL = 240;

function resetMapData(){
  mapData = GAME_MAP.map(r=>[...r]);
  pacman = { x:1, y:1, dir:'right', nextDir:'right', radius:TILE_SIZE/2.5 };
  ghosts = [
    { x:9,y:9,color:'#cc0000' },
    { x:10,y:9,color:'#16a34a' },
    { x:8,y:9,color:'#2563eb' }
  ];
  score = 0;
  hasInput = false;
  ghostActive = false;
}

function resetGame(){
  resetMapData();
  document.getElementById('current-score-display').textContent = score;
  document.getElementById('game-message').style.display = 'none';
  gameRunning = false;
  lastMove = 0;
  drawOnce();
}

function drawMap(){
  for(let y=0;y<MAP_HEIGHT;y++){
    for(let x=0;x<MAP_WIDTH;x++){
      const t = mapData[y][x];
      if(t===1){
        ctx.fillStyle = '#cc0000';
        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
      } else {
        ctx.fillStyle = '#1a2c42';
        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
        if(t===2){
          ctx.fillStyle = '#facc15';
          ctx.beginPath();
          ctx.arc(x*TILE_SIZE + TILE_SIZE/2, y*TILE_SIZE + TILE_SIZE/2, 3, 0, Math.PI*2);
          ctx.fill();
        }
      }
    }
  }
}

function drawPacman(){
  const x = pacman.x * TILE_SIZE + TILE_SIZE / 2;
  const y = pacman.y * TILE_SIZE + TILE_SIZE / 2;
  ctx.fillStyle = '#facc15';
  ctx.beginPath();

  const mouthOpen = Math.abs(Math.sin(Date.now() / 100));
  const angleOffset = { 'right': 0, 'left': Math.PI, 'up': -Math.PI / 2, 'down': Math.PI / 2 }[pacman.dir];
  ctx.arc(x, y, pacman.radius, angleOffset + mouthOpen*0.4, angleOffset - mouthOpen*0.4 + 2*Math.PI);
  ctx.lineTo(x, y);
  ctx.fill();

  ctx.fillStyle = '#cc0000';
  ctx.beginPath();
  ctx.moveTo(x - pacman.radius*0.6, y - pacman.radius);
  ctx.lineTo(x + pacman.radius*0.6, y - pacman.radius);
  ctx.lineTo(x, y - pacman.radius*1.6);
  ctx.closePath();
  ctx.fill();
}

function movePacman(){
  if(!hasInput) return;
  const d = pacman.nextDir;
  const nx = pacman.x + (d==="right"?1:d==="left"?-1:0);
  const ny = pacman.y + (d==="down"?1:d==="up"?-1:0);
  if(mapData[ny] && mapData[ny][nx] !== 1){
    pacman.x = nx;
    pacman.y = ny;
    pacman.dir = d;
  }
}

function checkCollision(){
  if(mapData[pacman.y][pacman.x] === 2){
    mapData[pacman.y][pacman.x] = 0;
    score += 10;
    sfxEat.currentTime = 0;
    sfxEat.play().catch(()=>{});
    document.getElementById('current-score-display').textContent = score;
  }

  for(const g of ghosts){
    if(g.x === pacman.x && g.y === pacman.y){
      endGame(); return;
    }
  }
}

function startGame(){
  unlockAudio();
  sfxStart.currentTime = 0;
  sfxStart.play().catch(()=>{});

  ghostActive = false;
  let count = 3;
  const gm = document.getElementById('game-message');
  gm.style.display = 'block';

  const t = setInterval(()=>{
    gm.textContent = 'READY ' + count;
    count--;
    if(count < 0){
      clearInterval(t);
      gm.style.display = 'none';
      ghostActive = true;
      gameRunning = true;
      lastMove = performance.now();
    }
  },1000);
}

function endGame(){
  gameRunning = false;
  const gm = document.getElementById('game-message');
  gm.textContent = 'GAME OVER';
  gm.style.display = 'block';
}

document.querySelectorAll('#mobileControls button').forEach(b=>{
  b.onclick = ()=>{
    unlockAudio();
    pacman.nextDir = b.dataset.dir;
    hasInput = true;
  };
});

resetGame();
requestAnimationFrame(function loop(ts){
  if(gameRunning && ts - lastMove > MOVE_INTERVAL){
    movePacman();
    moveGhosts();     // ✅ INI YANG HILANG
    checkCollision();
    lastMove = ts;
  }
  drawMap();
  drawPacman();
  drawGhosts();       // ✅ INI YANG HILANG
  requestAnimationFrame(loop);
});

})();
</script>

</body>
</html>

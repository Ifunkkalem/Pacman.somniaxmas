<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pacman XMAS - Santa vs Reindeer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  html,body{
    margin:0; background:#000; height:100%; min-height:100vh;
    display:flex; justify-content:center; align-items:flex-start;
    font-family:Arial, Helvetica, sans-serif; padding:12px; box-sizing:border-box;
  }
  #gameWrapper{
    width: calc(20 * 20px + 40px); max-width: 92vw;
    display:flex; flex-direction:column; align-items:center; gap:12px;
    position: relative;
  }
  canvas{
    background:#020617; border-radius:10px; display:block;
    box-shadow: 0 8px 24px rgba(0,0,0,0.6); image-rendering: optimizeSpeed;
    z-index: 15; 
  }
  #ui{position:relative;color:#fff;z-index:2;align-self:flex-start}
  #game-message{
    color:white; background:rgba(0,0,0,.8); padding:10px 15px; border-radius:8px;
    display:none; z-index:25; position:absolute; top: 50%; left: 50%; 
    transform: translate(-50%, -50%); text-align: center;
    pointer-events: none; /* Penting agar tidak menghalangi event di bawahnya */
  }
  /* Tombol Restart Manual */
  #restart-button {
      position: absolute; top: 10px; right: 10px;
      background: #b91c1c; color: white; border: none; padding: 5px 10px;
      border-radius: 5px; cursor: pointer; font-size: 14px; z-index: 30; 
  }

  /* --- COUNTDOWN OVERLAY STYLE (FIXED) --- */
  #countdown-overlay {
    /* Harus menutupi area gameWrapper secara penuh */
    position: absolute;
    top: 0; left: 0; 
    width: 100%; 
    height: 100%; 
    background: rgba(0, 0, 0, 0.95);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 50; /* Z-index TERTINGGI agar selalu terlihat */
    font-size: 80px;
    color: #ffd700;
    text-shadow: 0 0 20px #cc0000;
    font-weight: bold;
    user-select: none;
    opacity: 0;
    transition: opacity 0.2s;
  }
  #countdown-overlay.active {
    display: flex;
    opacity: 1;
  }
  /* --- END COUNTDOWN OVERLAY STYLE --- */

  /* FIX D-PAD PLUS (+) STYLE */
  #mobileControls {
    display: grid;
    grid-template-areas: ". up ." "left center right" ". down .";
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
    margin-top: 6px;
    user-select: none; 
    -webkit-tap-highlight-color: transparent;
    width: 210px; 
    z-index: 20; 
  }

  #mobileControls .btn {
    width: 70px; height: 70px; border-radius:10px;border:0;
    background:linear-gradient(90deg,#cc0000,#16a34a);color:#fff;font-size:22px;
    display:inline-flex;align-items:center;justify-content:center;
    box-shadow:0 4px rgba(0,0,0,0.4); touch-action: manipulation;
    cursor: pointer;
  }
  
  .btn[data-dir="up"] { grid-area: up; }
  .btn[data-dir="left"] { grid-area: left; }
  .btn[data-dir="right"] { grid-area: right; }
  .btn[data-dir="down"] { grid-area: down; }
  .center-filler { grid-area: center; width: 70px; height: 70px; visibility: hidden; }

  @media(min-width:900px){
    body{align-items:center}
    #gameWrapper{max-width:760px}
    #mobileControls{display:none}
  }
  @media(max-width:480px){
    #gameWrapper{ width: 90vw; }
  }
</style>
</head>

<body>
  <div id="gameWrapper">
    <div id="ui">Score: <span id="current-score-display">0</span></div>
    <button id="restart-button" style="display:none;" onclick="handleGameRestart()">Restart Game</button>
    
    <div id="countdown-overlay"></div>
    
    <div id="game-message"></div>

    <canvas id="pacman-canvas" aria-label="Pacman XMAS game"></canvas>

    <div id="mobileControls" aria-hidden="false">
        <button class="btn" data-dir="up">↑</button>
        <div class="center-filler" aria-hidden="true"></div>
        <button class="btn" data-dir="left">←</button>
        <button class="btn" data-dir="right">→</button>
        <button class="btn" data-dir="down">↓</button>
    </div>
  </div>

  <audio id="game-bgm" loop preload="auto">
      <source src="../assets/music_background.mp3" type="audio/mpeg">
      </audio>
  <audio id="sfx-dot" preload="auto"><source src="../assets/sfx_dot_eat.mp3" type="audio/mpeg"></audio>

<script>
(() => {
/* ================= SECURITY & CONFIG ================= */
// Menggunakan window.location.origin jika berada di domain yang sama dengan parent
const TRUSTED_ORIGIN = window.location.origin || "*"; 

const TILE = 20;
const MOVE_INTERVAL = 240;

const canvas = document.getElementById("pacman-canvas");
const ctx = canvas ? canvas.getContext("2d") : null;
if (!ctx) return;

/* ================== MAP & UTIL (Omitted for brevity) ================== */
const GAME_MAP = [
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
[1,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
[1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,2,1,2,1,1,1,1,2,1,2,1,1,1,2,1],
[1,2,2,2,2,2,1,2,2,2,2,2,2,1,2,2,2,2,2,1],
[1,1,1,1,1,2,1,1,1,0,0,1,1,1,2,1,1,1,1,1],
[0,0,0,0,1,2,1,0,0,0,0,0,0,1,2,1,0,0,0,0],
[1,1,1,1,1,2,1,0,1,1,1,1,0,1,2,1,1,1,1,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,2,1,1,1,1,1,1,1,1,2,1,1,1,2,1],
[1,2,2,2,1,2,2,2,2,1,1,2,2,2,2,1,2,2,2,1],
[1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];
const MAP_W = GAME_MAP[0].length;
const MAP_H = GAME_MAP.length;
canvas.width = MAP_W * TILE;
canvas.height = MAP_H * TILE;

/* utility rounded rect */
function roundRect(ctx, x, y, w, h, r) {
  if (r === undefined) r = 6;
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.arcTo(x + w, y, x + w, y + h, r);
  ctx.arcTo(x + w, y + h, x, y + h, r);
  ctx.arcTo(x, y + h, x, y, r);
  ctx.arcTo(x, y, x + w, y, r);
  ctx.closePath();
  return ctx; // Tambahkan return ctx untuk chaining atau penggunaan di drawGhosts
}

/* ========== AUDIO SYSTEM (DOT SOUND & BGM) ========== */
const bgm = document.getElementById("game-bgm");
let hasUserInteracted = false; 

function playBGM() {
    if (bgm && bgm.paused && hasUserInteracted) {
        bgm.play().catch(e => {
            console.warn("BGM autoplay failed. Waiting for user interaction or further signal.", e);
        });
    }
}

function stopBGM() {
    if (bgm && !bgm.paused) {
        bgm.pause();
        bgm.currentTime = 0;
    }
}

let audioCtx = null;
const DOT_SOUND_VOLUME = 0.5;
let dotPool = [];
const DOT_POOL_SIZE = 5;

// Dipanggil saat interaksi pertama
function initAudioPool() {
  if (audioCtx) return;
  try {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    for (let i = 0; i < DOT_POOL_SIZE; i++) {
      dotPool.push({ freq: 500 + i * 20, duration: 0.05 });
    }
    hasUserInteracted = true; 
    // playBGM(); // Hapus playBGM di sini agar hanya dimulai setelah countdown
  } catch(e) { console.error("AudioContext failed to initialize:", e); }
  document.removeEventListener('touchstart', initAudioPool);
  document.removeEventListener('mousedown', initAudioPool);
}

let dotIndex = 0;
function playDotSound() {
  if (!audioCtx) return;
  dotIndex = (dotIndex + 1) % DOT_POOL_SIZE;
  const sound = dotPool[dotIndex];
  const source = audioCtx.createOscillator();
  const gainNode = audioCtx.createGain();
  source.type = 'sine';
  source.frequency.setValueAtTime(sound.freq, audioCtx.currentTime);
  gainNode.gain.setValueAtTime(DOT_SOUND_VOLUME, audioCtx.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + sound.duration);
  source.connect(gainNode);
  gainNode.connect(audioCtx.destination);
  source.start();
  source.stop(audioCtx.currentTime + sound.duration);
}
// Listeners untuk inisialisasi AudioContext
document.addEventListener('touchstart', initAudioPool, { once: true });
document.addEventListener('mousedown', initAudioPool, { once: true });

/* ========== STATE & INIT ========== */
let mapData, pacman, ghosts, score = 0;
let lastMove = 0;
let gameRunning = false;
let ghostActive = false;
let scoreSubmitted = false;
let sessionStartTime = 0;
window.allowLocalPlay = false; 
let animationFrameId = null;

window.resetGame = function(){ // Dibuat global untuk dipanggil dari parent
  mapData = GAME_MAP.map(r=>[...r]);
  pacman = {x:1,y:1,dir:"right",next:"right"};
  ghosts = [
    {x:9,y:9,color:"#ff0033", antlerColor:"#964B00", noseColor:"#cc0000"},
    {x:10,y:9,color:"#00b300", antlerColor:"#964B00", noseColor:"#556B2F"},
    {x:8,y:9,color:"#1e90ff", antlerColor:"#964B00", noseColor:"#87CEFA"}
  ];
  score = 0;
  scoreSubmitted = false;
  sessionStartTime = Date.now();
  document.getElementById("current-score-display").textContent = score;
  document.getElementById("game-message").style.display = "none";
  document.getElementById("restart-button").style.display = "none";
  document.getElementById("countdown-overlay").classList.remove('active'); 
  stopBGM(); 
  gameRunning = false;
  ghostActive = false;
}

window.handleGameRestart = function() {
  if (!hasUserInteracted) initAudioPool();

  if(!window.allowLocalPlay) {
    const gm = document.getElementById("game-message");
    gm.textContent = "Game not yet active. Please connect/pay.";
    gm.style.display = "block";
    setTimeout(() => gm.style.display = "none", 1500);
    return;
  }
  resetGame();
  startCountdown();
};

window.startCountdown = function() { // Dibuat global untuk dipanggil dari parent
  const overlay = document.getElementById("countdown-overlay");
  let count = 3;
  
  overlay.classList.add('active'); 
  overlay.textContent = count;
  
  document.getElementById("game-message").style.display = "none";

  if(window.gameStartInterval) clearInterval(window.gameStartInterval);

  window.gameStartInterval = setInterval(()=>{
    count--;
    if(count > 0) {
        overlay.textContent = count;
    } else if (count === 0) {
        overlay.textContent = "GO!";
    } else {
        clearInterval(window.gameStartInterval);
        // Beri jeda singkat agar "GO!" terlihat sebelum game dimulai
        setTimeout(() => {
            overlay.classList.remove('active');
            ghostActive = true;
            gameRunning = true;
            lastMove = performance.now();
            document.getElementById("restart-button").style.display = "block";
            playBGM(); // Musik dimulai saat game mulai!
        }, 300); 
    }
  }, 1000);
}

/* ========== DRAWING & MOVEMENT (Omitted for brevity) ========== */
function drawMap(){
  // ... (Logika drawMap tidak berubah)
}

function drawPacman(){
  // ... (Logika drawPacman tidak berubah)
}

function drawGhosts(){
  // ... (Logika drawGhosts tidak berubah)
}

function canMove(x,y){
  if (y >= 8 && y <= 9 && x === -1) return true;
  if (y >= 8 && y <= 9 && x === MAP_W) return true;
  return mapData[y] && mapData[y][x] !== 1;
}

function movePacman(){
  let nx = pacman.x + (pacman.next==="right"?1:pacman.next==="left"?-1:0);
  let ny = pacman.y + (pacman.next==="down"?1:pacman.next==="up"?-1:0);

  // Logika Warp Tunnel (Sudah Benar)
  if (nx < 0 && pacman.y >= 8 && pacman.y <= 9) {
      pacman.x = MAP_W - 1; pacman.dir = pacman.next; return;
  }
  if (nx >= MAP_W && pacman.y >= 8 && pacman.y <= 9) {
      pacman.x = 0; pacman.dir = pacman.next; return;
  }

  // 1. Coba bergerak ke arah yang diminta (pacman.next)
  if(canMove(nx,ny)){
    pacman.x = nx; 
    pacman.y = ny; 
    pacman.dir = pacman.next; // Ganti arah saat gerakan berhasil
    return;
  }
  
  // 2. Jika gagal, coba pertahankan gerakan ke arah saat ini (pacman.dir)
  nx = pacman.x + (pacman.dir==="right"?1:pacman.dir==="left"?-1:0);
  ny = pacman.y + (pacman.dir==="down"?1:pacman.dir==="up"?-1:0);
  if(canMove(nx,ny)){
      pacman.x = nx; pacman.y = ny;
  }
}

function moveGhosts(){
  if(!ghostActive) return;

  ghosts.forEach(g=>{
    // 1. Tentukan semua langkah yang valid (tanpa menabrak dinding)
    const validMoves = [];
    const possibleDirs = [[1,0], [-1,0], [0,1], [0,-1]]; // [dx, dy]

    for(const [dx, dy] of possibleDirs){
        if(canMove(g.x + dx, g.y + dy)){
            validMoves.push({ x: g.x + dx, y: g.y + dy });
        }
    }

    if(validMoves.length === 0) return; 

    let nextMove = null;
    let shortestDist = Infinity;

    // 2. Cari langkah yang paling mendekati Pacman
    validMoves.forEach(m => {
        // Hitung jarak Manhattan (lebih cepat)
        const dist = Math.abs(pacman.x - m.x) + Math.abs(pacman.y - m.y);
        
        if (dist < shortestDist) {
            shortestDist = dist;
            nextMove = m;
        }
    });
    
    // 3. Implementasi AI: 80% mengejar, 20% gerakan acak dari langkah valid
    if (Math.random() < 0.8 && nextMove) {
        g.x = nextMove.x;
        g.y = nextMove.y;
    } else {
        // Gerakan acak dari langkah valid
        const randomMove = validMoves[Math.floor(Math.random() * validMoves.length)];
        g.x = randomMove.x;
        g.y = randomMove.y;
    }
  });
}

function checkCollision(){
  if(mapData[pacman.y][pacman.x] === 2){
    mapData[pacman.y][pacman.x] = 0;
    score += 10;
    document.getElementById("current-score-display").textContent = score;
    playDotSound();
    try { window.parent.postMessage({ type: "dotEaten" }, TRUSTED_ORIGIN); } catch(e){}
  }

  for(const g of ghosts){
    if(g.x === pacman.x && g.y === pacman.y){
      gameEnd(false);
      return;
    }
  }

  let win = true;
  for(let y=0;y<mapData.length;y++){
    for(let x=0;x<mapData[y].length;x++){
      if(mapData[y][x] === 2) { win = false; break; }
    }
    if(!win) break;
  }
  if(win) gameEnd(true);
}

function gameEnd(isWin){
  gameRunning=false;
  ghostActive=false;
  document.getElementById("restart-button").style.display = "block";

  const gm = document.getElementById("game-message");
  gm.textContent = (isWin ? "YOU WIN! " : "GAME OVER! ") + "Skor: " + score;
  gm.style.display = "block";
  
  stopBGM(); 

  // HANYA KIRIM SKOR JIKA SKOR > 0 DAN BELUM DISUBMIT
  if(score > 0 && !scoreSubmitted) { 
    scoreSubmitted = true;
    // Kirim pesan ke parent (app.js) untuk memulai transaksi submitScore
    try { 
        window.parent.postMessage({ type: "submitScore", score: score }, TRUSTED_ORIGIN); 
    } catch(e){
        console.error("Failed to post submitScore message:", e);
    }
  } else if (scoreSubmitted) {
    // Jika sudah disubmit, tampilkan pesan agar pemain membayar lagi
    gm.textContent = "Score submitted. Pay again to play new game.";
    gm.style.display = "block";
}
}

/* ========== LOOP ========== */
function update(ts){
  if(!gameRunning) return;
  if(!lastMove) lastMove = ts;
  const elapsed = ts - lastMove;
  if(elapsed > MOVE_INTERVAL){
    movePacman();
    moveGhosts();
    checkCollision();
    lastMove = ts;
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawMap();
  drawPacman();
  drawGhosts();
}

function loop(ts){
  update(ts);
  draw();
  animationFrameId = requestAnimationFrame(loop);
}

/* ================= MESSAGE & INPUT HANDLERS ================= */
window.addEventListener("message",(e)=>{
  if(e.origin !== TRUSTED_ORIGIN) return;
  
  if(e.data?.type==="paySuccess"){ // Dipicu dari app.js
    if(window.allowLocalPlay) return; 

    // Coba putar BGM segera saat menerima paySuccess
    if (!hasUserInteracted) {
        initAudioPool(); 
    }

    window.allowLocalPlay = true; 
    const gm = document.getElementById("game-message");
    gm.textContent = "PAYMENT SUCCESS! Starting Game...";
    gm.style.display = "block";
    
    // Panggil startCountdown() setelah jeda 1000ms
    setTimeout(() => {
        resetGame();
        startCountdown(); // <-- Memperbaiki Bug #2
    }, 1000); 
  }

  if(e.data?.type==="scoreSubmittedSuccess"){
    // Notifikasi opsional setelah transaksi submit skor berhasil di blockchain
    const gm = document.getElementById("game-message");
    gm.textContent = "Score submitted successfully!";
    gm.style.display = "block";
    window.allowLocalPlay = false; // Kunci game
  }
});

window.handleGameInput = function(direction){
  // Coba putar BGM saat ada interaksi pertama
  if (!hasUserInteracted) {
      initAudioPool();
  }

  if(!window.allowLocalPlay || !gameRunning) {
    const gm = document.getElementById("game-message");
    if (!document.getElementById("countdown-overlay").classList.contains('active')) {
        gm.textContent = "Please connect / pay to start the game.";
        gm.style.display = "block";
        setTimeout(()=> gm.style.display = "none", 1200);
    }
    return;
  }
  if(direction && typeof direction === "string"){
    pacman.next = direction.toLowerCase();
  }
};

/* INPUT HANDLERS D-PAD */
document.querySelectorAll("#mobileControls button").forEach(btn=>{
  const dir = btn.getAttribute("data-dir");
  const start = (ev) => { 
    ev.preventDefault(); 
    btn.style.transform = "translateY(2px)"; 
    window.handleGameInput(dir);
    if (!hasUserInteracted) initAudioPool(); 
  };
  const end = (ev) => { ev.preventDefault(); btn.style.transform = ""; };
  btn.addEventListener("touchstart", start, {passive:false});
  btn.addEventListener("mousedown", start);
  btn.addEventListener("touchend", end);
  btn.addEventListener("mouseup", end);
});

/* keyboard arrows */
window.addEventListener("keydown", (e)=>{
  const key = e.key.toLowerCase();
  if (!hasUserInteracted) initAudioPool(); 

  if(key==="arrowleft"||key==="a") window.handleGameInput("left");
  if(key==="arrowright"||key==="d") window.handleGameInput("right");
  if(key==="arrowup"||key==="w") window.handleGameInput("up");
  if(key==="arrowdown"||key==="s") window.handleGameInput("down");
});

/* ========== STARTUP ========== */
document.addEventListener('DOMContentLoaded', () => {
  resetGame();
  const gm = document.getElementById("game-message");
  gm.textContent = "Waiting for payment/connection...";
  gm.style.display = "block";
  requestAnimationFrame(loop);
});
})();
</script>
</body>
</html>

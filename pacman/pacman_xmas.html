<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Pacman XMAS Somnia</title>
    <style>
        body { background: #020617; color: white; display: flex; flex-direction: column; align-items: center; font-family: sans-serif; margin: 0; touch-action: manipulation; overflow-x: hidden; }
        #ui { font-size: 22px; font-weight: bold; margin: 15px 0; color: #fbbf24; text-shadow: 2px 2px #000; }
        canvas { border: 4px solid #1e40af; border-radius: 12px; background: #000; box-shadow: 0 0 30px rgba(30, 64, 175, 0.5); max-width: 95vw; }
        
        /* Navigasi Mobile */
        .controls { display: grid; grid-template-areas: ". up ." "left center right" ". down ."; gap: 10px; margin: 20px 0; }
        .btn { width: 65px; height: 65px; border-radius: 15px; border: none; background: #dc2626; color: white; font-size: 24px; font-weight: bold; box-shadow: 0 5px #991b1b; cursor: pointer; }
        .btn:active { transform: translateY(4px); box-shadow: 0 1px #991b1b; }

        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .msg-box { padding: 30px; border: 2px solid #fbbf24; border-radius: 15px; text-align: center; background: #010409; }
    </style>
</head>
<body>

<div id="ui">üéÖ Skor: <span id="score">0</span> <span id="pwr" style="display:none; color:#60a5fa"> | POWER!</span></div>

<div id="overlay">
    <div class="msg-box">
        <h2 id="status-text">Menunggu Pembayaran...</h2>
        <p style="color: #94a3b8;">Silakan selesaikan pembayaran untuk bermain</p>
    </div>
</div>

<canvas id="gameCanvas"></canvas>

<div class="controls">
    <button class="btn" style="grid-area:up" onclick="setDir('up')">‚Üë</button>
    <button class="btn" style="grid-area:left" onclick="setDir('left')">‚Üê</button>
    <button class="btn" style="grid-area:right" onclick="setDir('right')">‚Üí</button>
    <button class="btn" style="grid-area:down" onclick="setDir('down')">‚Üì</button>
</div>

<script>
(() => {
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const TILE = 24;

    // --- SESUAI DENGAN REPO GITHUB ANDA ---
    const GITHUB_BASE = "https://raw.githubusercontent.com/Ifunkkalem/Pacman.somniaxmas/main/";

    const sprites = {
        santa: new Image(),
        rudolph: new Image(), 
        dasher: new Image(),
        dancer: new Image(), 
        kelinci: new Image(),
        scared: new Image() // Anda bisa tambahkan file scared.png nanti
    };

    // Load Gambar (Sesuaikan nama file dengan daftar Anda)
    sprites.santa.src = GITHUB_BASE + "santa.png";
    sprites.rudolph.src = GITHUB_BASE + "rudolph.png";
    sprites.dasher.src = GITHUB_BASE + "dasher.png";
    sprites.dancer.src = GITHUB_BASE + "dancer.png";
    sprites.kelinci.src = GITHUB_BASE + "kelinci.png";
    sprites.scared.src = GITHUB_BASE + "scared.png"; 

    const MAP = [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,3,2,2,2,2,2,2,2,1,2,2,2,2,2,2,2,3,1],
        [1,2,1,1,2,1,1,1,2,1,2,1,1,1,2,1,1,2,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,2,1,1,2,1,2,1,1,1,1,1,2,1,2,1,1,2,1],
        [1,2,2,2,2,1,2,2,2,1,2,2,2,1,2,2,2,2,1],
        [1,1,1,1,2,1,1,1,0,1,0,1,1,1,2,1,1,1,1],
        [0,0,0,1,2,1,0,0,0,0,0,0,0,1,2,1,0,0,0],
        [1,1,1,1,2,1,0,1,1,1,1,1,0,1,2,1,1,1,1],
        [1,2,2,2,2,2,2,1,0,0,0,1,2,2,2,2,2,2,1],
        [1,1,1,1,2,1,0,1,1,1,1,1,0,1,2,1,1,1,1],
        [1,2,2,2,2,2,2,2,2,1,2,2,2,2,2,2,2,2,1],
        [1,3,1,1,2,1,1,1,2,1,2,1,1,1,2,1,1,3,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
    ];

    let mapData = MAP.map(row => [...row]);
    let pacman = { x: 9, y: 9, dir: "right", next: "right", pTime: 0 };
    let ghosts = [
        { x: 8, y: 7, s: 'rudolph', c: 'red', ox: 8, oy: 7, sc: false },
        { x: 9, y: 7, s: 'dasher', c: 'orange', ox: 9, oy: 7, sc: false },
        { x: 10, y: 7, s: 'dancer', c: 'pink', ox: 10, oy: 7, sc: false },
        { x: 9, y: 8, s: 'kelinci', c: 'white', ox: 9, oy: 8, sc: false }
    ];

    let score = 0;
    let gameRunning = false;

    // FUNGSI SAFE DRAW (Mencegah Crash Broken Image)
    function safeDraw(img, x, y, fallbackColor, isSanta = false) {
        if (img.complete && img.naturalWidth !== 0) {
            ctx.drawImage(img, x * TILE, y * TILE, TILE, TILE);
        } else {
            ctx.fillStyle = fallbackColor;
            if (isSanta) {
                ctx.beginPath(); ctx.arc(x*TILE + TILE/2, y*TILE + TILE/2, TILE/2 - 2, 0, Math.PI*2); ctx.fill();
            } else {
                ctx.fillRect(x*TILE + 4, y*TILE + 4, TILE - 8, TILE - 8);
            }
        }
    }

    function update() {
        if (!gameRunning) return;
        let nx = pacman.x, ny = pacman.y;
        if (pacman.next === "up") ny--; if (pacman.next === "down") ny++;
        if (pacman.next === "left") nx--; if (pacman.next === "right") nx++;

        if (mapData[ny] && mapData[ny][nx] !== 1) { pacman.x = nx; pacman.y = ny; }

        if (mapData[pacman.y][pacman.x] === 2) { mapData[pacman.y][pacman.x] = 0; score += 10; }
        if (mapData[pacman.y][pacman.x] === 3) { 
            mapData[pacman.y][pacman.x] = 0; score += 50; 
            pacman.pTime = 50; ghosts.forEach(g => g.sc = true);
            document.getElementById("pwr").style.display = "inline";
        }

        if (pacman.pTime > 0) {
            pacman.pTime--;
            if (pacman.pTime === 0) { ghosts.forEach(g => g.sc = false); document.getElementById("pwr").style.display = "none"; }
        }

        ghosts.forEach(g => {
            const dirs = [[0,1],[0,-1],[1,0],[-1,0]];
            const d = dirs[Math.floor(Math.random()*4)];
            if (mapData[g.y+d[1]] && mapData[g.y+d[1]][g.x+d[0]] !== 1) { g.x += d[0]; g.y += d[1]; }
            if (g.x === pacman.x && g.y === pacman.y) {
                if (g.sc) { score += 200; g.x = g.ox; g.y = g.oy; g.sc = false; }
                else { alert("Tangkap! Skor: " + score); location.reload(); }
            }
        });
        document.getElementById("score").innerText = score;
    }

    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        mapData.forEach((row, y) => {
            row.forEach((tile, x) => {
                if (tile === 1) { 
                    ctx.fillStyle = "#1e40af"; 
                    ctx.fillRect(x*TILE, y*TILE, TILE-1, TILE-1); 
                }
                else if (tile === 2) { 
                    ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(x*TILE+TILE/2, y*TILE+TILE/2, 2, 0, 7); ctx.fill(); 
                }
                else if (tile === 3) { 
                    ctx.fillStyle = "gold"; ctx.beginPath(); ctx.arc(x*TILE+TILE/2, y*TILE+TILE/2, 6, 0, 7); ctx.fill(); 
                }
            });
        });

        safeDraw(sprites.santa, pacman.x, pacman.y, "yellow", true);
        ghosts.forEach(g => safeDraw(g.sc ? sprites.scared : sprites[g.s], g.x, g.y, g.sc ? "blue" : g.c));
    }

    function loop() {
        update(); draw();
        setTimeout(() => requestAnimationFrame(loop), 180);
    }

    window.setDir = (d) => { pacman.next = d; };

    // Sinyal dari App.js
    window.addEventListener("message", (e) => {
        if (e.data.type === "paySuccess") {
            gameRunning = true;
            document.getElementById("overlay").style.display = "none";
        }
    });

    window.addEventListener("keydown", e => {
        if (e.key.startsWith("Arrow")) setDir(e.key.replace("Arrow", "").toLowerCase());
    });

    canvas.width = mapData[0].length * TILE;
    canvas.height = mapData.length * TILE;
    loop();
})();
</script>
</body>
</html>

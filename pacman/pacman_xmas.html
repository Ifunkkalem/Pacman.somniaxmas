<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pacman Natal</title>

<style>
html,body{height:100%;margin:0;background:#000;display:flex;align-items:center;justify-content:center;font-family:Trebuchet MS}
#ui{position:fixed;top:10px;left:10px;color:#fff;z-index:9}
#game-message{position:fixed;top:8px;right:8px;color:#fff;z-index:9}
canvas{background:#071024;border-radius:6px}

/* D-PAD */
#mobileControls{
position:fixed;
bottom:12px;
left:50%;
transform:translateX(-50%);
display:flex;
flex-direction: column;
align-items: center;
z-index:9;
}
#mobileControls button{
width:60px;height:60px;
margin:4px;
font-size:24px;
border-radius:8px;
border:none;
background: linear-gradient(90deg, #cc0000, #16a34a);
color:#fff;
}
.dpad-row{display:flex;width:100%;justify-content:space-between}
.center-filler{width:60px;height:60px}
</style>
</head>

<body>

<div id="ui">
  <div id="current-score-display">0</div>
  <div id="game-message" style="display:none;background:rgba(0,0,0,.7);padding:6px;border-radius:6px;margin-top:6px"></div>
</div>

<canvas id="pacman-canvas"></canvas>

<div id="mobileControls">
  <button data-dir="up">↑</button>
  <div class="dpad-row">
    <button data-dir="left">←</button>
    <div class="center-filler"></div>
    <button data-dir="right">→</button>
  </div>
  <button data-dir="down">↓</button>
</div>

<!-- ✅ AUDIO (PATH SUDAH BENAR) -->
<audio id="bgm" src="assets/music_background.mp3" loop></audio>
<audio id="sfxEat" src="assets/sfx_dot_eat.mp3"></audio>
<audio id="sfxStart" src="assets/sfx_start.mp3"></audio>

<script>
(function(){

const canvas = document.getElementById("pacman-canvas");
const ctx = canvas.getContext("2d");
const TILE_SIZE = 20;

/* ✅ MAP TIDAK DIUBAH */
const GAME_MAP = [
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
[1,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
[1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,2,1,2,1,1,1,1,2,1,2,1,1,1,2,1],
[1,2,2,2,2,2,1,2,2,2,2,2,2,1,2,2,2,2,2,1],
[1,1,1,1,1,2,1,1,1,0,0,1,1,1,2,1,1,1,1,1],
[0,0,0,0,1,2,1,0,0,0,0,0,0,1,2,1,0,0,0,0],
[1,1,1,1,1,2,1,0,1,1,1,1,0,1,2,1,1,1,1,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,2,1,1,1,1,1,1,1,1,2,1,1,1,2,1],
[1,2,2,2,1,2,2,2,2,1,1,2,2,2,2,1,2,2,2,1],
[1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

canvas.width = GAME_MAP[0].length * TILE_SIZE;
canvas.height = GAME_MAP.length * TILE_SIZE;

/* ✅ AUDIO FIX TOTAL */
const bgm = document.getElementById("bgm");
const sfxEat = document.getElementById("sfxEat");
const sfxStart = document.getElementById("sfxStart");
let audioUnlocked = false;

function unlockAudio(){
  if(audioUnlocked) return;
  audioUnlocked = true;
  bgm.play().catch(()=>{});
}
window.addEventListener("pointerdown", unlockAudio);

/* ✅ STATE */
let mapData, pacman, ghosts, score;
let gameRunning = false;
let ghostActive = false;
let lastMove = 0;
const MOVE_INTERVAL = 240;

/* ✅ RESET */
function resetGame(){
  mapData = GAME_MAP.map(r=>[...r]);
  pacman = {x:1,y:1,dir:"right",nextDir:"right",radius:7};
  ghosts = [{x:9,y:9},{x:10,y:9},{x:8,y:9}];
  score = 0;
  document.getElementById("current-score-display").textContent = score;
  document.getElementById("game-message").style.display="none";
  gameRunning=false;
}

/* ✅ DRAW */
function drawMap(){
  for(let y=0;y<mapData.length;y++){
    for(let x=0;x<mapData[y].length;x++){
      if(mapData[y][x]==1){
        ctx.fillStyle="#cc0000";
        ctx.fillRect(x*TILE_SIZE,y*TILE_SIZE,TILE_SIZE,TILE_SIZE);
      }else{
        ctx.fillStyle="#1a2c42";
        ctx.fillRect(x*TILE_SIZE,y*TILE_SIZE,TILE_SIZE,TILE_SIZE);
        if(mapData[y][x]==2){
          ctx.fillStyle="#facc15";
          ctx.beginPath();
          ctx.arc(x*TILE_SIZE+10,y*TILE_SIZE+10,3,0,Math.PI*2);
          ctx.fill();
        }
      }
    }
  }
}

function drawPacman(){
  ctx.fillStyle="#facc15";
  ctx.beginPath();
  ctx.arc(pacman.x*TILE_SIZE+10,pacman.y*TILE_SIZE+10,7,0,Math.PI*2);
  ctx.fill();
}

function drawGhosts(){
  ctx.fillStyle="#16a34a";
  ghosts.forEach(g=>{
    ctx.beginPath();
    ctx.arc(g.x*TILE_SIZE+10,g.y*TILE_SIZE+10,7,0,Math.PI*2);
    ctx.fill();
  });
}

/* ✅ MOVEMENT */
function canMove(x,y){
  return mapData[y] && mapData[y][x] !== 1;
}

function movePacman(){
  const d = pacman.nextDir;
  const nx = pacman.x + (d==="right"?1:d==="left"?-1:0);
  const ny = pacman.y + (d==="down"?1:d==="up"?-1:0);
  if(canMove(nx,ny)){ pacman.x=nx; pacman.y=ny; }
}

function moveGhosts(){
  if(!ghostActive) return;
  ghosts.forEach(g=>{
    const d=[[1,0],[-1,0],[0,1],[0,-1]][Math.floor(Math.random()*4)];
    if(canMove(g.x+d[0],g.y+d[1])){ g.x+=d[0]; g.y+=d[1]; }
  });
}

/* ✅ COLLISION & AUDIO */
function checkCollision(){
  if(mapData[pacman.y][pacman.x]==2){
    mapData[pacman.y][pacman.x]=0;
    score+=10;
    sfxEat.currentTime=0;
    sfxEat.play();
    document.getElementById("current-score-display").textContent=score;
  }
}

/* ✅ GAME LOOP FIX TOTAL */
function loop(ts){
  if(gameRunning && ts-lastMove>MOVE_INTERVAL){
    movePacman();
    moveGhosts();
    checkCollision();
    lastMove=ts;
  }
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawMap();
  drawPacman();
  drawGhosts();
  requestAnimationFrame(loop);
}

/* ✅ INPUT */
document.querySelectorAll("#mobileControls button").forEach(b=>{
  b.onclick=()=>{
    unlockAudio();
    pacman.nextDir=b.dataset.dir;
    if(!gameRunning) startGame();
  };
});

/* ✅ START */
function startGame(){
  if(gameRunning) return;
  sfxStart.play();
  bgm.play();
  ghostActive=true;
  gameRunning=true;
}

resetGame();
requestAnimationFrame(loop);

})();
</script>

</body>
</html>

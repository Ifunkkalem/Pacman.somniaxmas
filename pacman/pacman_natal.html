<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pacman Natal - Final (Fixed Timing & Audio)</title>
<style>
  /* --- STYLES DIPERBARUI UNTUK RESPONSIVITAS --- */
  html,body{height:100%;margin:0;background:#000;display:flex;align-items:center;justify-content:center;font-family:Trebuchet MS;overflow:hidden}
  
  /* UI elements positioning (relative to viewport/iframe) */
  #ui{position:fixed;top:10px;left:10px;color:#fff;z-index:99}
  #gameMessage{position:fixed;top:8px;right:8px;color:#fff;z-index:99}
  
  /* CANVAS: Responsif di dalam wadah iframe */
  canvas{
    background:#071024;
    border-radius:8px;
    box-shadow:0 0 25px #00ffcc,inset 0 0 20px #00ffcc;
    display:block;
    width: 95%; /* Akan disesuaikan oleh JS */
    height: auto; /* Akan disesuaikan oleh JS */
  }
  
  /* Level panel and overlays (tetap) */
  #levelPanel{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center;flex-direction:column;color:#fff;z-index:200}
  .levelBtn{margin:10px;padding:14px 26px;font-size:20px;border-radius:12px;border:none;background:#fbbf24;color:#000;cursor:pointer}
  #countdown{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center;font-size:120px;font-weight:bold;color:gold;z-index:300;text-shadow:0 0 30px gold}
  #victoryOverlay{position:fixed;inset:0;background:radial-gradient(circle,#00ffcc33,#000);display:none;align-items:center;justify-content:center;font-size:48px;font-weight:bold;color:gold;z-index:400;text-shadow:0 0 20px gold}

  /* Effects */
  .coin-sparkle{position:absolute;pointer-events:none;width:10px;height:10px;border-radius:50%;background:gold;opacity:1;animation:sparkle 0.6s forwards;z-index:110}
  @keyframes sparkle{from{transform:scale(1);opacity:1}to{transform:scale(2.8);opacity:0}}
  .shake{animation:shake 0.42s}
  @keyframes shake{0%{transform:translate(2px,1px)}25%{transform:translate(-2px,-3px)}50%{transform:translate(3px,2px)}75%{transform:translate(-2px,2px)}100%{transform:translate(0,0)}}
  .snow{position:fixed;top:-10px;color:white;font-size:12px;opacity:0.9;animation:fall linear forwards;z-index:10}
  @keyframes fall{to{transform:translateY(110vh)}}
</style>
</head>
<body>

<div id="ui">
  <div id="current-score-display">0</div>
  <div id="game-message" style="display:none;background:rgba(0,0,0,0.6);padding:6px;border-radius:6px;margin-top:6px"></div>
</div>

<canvas id="pacman-canvas"></canvas>

<div id="levelPanel">
  <h2 style="margin:0 0 12px 0;color:#fff">Pilih Level</h2>
  <button class="levelBtn" onclick="setLevel('easy')">EASY</button>
  <button class="levelBtn" onclick="setLevel('normal')">NORMAL</button>
  <button class="levelBtn" onclick="setLevel('hard')">HARD</button>
</div>

<div id="countdown">3</div>
<div id="victoryOverlay">üèÜ YOU WIN!</div>

<audio id="bgm" loop src="https://cdn.pixabay.com/audio/2022/10/25/audio_87c07c7a1f.mp3"></audio>
<audio id="sndCoin" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-coin-216.wav"></audio>
<audio id="sndWin" src="https://assets.mixkit.co/sfx/preview/mixkit-ethereal-fairy-win-sound-2019.wav"></audio>
<audio id="sndLose" src="https://assets.mixkit.co/sfx/preview/mixkit-arcade-retro-game-over-213.wav"></audio>

<script>
/* ============================
   Pacman Fixed: consistent timing + audio fallback logs
   ============================ */

/* CONFIG */
const TILE_SIZE = 20; // Nilai awal (default)
const canvas = document.getElementById('pacman-canvas');
const ctx = canvas.getContext('2d');

/* MAP (unchanged labyrinth) */
const GAME_MAP = [
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
  [1,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,1],
  [1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
  [1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
  [1,2,1,1,1,2,1,2,1,1,1,1,2,1,2,1,1,1,2,1],
  [1,2,2,2,2,2,1,2,2,2,2,2,2,1,2,2,2,2,2,1],
  [1,1,1,1,1,2,1,1,1,0,0,1,1,1,2,1,1,1,1,1],
  [0,0,0,0,1,2,1,0,0,0,0,0,0,1,2,1,0,0,0,0],
  [1,1,1,1,1,2,1,0,1,1,1,1,0,1,2,1,1,1,1,1],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
  [1,2,1,1,1,2,1,1,1,1,1,1,1,1,2,1,1,1,2,1],
  [1,2,2,2,1,2,2,2,2,1,1,2,2,2,2,1,2,2,2,1],
  [1,1,2,1,1,1,1,1,2,1,1,2,1,1,1,1,1,2,1,1],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
  [1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
  [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const MAP_WIDTH = GAME_MAP[0].length;
const MAP_HEIGHT = GAME_MAP.length;

/* STATE */
let pacman, ghosts, score, mapData;
let gameRunning = false;
let animationFrameId = null;
let lastTime = 0;
let GAME_UPDATE_INTERVAL = 150; 
window.currentTileSize = TILE_SIZE; // Variabel global untuk ukuran tile responsif

/* AUDIO ELEMENTS */
const bgm = document.getElementById('bgm');
const sndWin = document.getElementById('sndWin');
const sndLose = document.getElementById('sndLose');
const victoryOverlay = document.getElementById('victoryOverlay');

/* --- FUNGSI BARU: SKALA RESPONSIVE (PENTING!) --- */
function resizeCanvas(){
    const maxDim = Math.min(window.innerWidth, window.innerHeight);
    let effectiveWidth;
    
    if(window.innerWidth > window.innerHeight){
        effectiveWidth = Math.min(maxDim * 0.9, 800); 
    } else {
        effectiveWidth = window.innerWidth * 0.9;
    }

    const newCanvasWidth = Math.floor(effectiveWidth / MAP_WIDTH) * MAP_WIDTH;
    
    canvas.width = newCanvasWidth;
    canvas.height = newCanvasWidth / MAP_WIDTH * MAP_HEIGHT;
    
    window.currentTileSize = canvas.width / MAP_WIDTH; 

    drawOnce(); 
}

window.addEventListener('resize', resizeCanvas);
/* --- AKHIR FUNGSI SKALA RESPONSIVE --- */


/* RESET/INIT */
function resetMapData(){
  const ts = window.currentTileSize;
  mapData = GAME_MAP.map(row=>[...row]);
  score = 0;
  // Menggunakan currentTileSize di sini
  pacman = { x:1, y:1, dir:'right', nextDir:'right', radius:ts/2.5 };
  ghosts = [
    { x:9, y:9, color:'#cc0000', dir:'up' },
    { x:10, y:9, color:'#16a34a', dir:'down' },
    { x:8, y:9, color:'#2563eb', dir:'left' }
  ];
  document.getElementById('current-score-display').textContent = score;
}

function drawMap(){
  const ts = window.currentTileSize;
  for(let y=0;y<MAP_HEIGHT;y++){
    for(let x=0;x<MAP_WIDTH;x++){
      const t = mapData[y][x];
      if(t === 1){
        ctx.fillStyle = '#b91c1c';
        ctx.fillRect(x*ts,y*ts,ts,ts);
        ctx.strokeStyle = '#ffffff'; ctx.lineWidth = 1;
        ctx.strokeRect(x*ts,y*ts,ts,ts);
      } else {
        ctx.fillStyle = '#020617';
        ctx.fillRect(x*ts,y*ts,ts,ts);
        if(t === 2){
          ctx.fillStyle = '#facc15';
          ctx.beginPath();
          ctx.arc(x*ts + ts/2, y*ts + ts/2, Math.max(2, ts/8), 0, Math.PI*2);
          ctx.fill();
        }
      }
    }
  }
}

/* --- FUNGSI BARU: drawPacman (Tema Natal) --- */
function drawPacman(){
  const ts = window.currentTileSize;
  const radius = ts/2.5; 
  const x = pacman.x*ts + ts/2;
  const y = pacman.y*ts + ts/2;
  
  // 1. Gambar Pac-Man (Kuning, mulut menganga)
  ctx.fillStyle = '#facc15';
  ctx.beginPath();
  const mouthOpen = Math.abs(Math.sin(Date.now()/100));
  const angleOffset = { 'right':0,'left':Math.PI,'up':-Math.PI/2,'down':Math.PI/2 }[pacman.dir];
  const startAngle = angleOffset + mouthOpen*0.4;
  const endAngle = angleOffset - mouthOpen*0.4 + 2*Math.PI;
  ctx.arc(x,y,radius,startAngle,endAngle,false);
  ctx.lineTo(x,y);
  ctx.closePath();
  ctx.fill();

  // 2. Tambah Topi Santa üéÖ
  const hatX = x;
  const hatY = y - radius * 0.8; 

  // Topi Merah (Kerucut)
  ctx.fillStyle = '#cc0000'; 
  ctx.beginPath();
  ctx.moveTo(hatX - radius*0.7, hatY); 
  ctx.lineTo(hatX + radius*0.8, hatY); 
  ctx.lineTo(hatX + radius*0.5, hatY - radius * 1.5); 
  ctx.closePath();
  ctx.fill();

  // Trim Putih (Pinggiran topi)
  ctx.fillStyle = '#ffffff'; 
  ctx.beginPath();
  ctx.arc(hatX, hatY, radius*0.8, 0, Math.PI, true); 
  ctx.fill();

  // Pom-pom (Ujung topi)
  ctx.beginPath();
  ctx.arc(hatX + radius*0.5, hatY - radius*1.5, radius*0.3, 0, Math.PI*2);
  ctx.fill();
}
/* --- AKHIR FUNGSI drawPacman --- */

/* --- FUNGSI BARU: drawGhosts (Tema Natal) --- */
function drawGhosts(){
  const ts = window.currentTileSize;
  ghosts.forEach(g=>{
    const x = g.x*ts + ts/2;
    const y = g.y*ts + ts/2;
    
    // 1. Gambar Ghost Dasar (Tubuh)
    ctx.fillStyle = g.color;
    ctx.beginPath();
    ctx.arc(x,y,ts/2,Math.PI,0,false);
    ctx.fillRect(x-ts/2, y, ts, ts/2);
    ctx.fill();

    // 2. Tambah Topi Santa üéÑ
    const hatX = x;
    const hatY = y - ts/2 * 0.9; 

    // Topi Merah
    ctx.fillStyle = '#cc0000'; 
    ctx.beginPath();
    ctx.moveTo(hatX - ts/3, hatY); 
    ctx.lineTo(hatX + ts/3, hatY); 
    ctx.lineTo(hatX + ts/4, hatY - ts * 0.7); 
    ctx.closePath();
    ctx.fill();

    // Trim Putih
    ctx.fillStyle = '#ffffff'; 
    ctx.beginPath();
    ctx.arc(hatX, hatY, ts/3, 0, Math.PI, true); 
    ctx.fill();

    // Pom-pom
    ctx.beginPath();
    ctx.arc(hatX + ts/4, hatY - ts*0.7, ts*0.1, 0, Math.PI*2);
    ctx.fill();

    // 3. Tambah Syal Natal (Hijau & Putih) üß£
    // Bagian Utama Syal (Hijau)
    ctx.fillStyle = '#10b981'; // Hijau Natal
    ctx.fillRect(x - ts/2, y + ts/4, ts, ts/8); // Melintang di leher
    
    // Ekor Syal (Kain menggantung)
    ctx.fillRect(x - ts/4, y + ts/4, ts/10, ts/3); 

    // Aksen Putih (Garis tengah syal)
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(x - ts/2, y + ts/4 + ts/40, ts, ts/40); 

    // 4. Ghost Eyes (LOGIC LAMA: harus di gambar terakhir)
    ctx.fillStyle = 'white';
    ctx.beginPath();
    ctx.arc(x - ts/4, y - ts/4, ts/8, 0, Math.PI*2);
    ctx.arc(x + ts/4, y - ts/4, ts/8, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = 'black';
    ctx.beginPath();
    ctx.arc(x - ts/4 + 1, y - ts/4, ts/16, 0, Math.PI*2);
    ctx.arc(x + ts/4 + 1, y - ts/4, ts/16, 0, Math.PI*2);
    ctx.fill();
  });
}
/* --- AKHIR FUNGSI drawGhosts --- */

function drawOnce(){ ctx.clearRect(0,0,canvas.width,canvas.height); drawMap(); drawPacman(); drawGhosts(); }

/* MOVEMENT */
function canMove(x,y){ return mapData[y] && mapData[y][x] !== 1; }

function movePacman(){
  // Logic pergerakan Pacman (tidak diubah)
  const nd = pacman.nextDir;
  const nx = pacman.x + (nd==='right'?1:nd==='left'?-1:0);
  const ny = pacman.y + (nd==='down'?1:nd==='up'?-1:0);
  if(canMove(nx,ny)){
    pacman.dir = pacman.nextDir;
    pacman.x = nx; pacman.y = ny;
  } else {
    const cx = pacman.x + (pacman.dir==='right'?1:pacman.dir==='left'?-1:0);
    const cy = pacman.y + (pacman.dir==='down'?1:pacman.dir==='up'?-1:0);
    if(canMove(cx,cy)){ pacman.x = cx; pacman.y = cy; }
  }
  if(pacman.x < 0) pacman.x = MAP_WIDTH - 1;
  if(pacman.x >= MAP_WIDTH) pacman.x = 0;
}

let ghostMoveSkip = 0;
function moveGhosts(){
  ghostMoveSkip++;
  if(ghostMoveSkip % 2 !== 0) return;
  ghosts.forEach(g=>{
    const possible = [];
    const moves = [{dx:1,dy:0,dir:'right'},{dx:-1,dy:0,dir:'left'},{dx:0,dy:1,dir:'down'},{dx:0,dy:-1,dir:'up'}];
    moves.forEach(m=>{
      const nx = g.x + m.dx, ny = g.y + m.dy;
      if(canMove(nx,ny)) possible.push(m);
    });
    if(possible.length > 0){
      possible.sort((a,b)=>{
        const ax = g.x + a.dx - pacman.x, ay = g.y + a.dy - pacman.y;
        const bx = g.x + b.dx - pacman.x, by = g.y + b.dy - pacman.y;
        return Math.hypot(ax,ay) - Math.hypot(bx,by);
      });
      const pick = Math.random() < 0.7 ? possible[0] : possible[Math.floor(Math.random() * possible.length)];
      g.x += pick.dx; g.y += pick.dy; g.dir = pick.dir;
    }
  });
}

/* COLLISION & SCORE */
function spawnSparkle(gridX, gridY){
  const ts = window.currentTileSize;
  const el = document.createElement('div');
  el.className = 'coin-sparkle';
  const rect = canvas.getBoundingClientRect();
  const left = rect.left + gridX * ts + ts/2 - 5;
  const top = rect.top + gridY * ts + ts/2 - 5;
  el.style.left = left + 'px';
  el.style.top = top + 'px';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),700);
}

function checkCollision(){
  if(mapData[pacman.y][pacman.x] === 2){
    mapData[pacman.y][pacman.x] = 0;
    score += 10;
    if(score > 3000) score = 3000;
    document.getElementById('current-score-display').textContent = score;
    spawnSparkle(pacman.x, pacman.y);
    
    // --- INTEGRASI SUARA BARU: Kirim pesan ke parent (app.js) ---
    window.parent.postMessage({ type: 'dotEaten' }, '*');
  }
  for(const g of ghosts){
    if(g.x === pacman.x && g.y === pacman.y){
      endGame(false); return;
    }
  }
  const dotsRemaining = mapData.flat().filter(c => c === 2).length;
  if(dotsRemaining === 0) endGame(true);
}

/* END GAME */
function endGame(isWin){
  if(!gameRunning) return;
  gameRunning = false;
  if(animationFrameId) cancelAnimationFrame(animationFrameId);
  canvas.classList.add('shake');
  setTimeout(()=>canvas.classList.remove('shake'),420);

  const gm = document.getElementById('game-message');
  const msg = isWin ? "SELAMAT! Anda menang dan membersihkan semua hadiah!" : "Misi Gagal! Grinch berhasil mencuri semua hadiah!";
  gm.textContent = msg + " Skor: " + score;
  gm.style.display = 'block';

  try{ bgm.pause(); bgm.currentTime = 0; } catch(e){}
  if(isWin){ try{ sndWin.play(); } catch(e){ console.warn('sndWin fail', e); } victoryOverlay.style.display='flex'; setTimeout(()=>victoryOverlay.style.display='none',3500); }
  else { try{ sndLose.play(); } catch(e){ console.warn('sndLose fail', e); } }

  if(score > 0 || isWin){
    window.parent.postMessage({ type: 'submitScore', score: score }, '*');
  } else {
    window.parent.postMessage({ type: 'notifyNoScore' }, '*');
  }

  setTimeout(()=>{
    gm.style.display='none';
    window.parent.postMessage({ type: 'showLeaderboard' }, '*');
  }, 4000);
}

/* GAME LOOP */
function gameLoop(timestamp){
  if(!gameRunning) return;
  if(!lastTime) lastTime = timestamp;
  const dt = timestamp - lastTime;
  if(dt >= GAME_UPDATE_INTERVAL){
    movePacman();
    moveGhosts();
    checkCollision();
    lastTime = timestamp;
  }
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawMap(); drawPacman(); drawGhosts();
  animationFrameId = requestAnimationFrame(gameLoop);
}

/* -------------------------
   Level / Countdown / Start
   ------------------------- */
const levelPanel = document.getElementById('levelPanel');
const countdownEl = document.getElementById('countdown');

function setLevel(lvl){
  if(lvl === 'easy') GAME_UPDATE_INTERVAL = 220;
  if(lvl === 'normal') GAME_UPDATE_INTERVAL = 150;
  if(lvl === 'hard') GAME_UPDATE_INTERVAL = 95;
  levelPanel.style.display = 'none';
  startCountdownAndStart();
}

function startCountdownAndStart(){
  lastTime = 0;
  resetMapData();
  countdownEl.style.display = 'flex';
  let n = 3;
  countdownEl.textContent = n;
  const t = setInterval(()=>{
    n--;
    if(n === 0){
      countdownEl.textContent = 'GO!';
    } else if(n < 0){
      clearInterval(t);
      countdownEl.style.display = 'none';
      startGameLoop();
    } else {
      countdownEl.textContent = n;
    }
  },1000);
}

function startGameLoop(){
  try{
    bgm.volume = 0.35;
    const playPromise = bgm.play();
    if(playPromise && playPromise.catch){
      playPromise.catch(err => {
        console.warn('BGM play blocked by browser:', err);
      });
    }
  } catch(e){ console.warn('bgm play error', e); }

  gameRunning = true;
  lastTime = 0; 
  animationFrameId = requestAnimationFrame(gameLoop);
}

/* -------------------------
   Parent communication (pay + fee + mobile input)
   ------------------------- */
function safeResetAndShowLevel(){
  gameRunning = false;
  if(animationFrameId) cancelAnimationFrame(animationFrameId);
  resetMapData();
  drawOnce();
  levelPanel.style.display = 'flex';
}

window.addEventListener('message',(ev)=>{
  const d = ev.data || {};
  if(d.type === 'paySuccess'){
    safeResetAndShowLevel();
  }
  if(d.type === 'startFee'){
    const gm = document.getElementById('game-message');
    gm.textContent = `Fee to start: ${d.feeEth} SOMI`;
    gm.style.display = 'block';
    setTimeout(()=>gm.style.display='none',4000);
  }
  
  // --- INTEGRASI KONTROL MOBILE BARU ---
  if(d.type === 'mobileInput' && gameRunning){
      const dir = d.direction.toLowerCase();
      if(dir !== 'stop'){
          pacman.nextDir = dir;
      }
  }
});

/* ask parent for fee info once */
window.parent.postMessage({ type:'requestStartFee' }, '*');

/* -------------------------
   Controls (Hanya Keyboard)
   ------------------------- */
// Menghapus listeners mobile controls lama
window.addEventListener('keydown',(e)=>{
  if(e.key === 'ArrowUp') pacman.nextDir='up';
  if(e.key === 'ArrowDown') pacman.nextDir='down';
  if(e.key === 'ArrowLeft') pacman.nextDir='left';
  if(e.key === 'ArrowRight') pacman.nextDir='right';
});

/* -------------------------
   Snow effect
   ------------------------- */
setInterval(()=>{
  const s=document.createElement('div');
  s.className='snow';
  s.innerText='‚ùÑ';
  s.style.left = (Math.random()*100) + 'vw';
  s.style.fontSize = (8 + Math.random()*18) + 'px';
  s.style.animationDuration = (3 + Math.random()*6) + 's';
  document.body.appendChild(s);
  setTimeout(()=>s.remove(),9000);
},140);

/* -------------------------
   Initialization
   ------------------------- */
function resetGame(){
  resetMapData();
  score = 0;
  document.getElementById('current-score-display').textContent = score;
  const gm = document.getElementById('game-message');
  gm.style.display = 'none';
  gameRunning = false;
  if(animationFrameId) cancelAnimationFrame(animationFrameId);
  
  // Panggil resizeCanvas agar game diskalakan di awal
  resizeCanvas(); 
  drawOnce();
}

resetGame();
</script>

</body>
</html>

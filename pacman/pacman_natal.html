<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Somnia Christmas Pacman</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  background: radial-gradient(circle at top, #7f1d1d, #020617);
  overflow: hidden;
}

canvas {
  display: block;
  margin: auto;
  background: #0f172a;
}

/* ✅ CONTROL PAD BESAR & NYAMAN */
.control-pad {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  display: grid;
  grid-template-areas:
    ". up ."
    "left down right";
  grid-gap: 14px;
  z-index: 9999;
}

.pad-btn {
  width: 70px;
  height: 70px;
  border-radius: 50%;
  background: radial-gradient(circle, #22c55e, #15803d);
  color: white;
  font-size: 26px;
  font-weight: bold;
  border: none;
  box-shadow: 0 0 12px #22c55e;
}

/* ✅ COUNTDOWN */
#countdown {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  display: none;
  align-items: center;
  justify-content: center;
  font-size: 120px;
  font-weight: bold;
  color: gold;
  z-index: 99999;
  text-shadow: 0 0 30px gold;
}

#game-message {
  position: fixed;
  inset: 0;
  display: none;
  justify-content: center;
  align-items: center;
  font-size: 40px;
  color: gold;
  background: rgba(0,0,0,0.85);
  z-index: 99999;
}
</style>
</head>
<body>

<canvas id="pacman-canvas"></canvas>

<div id="countdown">3</div>
<div id="game-message"></div>

<!-- ✅ MOBILE PAD -->
<div class="control-pad">
  <button class="pad-btn" style="grid-area: up" ontouchstart="setDir('up')">▲</button>
  <button class="pad-btn" style="grid-area: left" ontouchstart="setDir('left')">◀</button>
  <button class="pad-btn" style="grid-area: down" ontouchstart="setDir('down')">▼</button>
  <button class="pad-btn" style="grid-area: right" ontouchstart="setDir('right')">▶</button>
</div>

<script>
/* ✅ UKURAN TILE RESPONSIVE */
const TILE_SIZE = window.innerWidth < 768 ? 28 : 24;

const canvas = document.getElementById('pacman-canvas');
const ctx = canvas.getContext('2d');

/* ✅ MAP */
const GAME_MAP = [
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
[1,2,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,2,1],
[1,2,1,1,1,2,1,1,2,1,1,2,1,1,2,1,1,1,2,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,1,1,1,1,2,1,1,1,0,0,1,1,1,2,1,1,1,1,1],
[1,2,2,2,2,2,1,2,2,2,2,2,2,1,2,2,2,2,2,1],
[1,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,1],
[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
];

const MAP_WIDTH = GAME_MAP[0].length;
const MAP_HEIGHT = GAME_MAP.length;
canvas.width = MAP_WIDTH * TILE_SIZE;
canvas.height = MAP_HEIGHT * TILE_SIZE;

/* ✅ GAME STATE */
let pacman, ghosts, score, gameRunning = false;
let mapData = [];
let animationFrameId = null;
let ghostMoveSkip = 0;

/* ✅ RESET */
function resetMapData() {
  mapData = GAME_MAP.map(row => [...row]);
  score = 0;
  pacman = { x: 1, y: 1, dir: "right", nextDir: "right", radius: TILE_SIZE / 2.5 };

  ghosts = [
    { x: 8, y: 3, color: "#cc0000" },
    { x: 9, y: 3, color: "#16a34a" },
    { x: 10,y: 3, color: "#2563eb" }
  ];
}

function setDir(d) {
  pacman.nextDir = d;
}

/* ✅ DRAW */
function drawMap() {
  for (let y = 0; y < MAP_HEIGHT; y++) {
    for (let x = 0; x < MAP_WIDTH; x++) {
      if (mapData[y][x] === 1) {
        ctx.fillStyle = "#b91c1c";
        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
      } else {
        ctx.fillStyle = "#020617";
        ctx.fillRect(x*TILE_SIZE, y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
        if (mapData[y][x] === 2) {
          ctx.fillStyle = "#facc15";
          ctx.beginPath();
          ctx.arc(x*TILE_SIZE+TILE_SIZE/2, y*TILE_SIZE+TILE_SIZE/2, 4, 0, Math.PI*2);
          ctx.fill();
        }
      }
    }
  }
}

function drawPacman() {
  const x = pacman.x*TILE_SIZE+TILE_SIZE/2;
  const y = pacman.y*TILE_SIZE+TILE_SIZE/2;
  ctx.fillStyle = "#facc15";
  ctx.beginPath();
  ctx.arc(x,y,pacman.radius,0,Math.PI*2);
  ctx.fill();
}

function drawGhosts() {
  ghosts.forEach(g => {
    ctx.fillStyle = g.color;
    ctx.beginPath();
    ctx.arc(g.x*TILE_SIZE+TILE_SIZE/2, g.y*TILE_SIZE+TILE_SIZE/2, TILE_SIZE/2.5, 0, Math.PI*2);
    ctx.fill();
  });
}

/* ✅ MOVEMENT */
function movePacman() {
  const dir = pacman.nextDir;
  const dx = dir==="right"?1:dir==="left"?-1:0;
  const dy = dir==="down"?1:dir==="up"?-1:0;
  if (mapData[pacman.y+dy]?.[pacman.x+dx] !== 1) {
    pacman.x += dx;
    pacman.y += dy;
  }

  if (mapData[pacman.y][pacman.x] === 2) {
    mapData[pacman.y][pacman.x] = 0;
    score += 10;
  }
}

function moveGhosts() {
  ghostMoveSkip++;
  if (ghostMoveSkip % 2 !== 0) return;

  ghosts.forEach(g => {
    const dirs = [
      {dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:1},{dx:0,dy:-1}
    ];
    const m = dirs[Math.floor(Math.random()*dirs.length)];
    if (mapData[g.y+m.dy]?.[g.x+m.dx] !== 1) {
      g.x += m.dx;
      g.y += m.dy;
    }

    if (g.x === pacman.x && g.y === pacman.y) endGame();
  });
}

function endGame() {
  gameRunning = false;
  cancelAnimationFrame(animationFrameId);
  document.getElementById("game-message").style.display = "flex";
  document.getElementById("game-message").innerText = "GAME OVER";

  parent.postMessage({ type:"submitScore", score }, "*");
}

/* ✅ GAME LOOP (DIPERLAMBAT) */
const GAME_UPDATE_INTERVAL = 220;
let lastTick = 0;

function gameLoop(t) {
  if (!gameRunning) return;
  if (t-lastTick > GAME_UPDATE_INTERVAL) {
    lastTick = t;
    movePacman();
    moveGhosts();
  }

  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawMap();
  drawPacman();
  drawGhosts();
  animationFrameId = requestAnimationFrame(gameLoop);
}

/* ✅ COUNTDOWN SETELAH TX */
function startCountdownThenGame() {
  resetMapData();
  const cd = document.getElementById("countdown");
  let n = 3;
  cd.style.display = "flex";
  cd.innerText = n;

  const timer = setInterval(()=>{
    n--;
    if (n === 0) cd.innerText = "GO!";
    else if (n < 0) {
      clearInterval(timer);
      cd.style.display = "none";
      gameRunning = true;
      requestAnimationFrame(gameLoop);
    } else cd.innerText = n;
  },1000);
}

/* ✅ LISTEN DARI INDEX SETELAH PAY SUKSES */
window.addEventListener("message", (e)=>{
  if (e.data?.type === "paySuccess") {
    document.getElementById("game-message").style.display="none";
    startCountdownThenGame();
  }
});
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Somnia Halloween Labyrinth</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  
  <!-- ETHERS.JS untuk transaksi Web3 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900;800;300&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body {
      background-color: #0a0010; color: #fff; display: flex; flex-direction: column; align-items: center; min-height: 100vh; padding: 20px 10px;
    }
    .game-container {
      width: 100%; max-width: 400px; display: flex; flex-direction: column; align-items: center; gap: 15px;
    }
    .header-info {
      width: 100%; display: flex; justify-content: space-between; align-items: center; padding: 10px 0; font-size: 1.1em; color: #ff8c00;
    }
    #gameCanvas {
      background-color: #000; border: 3px solid #800080; box-shadow: 0 0 15px #800080, 0 0 5px #ff8c00; border-radius: 12px; touch-action: none;
    }
    .controls-area {
      width: 100%; display: flex; flex-direction: column; align-items: center; margin-top: 15px;
    }
    .dpad-container {
      display: grid; grid-template-areas: ". up ." "left . right" ". down ."; gap: 10px; margin-bottom: 20px;
    }
    .control-btn {
      width: 60px; height: 60px; border-radius: 50%; background: linear-gradient(145deg, #ff8c00, #ffb703); color: #333; font-size: 1.5em; border: none; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4), inset 0 2px 4px rgba(255, 255, 255, 0.5); cursor: pointer; transition: all 0.1s ease;
    }
    .control-btn:active { transform: scale(0.95); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4), inset 0 1px 2px rgba(0, 0, 0, 0.5); }
    #upBtn { grid-area: up; } #leftBtn { grid-area: left; } #rightBtn { grid-area: right; } #downBtn { grid-area: down; }
    .action-buttons button { padding: 12px 25px; margin: 10px 5px; font-size: 1em; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; transition: 0.2s; }
    #startBtn { background: linear-gradient(90deg, #1e8449, #2ecc71); color: white; }
    #startBtn:hover { box-shadow: 0 0 10px #2ecc71; }
    #startBtn:disabled { background: #444; cursor: not-allowed; opacity: 0.7; }
    #backBtn { background: linear-gradient(90deg, #c0392b, #e74c3c); color: white; }
    #backBtn:hover { box-shadow: 0 0 10px #e74c3c; }
    .game-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; font-size: 1.5em; z-index: 100; padding: 20px;
    }
    .overlay-content {
      background: rgba(20, 0, 30, 0.98); border: 2px solid #ff8c00; border-radius: 16px; padding: 30px; box-shadow: 0 0 20px #800080;
    }
    .overlay-content h3 { color: #ff8c00; margin-bottom: 20px; font-size: 1.5em; }
    .overlay-content button { margin-top: 15px; padding: 10px 20px; font-weight: bold; border-radius: 8px; cursor: pointer; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<div class="game-container">
    <div class="header-info">
      <span id="playerDisplay">Memuat Profil...</span>
      <span id="scoreDisplay">Score: 0</span>
    </div>

    <!-- CANVAS GAME -->
    <canvas id="gameCanvas"></canvas>
    
    <!-- Area Kontrol (untuk mobile/sentuhan) -->
    <div class="controls-area">
        <div class="dpad-container">
            <button id="upBtn" class="control-btn">‚Üë</button>
            <button id="leftBtn" class="control-btn">‚Üê</button>
            <button id="rightBtn" class="control-btn">‚Üí</button>
            <button id="downBtn" class="control-btn">‚Üì</button>
        </div>

        <div class="action-buttons">
            <button id="startBtn">START GAME (Bayar 0.01 SOMI)</button>
            <button id="backBtn" onclick="window.location.href='index.html'">BACK TO MENU</button>
        </div>
    </div>
</div>

<!-- üí∞ Transaction Overlay -->
<div id="txOverlay" class="game-overlay hidden">
    <div class="overlay-content">
        <h3 id="txStatusTitle">Memproses Transaksi...</h3>
        <p id="txStatusMessage">Harap konfirmasi transaksi di dompet Anda untuk memulai permainan (0.01 SOMI).</p>
        <button id="closeTxOverlay" class="hidden" onclick="closeOverlay('txOverlay')">Tutup</button>
    </div>
</div>

<!-- üëª Game Over Overlay -->
<div id="gameOverOverlay" class="game-overlay hidden">
    <div class="overlay-content">
        <h3>GAME OVER!</h3>
        <p>Skor Anda: <span id="finalScore">0</span></p>
        <!-- Status penting: Hanya melaporkan status Global Save -->
        <p id="saveStatusMessage" style="font-size: 0.8em;"></p> 
        <button id="playAgainBtn" style="background: #2ecc71; color: white;">Main Lagi</button>
        <button id="menuFromGameOverBtn" style="background: #e74c3c; color: white;" onclick="window.location.href='index.html'">Kembali ke Menu</button>
    </div>
</div>

<!-- Logika Game dan Web3 (Hanya Firestore) -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, addDoc, collection, doc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    setLogLevel('Debug');

    // ====================================================================
    // --- FIREBASE & PROFILE SETUP (NO STORAGE/FALLBACKS) ---
    // ====================================================================
    const appId = typeof __app_id !== 'undefined' ? __app_id : null;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const rawFirebaseConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
    
    let db = null;
    let auth = null;
    let firebaseReady = false;
    let profileLoaded = false;
    
    let playerProfile = {
        userId: null, // Internal Firebase UID (disembunyikan dari publik)
        displayName: null,
        walletAddress: null // Identitas Publik
    };

    function formatWallet(address) {
        if (!address) return 'N/A';
        return `${address.substring(0, 6)}...${address.slice(-4)}`;
    }

    // Muat profil dari Firestore setelah otentikasi
    async function fetchPlayerProfile(uid) {
        if (!db || !uid || !appId) {
            console.error("DB/Auth Gagal: Tidak dapat memuat profil.");
            return;
        }

        const docRef = doc(db, 'artifacts', appId, 'users', uid, 'config', 'profile');
        try {
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                playerProfile.userId = uid;
                playerProfile.displayName = data.displayName || 'Anon Player';
                playerProfile.walletAddress = data.wallet || null;
            } else {
                 // Jika doc tidak ada, buat profil minimal
                 playerProfile.userId = uid;
                 playerProfile.displayName = 'Anon Player';
                 playerProfile.walletAddress = null;
            }
        } catch (e) {
            console.error("Gagal memuat profil pemain dari Firestore:", e);
        } finally {
            profileLoaded = true;
            updateHeaderDisplay();
            showStartScreen(); // Panggil setelah profil siap
        }
    }
    
    async function initializeFirebase() {
        try {
             if (!rawFirebaseConfig || !appId) throw new Error("Firebase config not available from environment.");
             const firebaseConfig = JSON.parse(rawFirebaseConfig);

            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            if (initialAuthToken) { 
                await signInWithCustomToken(auth, initialAuthToken); 
            } else { 
                await signInAnonymously(auth); 
            }
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    firebaseReady = true;
                    fetchPlayerProfile(user.uid);
                } else {
                    throw new Error("Firebase authentication failed.");
                }
            });

        } catch (error) {
            console.error("Critical Error during Firebase Init:", error);
            // Non-operasional jika DB gagal
            db = null; 
            showStartScreen(); 
        }
    }
    
    // ====================================================================
    // --- GAME STATE & UI CONTROLS ---
    // ====================================================================

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const playerDisplay = document.getElementById('playerDisplay');
    const startBtn = document.getElementById('startBtn');
    
    let gameScore = 0;
    let gameRunning = false;
    let pacman = { x: 50, y: 50, radius: 10, color: 'yellow', dx: 0, dy: 0, speed: 5 };
    const TILE_SIZE = 40;
    const GAME_MAP = [
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1], [1, 0, 0, 0, 0, 0, 0, 0, 0, 1], [1, 0, 1, 1, 0, 1, 1, 0, 0, 1],
        [1, 0, 1, 0, 0, 0, 1, 0, 0, 1], [1, 0, 0, 0, 1, 1, 1, 0, 0, 1], [1, 0, 0, 0, 0, 0, 0, 0, 0, 1],
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1]
    ];
    canvas.width = GAME_MAP[0].length * TILE_SIZE;
    canvas.height = GAME_MAP.length * TILE_SIZE;

    function drawMap() {
        ctx.fillStyle = '#000080';
        for (let y = 0; y < GAME_MAP.length; y++) {
            for (let x = 0; x < GAME_MAP[y].length; x++) {
                if (GAME_MAP[y][x] === 1) {
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
            }
        }
    }

    function drawPacman() {
        ctx.beginPath();
        ctx.arc(pacman.x, pacman.y, pacman.radius, 0.2 * Math.PI, 1.8 * Math.PI);
        ctx.lineTo(pacman.x, pacman.y);
        ctx.closePath();
        ctx.fillStyle = pacman.color;
        ctx.fill();
    }
    
    function updateScore(points) {
        gameScore += points;
        scoreDisplay.textContent = `Score: ${gameScore}`;
    }

    function isWall(px, py) {
         const tx = Math.floor(px / TILE_SIZE);
         const ty = Math.floor(py / TILE_SIZE);
         return ty >= 0 && ty < GAME_MAP.length && tx >= 0 && tx < GAME_MAP[0].length && GAME_MAP[ty][tx] === 1;
    }
    
    function isCollidingWithWall(x, y) {
        const checks = [
            isWall(x - pacman.radius, y - pacman.radius), isWall(x + pacman.radius, y - pacman.radius),
            isWall(x - pacman.radius, y + pacman.radius), isWall(x + pacman.radius, y + pacman.radius)
        ];
        return checks.some(c => c);
    }

    function movePacman() {
        const nextX = pacman.x + pacman.dx;
        const nextY = pacman.y + pacman.dy;

        if (!isCollidingWithWall(nextX, nextY)) {
            pacman.x = nextX;
            pacman.y = nextY;
        } else {
            pacman.dx = 0;
            pacman.dy = 0;
        }
        if ((pacman.dx !== 0 || pacman.dy !== 0) && Math.floor(Date.now() / 20) % 20 === 0) {
             updateScore(1);
        }
    }

    function gameLoop() {
        if (!gameRunning) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawMap();
        movePacman();
        drawPacman();
        
        if (gameScore >= 100) {
            gameOver();
            return;
        }

        requestAnimationFrame(gameLoop);
    }
    
    function resetGame() {
        gameScore = 0;
        scoreDisplay.textContent = 'Score: 0';
        pacman = { x: 50, y: 50, radius: 10, color: 'yellow', dx: 0, dy: 0, speed: 5 };
        document.getElementById('txOverlay').classList.add('hidden');
        document.getElementById('gameOverOverlay').classList.add('hidden');
        startBtn.textContent = 'START GAME (Bayar 0.01 SOMI)';
        startBtn.disabled = false;
        drawMap();
        drawPacman();
    }
    
    function updateHeaderDisplay() {
        // Tampilkan Nama dan Wallet Address
        playerDisplay.innerHTML = `
            Player: ${playerProfile.displayName || 'Loading...'} <br>
            Wallet: <span style="font-size: 0.8em; color: #c77dff;">${formatWallet(playerProfile.walletAddress)}</span>
        `;
    }

    function showStartScreen() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawMap();
        drawPacman();
        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#ff8c00';
        ctx.font = '24px Inter';
        ctx.textAlign = 'center';
        
        let message = 'Menghubungkan ke Database...';
        let canStart = false;

        if (db === null) {
            message = 'ERROR KRITIS: Koneksi Database GAGAL.';
        } else if (!profileLoaded) {
            message = 'Memuat Profil Pemain dari Firestore...';
        } else if (!playerProfile.walletAddress || !playerProfile.displayName) {
             message = 'Profil TIDAK Lengkap. Harap hubungkan Wallet & Isi Nama di Menu Utama.';
        } else {
             message = 'Click START untuk Bayar dan Main!';
             canStart = true;
        }
        
        ctx.fillText(message, canvas.width / 2, canvas.height / 2);
        startBtn.disabled = !canStart;
        if (!canStart && db !== null && profileLoaded) {
            startBtn.textContent = 'Kembali ke Menu (Profil Belum Lengkap)';
            startBtn.onclick = () => window.location.href='index.html';
        }
    }
    
    // ====================================================================
    // --- WEB3 TRANSACTION LOGIC (PAY-TO-PLAY) ---
    // ====================================================================
    
    const TARGET_ADDRESS = '0x5ac99e984638792e33959A1d258aC00bA8810D32'; 
    const PAYMENT_AMOUNT_ETH = '0.0001'; 

    async function startTransactionAndGame() {
        if (!playerProfile.walletAddress) { return; }
        
        startBtn.disabled = true;
        document.getElementById('txOverlay').classList.remove('hidden');
        document.getElementById('txStatusTitle').textContent = "Memproses Transaksi...";
        document.getElementById('txStatusMessage').textContent = `Mengirim ${PAYMENT_AMOUNT_ETH} SOMI (sebagai ETH di simulasi) ke ${formatWallet(TARGET_ADDRESS)}...`;

        try {
            const provider = new ethers.BrowserProvider(window.ethereum);
            const signer = await provider.getSigner();
            
            const tx = {
                to: TARGET_ADDRESS,
                value: ethers.parseEther(PAYMENT_AMOUNT_ETH)
            };

            const txResponse = await signer.sendTransaction(tx);
            
            document.getElementById('txStatusTitle').textContent = "Transaksi Dikirim";
            document.getElementById('txStatusMessage').textContent = `Menunggu konfirmasi blok... Hash: ${txResponse.hash.substring(0, 10)}...`;

            await txResponse.wait(); 

            document.getElementById('txStatusTitle').textContent = "TRANSAKSI BERHASIL!";
            document.getElementById('txStatusMessage').textContent = "Pembayaran dikonfirmasi. Selamat bermain!";
            
            setTimeout(() => {
                document.getElementById('txOverlay').classList.add('hidden');
                gameRunning = true;
                gameLoop();
            }, 1000);

        } catch (error) {
            console.error("Transaksi GAGAL:", error);
            document.getElementById('txStatusTitle').textContent = "Transaksi Gagal";
            document.getElementById('txStatusMessage').textContent = "Transaksi dibatalkan atau terjadi kegagalan jaringan.";
            document.getElementById('closeTxOverlay').classList.remove('hidden');
            startBtn.disabled = false;
        }
    }
    
    // ====================================================================
    // --- GAME OVER & SCORE SUBMISSION (Hanya Wallet) ---
    // ====================================================================
    
    // Fungsi Penyimpanan Skor GLOBAL (TIDAK ADA FALLBACK)
    async function saveScoreToLeaderboard(score) {
        const saveStatusEl = document.getElementById('saveStatusMessage');
        
        // Cek kritis: Harus memiliki DB dan Wallet Address
        if (!db || !playerProfile.walletAddress || !playerProfile.displayName || !appId) {
            saveStatusEl.style.color = 'red';
            saveStatusEl.textContent = "CRITICAL: Database Global TIDAK SIAP (Wallet/Nama Hilang). Skor TIDAK tersimpan.";
            console.error("Skor tidak tersimpan: DB/Profile tidak lengkap.", { dbStatus: db !== null, wallet: playerProfile.walletAddress, name: playerProfile.displayName });
            return;
        }

        const scoreData = {
            // Gunakan Wallet Address sebagai identitas publik utama
            walletAddress: playerProfile.walletAddress, 
            displayName: playerProfile.displayName,
            score: score,
            timestamp: new Date().toISOString()
            // userId dihilangkan dari data publik
        };

        try {
            const leaderboardRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            await addDoc(leaderboardRef, scoreData);
            
            saveStatusEl.style.color = '#2ecc71';
            saveStatusEl.textContent = "Skor berhasil disimpan ke Leaderboard Global!";
            
        } catch (e) {
            console.error("Gagal menyimpan skor ke Firestore (Kritis):", e);
            saveStatusEl.style.color = 'red';
            saveStatusEl.textContent = "CRITICAL: Gagal menyimpan skor ke Database Global. Skor hilang.";
        }
    }

    async function gameOver() {
        gameRunning = false;
        
        document.getElementById('finalScore').textContent = gameScore;
        document.getElementById('gameOverOverlay').classList.remove('hidden');
        
        // Kirim skor langsung ke Firestore
        await saveScoreToLeaderboard(gameScore);
        
        document.getElementById('playAgainBtn').onclick = () => {
             document.getElementById('gameOverOverlay').classList.add('hidden');
             resetGame(); 
             showStartScreen();
        };
    }
    
    // ====================================================================
    // --- EVENT LISTENERS & INIT ---
    // ====================================================================

    function setupEventListeners() {
        startBtn.addEventListener('click', startTransactionAndGame);
        
        // Kontrol Keyboard
        document.addEventListener('keydown', (e) => {
            if (!gameRunning) return;
            switch(e.key) {
                case 'ArrowUp': pacman.dx = 0; pacman.dy = -pacman.speed; break;
                case 'ArrowDown': pacman.dx = 0; pacman.dy = pacman.speed; break;
                case 'ArrowLeft': pacman.dx = -pacman.speed; pacman.dy = 0; break;
                case 'ArrowRight': pacman.dx = pacman.speed; pacman.dy = 0; break;
            }
        });
        
        // Kontrol Mobile/Touchpad
        document.getElementById('upBtn').addEventListener('touchstart', (e) => { e.preventDefault(); pacman.dx = 0; pacman.dy = -pacman.speed; });
        document.getElementById('downBtn').addEventListener('touchstart', (e) => { e.preventDefault(); pacman.dx = 0; pacman.dy = pacman.speed; });
        document.getElementById('leftBtn').addEventListener('touchstart', (e) => { e.preventDefault(); pacman.dx = -pacman.speed; pacman.dy = 0; });
        document.getElementById('rightBtn').addEventListener('touchstart', (e) => { e.preventDefault(); pacman.dx = pacman.speed; pacman.dy = 0; });

        document.querySelectorAll('.control-btn').forEach(btn => {
            btn.addEventListener('touchend', (e) => { e.preventDefault(); pacman.dx = 0; pacman.dy = 0; });
        });
    }

    function closeOverlay(id) {
         document.getElementById(id).classList.add('hidden');
    }
    
    window.onload = async function () {
        await initializeFirebase();
        setupEventListeners();
        resetGame();
        updateHeaderDisplay();
        showStartScreen();
    }
</script>

</body>
</html>

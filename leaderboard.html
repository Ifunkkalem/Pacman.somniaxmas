<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Somnia Leaderboard</title>
<script src="libs/ethers.min.js"></script>

<style>
body{
  margin:0;
  padding:10px;
  font-family:Trebuchet MS,sans-serif;
  background:#800000;
  color:white;
}
h2{
  color:#00ffae;
  text-align:center;
  margin-bottom:8px;
}
#status{
  text-align:center;
  font-size:13px;
  margin-bottom:10px;
}
table{
  width:100%;
  border-collapse:collapse;
  background:rgba(0,0,0,0.35);
  border-radius:8px;
  overflow:hidden;
}
th,td{
  padding:10px;
  border-bottom:1px solid rgba(255,255,255,0.15);
}
th{
  background:rgba(0,0,0,0.4);
  color:#ffcc00;
}
td.score{
  text-align:right;
  font-weight:bold;
}
</style>
</head>

<body>

<h2>üèÜ SOMNIA LEADERBOARD</h2>
<div id="status">‚è≥ Connecting‚Ä¶</div>

<table>
<thead>
<tr>
  <th>#</th>
  <th>Wallet</th>
  <th>Score</th>
</tr>
</thead>
<tbody id="leaderboardBody">
<tr><td colspan="3" style="text-align:center">Loading‚Ä¶</td></tr>
</tbody>
</table>

<script>
/* ================= CONFIG ================= */
const CONTRACT_ADDRESS = "0x35a7f3eE9A2b5fdEE717099F9253Ae90e1248AE3";
const RPC_URL = "https://somnia-rpc.publicnode.com";

const ABI = [
  "function getTop10() view returns (address[] players, uint256[] scores)",
  "function jackpotBalance() view returns (uint256)",
  "function topScore() view returns (uint256)"
];

/* ================= INIT ================= */
async function init(){
  try{
    const provider = new ethers.providers.JsonRpcProvider(RPC_URL);
    const net = await provider.getNetwork();
    document.getElementById('status').textContent =
      `‚úÖ Connected to Somnia (Chain ${net.chainId})`;

    const contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, provider);

    await loadSummary(contract);
    await loadLeaderboard(contract);

  }catch(e){
    console.error(e);
    document.getElementById('status').textContent = '‚ùå Blockchain error';
  }
}

/* ================= SUMMARY (JACKPOT + TOP) ================= */
async function loadSummary(contract){
  try{
    const jackpotWei = await contract.jackpotBalance();
    const top = await contract.topScore();

    const jackpot = ethers.utils.formatEther(jackpotWei);
    const topScore = top.toString();

    // üî• INI YANG FIX
    window.parent.postMessage({
      type: 'updateSummary',
      jackpot: Number(jackpot).toFixed(4),
      topScore: topScore
    }, '*');

  }catch(e){
    console.warn('Summary error', e);
  }
}

/* ================= LEADERBOARD ================= */
async function loadLeaderboard(contract){
  const tbody = document.getElementById('leaderboardBody');

  try{
    const [players, scores] = await contract.getTop10();

    if(!players.length){
      tbody.innerHTML =
        `<tr><td colspan="3" style="text-align:center">No scores yet</td></tr>`;
      return;
    }

    // üîí 1 WALLET = 1 SKOR TERTINGGI
    const best = {};
    players.forEach((addr,i)=>{
      const s = Number(scores[i]);
      if(!best[addr] || s > best[addr]) best[addr] = s;
    });

    const final = Object.entries(best)
      .map(([a,s])=>({address:a,score:s}))
      .sort((a,b)=>b.score-a.score)
      .slice(0,10);

    tbody.innerHTML = '';

    final.forEach((row,i)=>{
      const short = row.address.slice(0,6)+'‚Ä¶'+row.address.slice(-4);
      tbody.innerHTML += `
        <tr>
          <td>${i+1}</td>
          <td>${short}</td>
          <td class="score">${row.score}</td>
        </tr>`;
    });

  }catch(e){
    console.error(e);
    tbody.innerHTML =
      `<tr><td colspan="3" style="text-align:center">Failed to load</td></tr>`;
  }
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>

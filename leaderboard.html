<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Somnia Leaderboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>

<style>
/* Pastikan CSS ini ada dan sesuai dengan desain Anda */
body {
    background: #cc0000; /* Warna Merah Natal */
    color: #fff;
    font-family: Arial, Helvetica, sans-serif;
    margin: 0;
    padding: 20px;
    box-sizing: border-box;
}
#leaderboard {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}
#leaderboard th, #leaderboard td {
    border: 1px solid #ffaa00;
    padding: 10px;
    text-align: left;
}
#leaderboard th {
    background: #a30000;
    color: #ffd700;
}
.status-message {
    padding: 10px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 5px;
    margin-bottom: 15px;
}
.header-trophy {
    font-size: 24px;
    color: #ffd700;
    margin-right: 10px;
}
h2 {
    display: flex;
    align-items: center;
    justify-content: center;
    color: #ffd700;
    text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
}
</style>
</head>
<body>

    <h2><span class="header-trophy">üèÜ</span> SOMNIA LEADERBOARD</h2>
    <div id="statusMessage" class="status-message">Loading leaderboard data...</div>

    <table id="leaderboard">
        <thead>
            <tr>
                <th>#</th>
                <th>Wallet Address</th>
                <th>Score</th>
            </tr>
        </thead>
        <tbody id="leaderboardBody">
            </tbody>
    </table>

<script>
    // Konfigurasi harus sama dengan di app.js
    const CONTRACT_ADDRESS = "0x35a7f3eE9A2b5fdEE717099F9253Ae90e1248AE3";
    
    // üõë LANGKAH 2: ABI KONTRAK LENGKAP UNTUK FETCHING
    const CONTRACT_ABI = [
        "function getTopScores() view returns (tuple(address player, uint256 score)[] memory)",
        "function jackpotBalance() view returns (uint256)", // Untuk Jackpot
        "function topScore() view returns (uint256)" // Untuk Top Score
    ];

    const SOMNIA_RPC_URL = 'https://somnia-rpc.publicnode.com'; 
    
    const $ = (id) => document.getElementById(id);
    const leaderboardBody = $('leaderboardBody');
    const statusMessage = $('statusMessage');

    async function fetchLeaderboardData() {
        if (!window.ethers) {
            statusMessage.textContent = "Error: Ethers library not found. Please check network script loading.";
            return;
        }

        try {
            const provider = new ethers.providers.JsonRpcProvider(SOMNIA_RPC_URL);
            const readContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);

            statusMessage.textContent = "Terhubung ke Blockchain: Chain ID 5031";

            // 1. Fetch Data Global (Jackpot & Top Score)
            const jackpotWei = await readContract.jackpotBalance(); 
            const currentTopScore = await readContract.topScore(); 

            const jackpotSomi = ethers.utils.formatEther(jackpotWei);
            const topScoreValue = currentTopScore.toString();

            // üõë LANGKAH 3: KIRIM DATA JACKPOT/TOP SCORE KE PARENT (app.js)
            // Ini yang memperbaiki header Jackpot/Top Score yang nol (Gambar 1000411787.jpg)
            window.parent.postMessage({ 
                type: "leaderboardData", 
                jackpot: jackpotSomi, 
                topScore: topScoreValue 
            }, "*");
            
            // 2. Fetch Data Leaderboard (Top Players)
            const topScores = await readContract.getTopScores();

            // 3. Render Leaderboard Body
            leaderboardBody.innerHTML = ''; 
            topScores.forEach((entry, index) => {
                const row = leaderboardBody.insertRow();
                row.insertCell().textContent = index + 1;
                // Menampilkan 4 karakter awal dan 4 karakter akhir address
                row.insertCell().textContent = entry.player.substring(0, 6) + '...' + entry.player.slice(-4); 
                row.insertCell().textContent = entry.score.toString(); 
            });

            if (topScores.length === 0) {
                 leaderboardBody.innerHTML = '<tr><td colspan="3">Belum ada data skor.</td></tr>';
            }
            
            // Sembunyikan pesan status setelah sukses 
            statusMessage.style.display = 'none'; 

        } catch (error) {
            console.error("Gagal mengambil data Leaderboard:", error);
            statusMessage.textContent = `‚ö†Ô∏è Terjadi kesalahan saat mengambil atau memproses data skor. Error: ${error.message}.`;
            // Kirim data default ke parent jika terjadi error agar header tidak error
            window.parent.postMessage({ 
                type: "leaderboardData", 
                jackpot: "0.000000", 
                topScore: "0" 
            }, "*");
        }
    }

    document.addEventListener("DOMContentLoaded", fetchLeaderboardData);
</script>
</body>
</html>


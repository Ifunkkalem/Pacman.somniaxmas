<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Somnia Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900;800;300&display=swap');
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body {
      background: radial-gradient(circle at top, #2b0033, #0a0010);
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px 10px;
    }
    h1 { font-size: clamp(28px, 6vw, 40px); color: #c77dff; text-shadow: 0 0 10px #800080; margin-bottom: 5px; }
    h2 { font-size: clamp(16px, 3vw, 20px); color: #ff8c00; margin-bottom: 20px; text-align: center; }
    .leaderboard-container {
      width: 100%; max-width: 800px;
      background: rgba(20, 0, 30, 0.8);
      border: 2px solid #ff8c00;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 0 15px #800080;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    th { background-color: rgba(255, 140, 0, 0.2); color: #ff8c00; text-transform: uppercase; font-size: 0.8em; }
    td { font-weight: bold; }
    .rank-1 { color: gold; font-size: 1.1em; }
    .rank-2 { color: silver; }
    .rank-3 { color: #cd7f32; }
    .wallet-cell { font-size: 0.7em; word-break: break-all; }
    .db-status {
      text-align: center;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 8px;
      font-weight: bold;
      background-color: rgba(46, 204, 113, 0.2);
      color: #2ecc71;
    }
    .action-button {
      width: 100%;
      padding: 12px;
      margin-top: 20px;
      font-size: 1em;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      background: linear-gradient(90deg, #c0392b, #e74c3c);
      color: white;
      transition: 0.2s;
    }
    .action-button:hover { box-shadow: 0 0 10px #e74c3c; transform: scale(1.01); }
  </style>
</head>
<body>

<div class="leaderboard-container">
    <h1>SOMNIA LEADERBOARD</h1>
    <h2>Total Skor Akumulatif (Lifetime Points)</h2>
    
    <div id="globalStatus" class="db-status">Memuat Status Database...</div>

    <table>
        <thead>
            <tr>
                <th>Peringkat</th>
                <th>Nama Pemain</th>
                <th>Total Skor Akumulatif</th>
                <th>Alamat Wallet (Identitas Publik)</th>
            </tr>
        </thead>
        <tbody id="leaderboardBody">
            <tr><td colspan="4" style="text-align: center;">Memuat data skor...</td></tr>
        </tbody>
    </table>

    <button class="action-button" onclick="window.location.href='menu.html'">KEMBALI KE MENU</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // -----------------------
  // Firebase Config
  // -----------------------
  const firebaseConfig = {
    apiKey: "AIzaSyBeHjlHJSB5R0mYJmX6h5uJ7Iwqu7zNWtA",
    authDomain: "somnia-hallowen.firebaseapp.com",
    projectId: "somnia-hallowen",
    storageBucket: "somnia-hallowen.firebasestorage.app",
    messagingSenderId: "441297353260",
    appId: "1:441297353260:web:71343e500055d10c712f89"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const leaderboardBody = document.getElementById('leaderboardBody');
  const globalStatusEl = document.getElementById('globalStatus');

  async function loadLeaderboard() {
    globalStatusEl.textContent = "Mengambil semua entri skor dari Database...";
    let allScores = [];

    try {
      const leaderboardRef = collection(db, 'users');
      const snapshot = await getDocs(leaderboardRef);

      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.wallet && data.displayName && data.score !== undefined) {
          allScores.push({
            walletAddress: data.wallet,
            displayName: data.displayName,
            totalScore: data.score
          });
        }
      });

      if (allScores.length === 0) {
        leaderboardBody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: #ff8c00;">Belum ada skor yang tersimpan.</td></tr>`;
        globalStatusEl.textContent = "Database kosong.";
        return;
      }

      // Urutkan berdasarkan totalScore desc
      allScores.sort((a,b) => b.totalScore - a.totalScore);
      renderLeaderboard(allScores);

    } catch (e) {
      console.error("Gagal memuat leaderboard:", e);
      globalStatusEl.textContent = "âš  ERROR! Gagal memuat data leaderboard.";
      globalStatusEl.style.backgroundColor = 'rgba(255,0,0,0.2)';
      leaderboardBody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: red;">Gagal memuat data skor.</td></tr>`;
    }
  }

  function renderLeaderboard(data) {
    leaderboardBody.innerHTML = '';
    const topPlayers = data.slice(0, 10);

    topPlayers.forEach((player, index) => {
      const rank = index + 1;
      const rankClass = rank <= 3 ? `rank-${rank}` : '';
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="${rankClass}">${rank}</td>
        <td class="${rankClass}">${player.displayName}</td>
        <td class="${rankClass}">${player.totalScore.toLocaleString()}</td>
        <td class="wallet-cell">${player.walletAddress}</td>
      `;
      leaderboardBody.appendChild(row);
    });

    globalStatusEl.textContent = `Leaderboard Global Aktif! Total Pemain: ${data.length}`;
  }

  loadLeaderboard();
</script>

</body>
</html>
